<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MySQL-进阶 | 蓝桉`Blog</title><meta name="author" content="蓝桉,kt_zxh@163.com"><meta name="copyright" content="蓝桉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. MySQL 的视图1.1. 简述视图（view）是一个虚拟表，非真实存在，其本质是根据 SQL 语句获取动态的数据集，并为其命名，用户使用时只需使用视图名称即可获取结果集，并可以将其当作表来使用。 数据库中只存放了视图的定义，而并没有存放视图中的数据（即只保存了查询的 SQL 逻辑，不保存查询结果）。这些数据存放在原来的表中。 使用视图查询数据时，数据库系统会从原来的表中取出对应的数据。因此">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL-进阶">
<meta property="og:url" content="https://ktzxy.github.io/posts/884c668c.html">
<meta property="og:site_name" content="蓝桉&#96;Blog">
<meta property="og:description" content="1. MySQL 的视图1.1. 简述视图（view）是一个虚拟表，非真实存在，其本质是根据 SQL 语句获取动态的数据集，并为其命名，用户使用时只需使用视图名称即可获取结果集，并可以将其当作表来使用。 数据库中只存放了视图的定义，而并没有存放视图中的数据（即只保存了查询的 SQL 逻辑，不保存查询结果）。这些数据存放在原来的表中。 使用视图查询数据时，数据库系统会从原来的表中取出对应的数据。因此">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ktzxy.github.io/bg/Image00015.webp">
<meta property="article:published_time" content="2025-07-09T17:28:46.000Z">
<meta property="article:modified_time" content="2025-07-13T15:45:18.452Z">
<meta property="article:author" content="蓝桉">
<meta property="article:tag" content="数据库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ktzxy.github.io/bg/Image00015.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MySQL-进阶",
  "url": "https://ktzxy.github.io/posts/884c668c.html",
  "image": "https://ktzxy.github.io/bg/Image00015.webp",
  "datePublished": "2025-07-09T17:28:46.000Z",
  "dateModified": "2025-07-13T15:45:18.452Z",
  "author": [
    {
      "@type": "Person",
      "name": "蓝桉",
      "url": "https://ktzxy.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ktzxy.github.io/posts/884c668c.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL-进阶',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4379924_273fk05h86zi.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/progress_bar/progress_bar.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/windmill/windmill.css"><link rel="stylesheet" href="/css/cat.css"><link rel="stylesheet" href="/css/meting/music_lanan.css"><div id="myscoll"></div><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="/css/runtime/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="蓝桉`Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/bg.webp);"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">264</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-zhuye-"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhuye-"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-shijianzhou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijianzhou"></use></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/essay/"><i class="fa-fw icon-xiaoxi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiaoxi"></use></svg><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/"><i class="fa-fw icon-music"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/fcircle/"><i class="fa-fw icon-pengyouquan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan"></use></svg><span> 朋友圈</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:randomPost();"><i class="fa-fw icon-wodezhuifan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wodezhuifan"></use></svg><span> 随机访问</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-guanyuwomen2"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyuwomen2"></use></svg><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/bg/Image00015.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">蓝桉`Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">MySQL-进阶</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-zhuye-"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhuye-"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-shijianzhou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijianzhou"></use></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/essay/"><i class="fa-fw icon-xiaoxi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiaoxi"></use></svg><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/"><i class="fa-fw icon-music"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/fcircle/"><i class="fa-fw icon-pengyouquan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan"></use></svg><span> 朋友圈</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:randomPost();"><i class="fa-fw icon-wodezhuifan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wodezhuifan"></use></svg><span> 随机访问</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-guanyuwomen2"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyuwomen2"></use></svg><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">MySQL-进阶</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-13T15:45:18.452Z" title="更新于 2025-07-13 15:45:18">2025-07-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="1-MySQL-的视图"><a href="#1-MySQL-的视图" class="headerlink" title="1. MySQL 的视图"></a>1. MySQL 的视图</h2><h3 id="1-1-简述"><a href="#1-1-简述" class="headerlink" title="1.1. 简述"></a>1.1. 简述</h3><p>视图（view）是一个虚拟表，非真实存在，其本质是根据 SQL 语句获取动态的数据集，并为其命名，用户使用时只需使用视图名称即可获取结果集，并可以将其当作表来使用。</p>
<p>数据库中只存放了视图的定义，而并没有存放视图中的数据（即只保存了查询的 SQL 逻辑，不保存查询结果）。这些数据存放在原来的表中。</p>
<p>使用视图查询数据时，数据库系统会从原来的表中取出对应的数据。因此，视图中的数据是依赖于原来的表中的数据的。一旦表中的数据发生改变，显示在视图中的数据也会发生改变。</p>
<h3 id="1-2-视图的语法"><a href="#1-2-视图的语法" class="headerlink" title="1.2. 视图的语法"></a>1.2. 视图的语法</h3><h4 id="1-2-1-创建视图"><a href="#1-2-1-创建视图" class="headerlink" title="1.2.1. 创建视图"></a>1.2.1. 创建视图</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> [<span class="keyword">or</span> replace] [algorithm <span class="operator">=</span> &#123;undefined <span class="operator">|</span> <span class="keyword">merge</span> <span class="operator">|</span> temptable&#125;]</span><br><span class="line"><span class="keyword">view</span> view_name [(column_list)]</span><br><span class="line"><span class="keyword">as</span> select_statement</span><br><span class="line">[<span class="keyword">with</span> [<span class="keyword">cascaded</span> <span class="operator">|</span> <span class="keyword">local</span>] <span class="keyword">check</span> option]</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>algorithm</code>：可选项，表示视图选择的算法。</li>
<li><code>view_name</code>：表示要创建的视图名称。</li>
<li><code>column_list</code>：可选项，指定视图中各个属性的名词，默认情况下与 <code>SELECT</code> 语句中的查询的属性相同。</li>
<li><code>select_statement</code>：表示一个完整的查询语句，将查询记录导入视图中。</li>
<li><code>[with [cascaded | local] check option]</code>：可选项，表示更新视图时要保证在该视图的权限范围之内。</li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建视图测试相关的表与数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE </span><br><span class="line"><span class="keyword">VIEW</span> view_student_1</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"> <span class="keyword">SELECT</span>	id,`name` <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h4 id="1-2-2-查询视图"><a href="#1-2-2-查询视图" class="headerlink" title="1.2.2. 查询视图"></a>1.2.2. 查询视图</h4><ul>
<li>查看创建视图语句</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> 视图名称;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看视图数据。跟普通的查询语句一样，将视图的名称作为表名即可</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> 视图名称 ...;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过以下命令，查看当前数据库所有表和视图，表中会区分开真实的表与视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> <span class="keyword">FULL</span> TABLES;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_tempdb    <span class="operator">|</span> Table_type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+------------+</span></span><br><span class="line"><span class="operator">|</span> score               <span class="operator">|</span> BASE <span class="keyword">TABLE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student             <span class="operator">|</span> BASE <span class="keyword">TABLE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_course      <span class="operator">|</span> BASE <span class="keyword">TABLE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> view_student_1      <span class="operator">|</span> <span class="keyword">VIEW</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+------------+</span></span><br></pre></td></tr></table></figure>
<h4 id="1-2-3-修改视图"><a href="#1-2-3-修改视图" class="headerlink" title="1.2.3. 修改视图"></a>1.2.3. 修改视图</h4><p>修改视图是指修改数据库中已存在的表的定义。当基本表的某些字段发生改变时，可以通过修改视图来保持视图和基本表之间一致。MySQL中可以通过以下两种方式来修改视图。</p>
<ul>
<li>方式一：通过 <code>CREATE OR REPLACE VIEW</code> 语句</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> 视图名称[(列名列表)] </span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line">    <span class="keyword">SELECT</span> 语句 [ <span class="keyword">WITH</span> [ <span class="keyword">CASCADED</span> <span class="operator">|</span> <span class="keyword">LOCAL</span> ] <span class="keyword">CHECK</span> OPTION ]</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE </span><br><span class="line"><span class="keyword">VIEW</span> view_student_1</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">    <span class="keyword">SELECT</span> id,`name`,`<span class="keyword">no</span>` <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>方式二：通过 <code>ALTER VIEW</code> 语句</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">view</span> 视图名 <span class="keyword">as</span> <span class="keyword">select</span>语句;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> 视图名称[(列名列表)] </span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line">    <span class="keyword">SELECT</span> 语句 [ <span class="keyword">WITH</span> [ <span class="keyword">CASCADED</span> <span class="operator">|</span> <span class="keyword">LOCAL</span> ] <span class="keyword">CHECK</span> OPTION ]</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> view_student_1 </span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line">    <span class="keyword">SELECT</span> id,`name` <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h4 id="1-2-4-重命名视图"><a href="#1-2-4-重命名视图" class="headerlink" title="1.2.4. 重命名视图"></a>1.2.4. 重命名视图</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RENAME <span class="keyword">TABLE</span> 视图名 <span class="keyword">TO</span> 新视图名;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="keyword">table</span> view1_emp <span class="keyword">to</span> my_view1;</span><br></pre></td></tr></table></figure>
<h4 id="1-2-5-删除视图"><a href="#1-2-5-删除视图" class="headerlink" title="1.2.5. 删除视图"></a>1.2.5. 删除视图</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> [IF <span class="keyword">EXISTS</span>] 视图名称 [,视图名称] ...;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notes: <font color=red><strong>删除视图时，只能删除视图的定义，不会删除原表中的数据。</strong></font></p>
</blockquote>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> if <span class="keyword">exists</span> view_student_1;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-更新视图"><a href="#1-3-更新视图" class="headerlink" title="1.3. 更新视图"></a>1.3. 更新视图</h3><p>可以通过 <code>UPDATE</code>、<code>DELETE</code> 或 <code>INSERT</code> 等语句去操作某些视图，从而更新基表的内容。<font color=red><strong>对于可更新的视图，在视图中的行和基表中的行之间必须具有一对一的关系</strong></font>。如果视图包含下述结构中的任何一种，那么它就是不可更新的：</p>
<ul>
<li>聚合函数（SUM(), MIN(), MAX(), COUNT()等）</li>
<li>DISTINCT</li>
<li>GROUP BY</li>
<li>HAVING</li>
<li>UNION 或 UNION ALL</li>
<li>位于选择列表中的子查询</li>
<li>JOIN</li>
<li>FROM 子句中的不可更新视图</li>
<li>WHERE 子句中的子查询，引用 FROM 子句中的表。</li>
<li>仅引用文字值（在该情况下，没有要更新的基本表）</li>
</ul>
<blockquote>
<p>Notes: <font color=red><strong>视图中虽然可以更新数据，但是有很多的限制。一般情况下，最好将视图作为查询数据的虚拟表，而不要通过视图更新数据。因为，使用视图更新数据时，如果没有全面考虑在视图中更新数据的限制，就可能会造成数据更新失败。</strong></font></p>
</blockquote>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--  ---------更新视图-------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view1_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> ename,job <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> view1_emp <span class="keyword">set</span> ename <span class="operator">=</span> <span class="string">&#x27;周瑜&#x27;</span> <span class="keyword">where</span> ename <span class="operator">=</span> <span class="string">&#x27;鲁肃&#x27;</span>;  <span class="comment">-- 可以修改</span></span><br><span class="line"><span class="keyword">insert into</span> view1_emp <span class="keyword">values</span>(<span class="string">&#x27;孙权&#x27;</span>,<span class="string">&#x27;文员&#x27;</span>);  <span class="comment">-- 不可以插入</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------视图包含聚合函数不可更新--------------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view2_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) cnt <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> view2_emp <span class="keyword">values</span>(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">update</span> view2_emp <span class="keyword">set</span> cnt <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------视图包含distinct不可更新---------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view3_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> job <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> view3_emp <span class="keyword">values</span>(<span class="string">&#x27;财务&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------视图包含goup by 、having不可更新------------------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view4_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> deptno ,<span class="built_in">count</span>(<span class="operator">*</span>) cnt <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno <span class="keyword">having</span>  cnt <span class="operator">&gt;</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> view4_emp <span class="keyword">values</span>(<span class="number">30</span>,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------视图包含union或者union all不可更新----------------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view5_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> empno,ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">&lt;=</span> <span class="number">1005</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> empno,ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">&gt;</span> <span class="number">1005</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> view5_emp <span class="keyword">values</span>(<span class="number">1015</span>,<span class="string">&#x27;韦小宝&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------视图包含子查询不可更新--------------------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view6_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> empno,ename,sal <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="operator">=</span> (<span class="keyword">select</span> <span class="built_in">max</span>(sal) <span class="keyword">from</span> emp);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> view6_emp <span class="keyword">values</span>(<span class="number">1015</span>,<span class="string">&#x27;韦小宝&#x27;</span>,<span class="number">30000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------视图包含join不可更新-----------------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view7_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> dname,ename,sal <span class="keyword">from</span> emp a <span class="keyword">join</span>  dept b  <span class="keyword">on</span> a.deptno <span class="operator">=</span> b.deptno;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> view7_emp(dname,ename,sal) <span class="keyword">values</span>(<span class="string">&#x27;行政部&#x27;</span>,<span class="string">&#x27;韦小宝&#x27;</span>,<span class="number">30000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- --------------------视图包含常量文字值不可更新-------------------</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view8_emp</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;行政部&#x27;</span> dname,<span class="string">&#x27;杨过&#x27;</span>  ename;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> view8_emp <span class="keyword">values</span>(<span class="string">&#x27;行政部&#x27;</span>,<span class="string">&#x27;韦小宝&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>其实在定义视图时，可以通过视图的检查选项指定条件，然后在插入、修改、删除数据时，都必须满足条件才能操作。</p>
<h3 id="1-4-检查选项"><a href="#1-4-检查选项" class="headerlink" title="1.4. 检查选项"></a>1.4. 检查选项</h3><p>当使用 <code>WITH CHECK OPTION</code> 子句创建视图时，MySQL 会通过视图检查正在更改的每条行数据，例如：插入，更新，删除，以使其符合视图的定义。MySQL 允许基于另一个视图创建视图，它还会检查依赖视图中的规则以保持一致性。为了确定检查的范围，mysql 提供了两个选项：<code>CASCADED</code> 和 <code>LOCAL</code>，默认值为 <code>CASCADED</code></p>
<h4 id="1-4-1-CASCADED"><a href="#1-4-1-CASCADED" class="headerlink" title="1.4.1. CASCADED"></a>1.4.1. CASCADED</h4><p>级联操作。比如，v2视图是基于v1视图的，如果在v2视图创建的时候指定了检查选项为 <code>cascaded</code>，但是v1视图创建时未指定检查选项。则在执行检查时，不仅会检查v2，还会级联检查v2的关联视图v1。</p>
<p><img src="https://gitee.com/Bluetom/img2/raw/master/img20240905/202410251023026.png" alt=""></p>
<h4 id="1-4-2-LOCAL"><a href="#1-4-2-LOCAL" class="headerlink" title="1.4.2. LOCAL"></a>1.4.2. LOCAL</h4><p>本地操作：比如，v2视图是基于v1视图的，如果在v2视图创建的时候指定了检查选项为 <code>local</code>，但是v1视图创建时未指定检查选项。则在执行检查时，只会检查v2，不会检查v2的关联视图v1。</p>
<p><img src="https://gitee.com/Bluetom/img2/raw/master/img20240905/202410251023027.png" alt=""></p>
<h3 id="1-5-视图运用案例"><a href="#1-5-视图运用案例" class="headerlink" title="1.5. 视图运用案例"></a>1.5. 视图运用案例</h3><ol>
<li>为了保证数据库表的安全性，开发人员在操作 tb_user 表时，只能看到的用户的基本字段，屏蔽手机号和邮箱两个字段。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> tb_user_view <span class="keyword">as</span> <span class="keyword">select</span> id,`name`,profession,age,gender,`status`,createtime <span class="keyword">from</span> tb_user;</span><br><span class="line"><span class="comment">-- 查询</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_user_view;</span><br></pre></td></tr></table></figure>
<ol>
<li>查询每个学生所选修的课程（三张表联查），这个功能在很多的业务中都有使用到，为了简化操作，定义一个视图。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> tb_stu_course_view </span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line">	<span class="keyword">SELECT</span></span><br><span class="line">		s.NAME student_name,</span><br><span class="line">		s.NO student_no,</span><br><span class="line">		c.NAME course_name </span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">		student s,</span><br><span class="line">		student_course sc,</span><br><span class="line">		course c </span><br><span class="line">	<span class="keyword">WHERE</span></span><br><span class="line">		s.id <span class="operator">=</span> sc.studentid </span><br><span class="line">	<span class="keyword">AND</span> sc.courseid <span class="operator">=</span> c.id;</span><br><span class="line"><span class="comment">-- 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tb_stu_course_view;</span><br></pre></td></tr></table></figure>
<h3 id="1-6-视图总结"><a href="#1-6-视图总结" class="headerlink" title="1.6. 视图总结"></a>1.6. 视图总结</h3><h4 id="1-6-1-视图的优缺点"><a href="#1-6-1-视图的优缺点" class="headerlink" title="1.6.1. 视图的优缺点"></a>1.6.1. 视图的优缺点</h4><p>优点：</p>
<ul>
<li>简化代码：可以把重复使用的查询封装成视图重复使用，同时可以使复杂的查询易于理解和使用。不仅简化用户对数据的理解，也可以简化用户的操作。那些被经常使用的查询可以被定义为视图，从而使得用户不必为以后的操作每次指定全部的条件。</li>
<li>数据安全性：如果一张表中有很多数据，很多信息不希望让所有人看到，此时可以使用视图视，如：社会保险基金表，可以用视图只显示姓名，地址，而不显示社会保险号和工资数等，可以对不同的用户，设定不同的视图。</li>
<li>逻辑数据独立，兼容老的表结构：视图可帮助用户屏蔽真实表结构变化带来的影响</li>
</ul>
<p>缺点：</p>
<ul>
<li>性能差。数据库必须把视图的查询转化成对基本表的查询，如果这个视图是由一个复杂的多表查询所定义，那么，即使是视图的一个简单查询，数据库也把它变成一个复杂的结合体，需要花费一定的时间。</li>
<li>修改限制。当用户试图修改视图的某些行时，数据库必须把它转化为对基本表的某些行的修改。事实上，当从视图中插入或者删除时，情况也是这样。对于简单视图来说，这是很方便的；但是，对于比较复杂的视图，可能是不可修改的，特征如下：<ol>
<li>有 UNIQUE 等集合操作符的视图。</li>
<li>有 GROUP BY 子句的视图。</li>
<li>有诸如 AVG\SUM\MAX 等聚合函数的视图。</li>
<li>使用 DISTINCT 关键字的视图。</li>
<li>连接表的视图（其中有些例外）</li>
</ol>
</li>
</ul>
<h4 id="1-6-2-视图的特点"><a href="#1-6-2-视图的特点" class="headerlink" title="1.6.2. 视图的特点"></a>1.6.2. 视图的特点</h4><ul>
<li>视图的列可以来自不同的表，是表的抽象和在逻辑意义上建立的新关系。</li>
<li>视图是由基本表(实表)产生的表(虚表)。</li>
<li>视图的建立和删除不影响基本表。</li>
<li>对视图内容的更新(添加，删除和修改)直接影响基本表。</li>
<li>当视图来自多个基本表时，不允许添加和删除数据。</li>
</ul>
<h4 id="1-6-3-视图的使用场景"><a href="#1-6-3-视图的使用场景" class="headerlink" title="1.6.3. 视图的使用场景"></a>1.6.3. 视图的使用场景</h4><ul>
<li>重用SQL语句；</li>
<li>简化复杂的SQL操作。在编写查询后，可以方便的重用它而不必知道它的基本查询细节；</li>
<li>使用表的组成部分而不是整个表；</li>
<li>保护数据。可以给用户授予表的特定部分的访问权限而不是整个表的访问权限；</li>
<li>更改数据格式和表示。视图可返回与底层表的表示和格式不同的数据。</li>
</ul>
<h2 id="2-存储过程"><a href="#2-存储过程" class="headerlink" title="2. 存储过程"></a>2. 存储过程</h2><h3 id="2-1-简述"><a href="#2-1-简述" class="headerlink" title="2.1. 简述"></a>2.1. 简述</h3><p>MySQL 5.0 版本开始支持存储过程。存储过程是经过预编译并存储在数据库中的一段 SQL 语句的集合，功能强大，可以实现一些比较复杂的逻辑功能，类似于 JAVA 语言中的方法；调用存储过程可以简化应用开发<br>人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。</p>
<font color=red>**存储过程就是数据库 SQL 语言层面的代码封装与重用。**</font>

<p><strong>特性</strong>：</p>
<ul>
<li>函数的普遍特性：模块化，封装，代码复用。可以把某一业务SQL封装在存储过程中，需要用到的时候直接调用即可</li>
<li>存储过程可以输入输出参数，可以声明变量，有 if/else, case, while 等控制语句，通过编写存储过程，可以实现复杂的逻辑功能</li>
<li>速度快，只有首次执行需经过编译和优化步骤，后续被调用可以直接执行，省去以上步骤，减少网络交互，效率提升。如果涉及到多条SQL，每执行一次都是一次网络传输。而如果封装在存储过程中，只需要网络交互一次可能就可以了</li>
</ul>
<h3 id="2-2-存储过程基础语法"><a href="#2-2-存储过程基础语法" class="headerlink" title="2.2. 存储过程基础语法"></a>2.2. 存储过程基础语法</h3><h4 id="2-2-1-创建存储过程"><a href="#2-2-1-创建存储过程" class="headerlink" title="2.2.1. 创建存储过程"></a>2.2.1. 创建存储过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">delimiter 自定义结束符号</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> 储存名称([ <span class="keyword">in</span>, <span class="keyword">out</span>, <span class="keyword">inout</span> ] 参数名 数据类型...)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">sql</span>语句</span><br><span class="line"><span class="keyword">END</span> 自定义的结束符合</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc01()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">select</span> empno,ename <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">end</span>  $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">call</span> proc01();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notes: </p>
<ul>
<li><font color=red>**特别注意：在语法中，变量声明、游标声明、handler声明是必须按照先后顺序书写的，否则创建存储过程出错。**</font></li>
<li>在命令行中，执行创建存储过程的 SQL 时，需要通过关键字 <code>delimiter</code> 指定 SQL 语句的结束符。</li>
</ul>
</blockquote>
<h4 id="2-2-2-调用存储过程"><a href="#2-2-2-调用存储过程" class="headerlink" title="2.2.2. 调用存储过程"></a>2.2.2. 调用存储过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> 存储过程名称 ([ 参数 ]);</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">call</span> proc01();</span><br></pre></td></tr></table></figure>
<h4 id="2-2-3-查看存储过程"><a href="#2-2-3-查看存储过程" class="headerlink" title="2.2.3. 查看存储过程"></a>2.2.3. 查看存储过程</h4><ul>
<li>查询指定数据库的存储过程及状态信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.ROUTINES <span class="keyword">WHERE</span> ROUTINE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;数据库名称&#x27;</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>查询某个存储过程的定义</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> 存储过程名称;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-4-删除存储过程"><a href="#2-2-4-删除存储过程" class="headerlink" title="2.2.4. 删除存储过程"></a>2.2.4. 删除存储过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> [ IF <span class="keyword">EXISTS</span> ] 存储过程名称;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-变量"><a href="#2-3-变量" class="headerlink" title="2.3. 变量"></a>2.3. 变量</h3><p>在 MySQL 中变量分为三种类型：系统变量、用户定义变量、局部变量。</p>
<h4 id="2-3-1-系统变量"><a href="#2-3-1-系统变量" class="headerlink" title="2.3.1. 系统变量"></a>2.3.1. 系统变量</h4><p>系统变量是 MySQL 服务器提供，不是由用户定义的，属于服务器层面。分为以下两种变量：</p>
<ul>
<li>全局变量(GLOBAL)：全局变量针对于所有的会话</li>
<li>会话变量(SESSION)：会话变量针对于单个会话，在另外一个会话窗口就不生效了</li>
</ul>
<p><strong>查看系统变量</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看所有系统变量</span></span><br><span class="line"><span class="keyword">SHOW</span> [ SESSION <span class="operator">|</span> <span class="keyword">GLOBAL</span> ] VARIABLES;</span><br><span class="line"><span class="comment">-- 可以通过LIKE模糊匹配方式查找变量</span></span><br><span class="line"><span class="keyword">SHOW</span> [ SESSION <span class="operator">|</span> <span class="keyword">GLOBAL</span> ] VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;......&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看指定变量的值</span></span><br><span class="line"><span class="keyword">SELECT</span> @@[SESSION <span class="operator">|</span> <span class="keyword">GLOBAL</span>].系统变量名;</span><br></pre></td></tr></table></figure>
<p><strong>设置系统变量</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> [ SESSION <span class="operator">|</span> <span class="keyword">GLOBAL</span> ] 系统变量名 <span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">SET</span> @@[SESSION <span class="operator">|</span> <span class="keyword">GLOBAL</span>].系统变量名 <span class="operator">=</span> 值;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notes: 如果没有指定 SESSION/GLOBAL，默认是 SESSION，会话变量。mysql 服务重新启动之后，所设置的全局参数会失效，若永久配置则需要在 <code>/etc/my.cnf</code> 文件中配置</p>
</blockquote>
<h4 id="2-3-2-用户（会话）定义变量"><a href="#2-3-2-用户（会话）定义变量" class="headerlink" title="2.3.2. 用户（会话）定义变量"></a>2.3.2. 用户（会话）定义变量</h4><p>用户定义变量是用户自定义的变量，其作用域为当前连接（会话）。用户变量不用提前声明，使用时直接通过 <code>@变量名称</code> 声明即可。<em>类比java的成员变量</em>。</p>
<ul>
<li><strong>变量赋值方式1：通过 <code>SET</code> 关键字</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@var_name</span> <span class="operator">=</span> expr [, <span class="variable">@var_name</span> <span class="operator">=</span> expr] ... ;</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@var_name</span> :<span class="operator">=</span> expr [, <span class="variable">@var_name</span> :<span class="operator">=</span> expr] ... ;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notes: 赋值时，可以使用<code>=</code>，也可以使用<code>:=</code>。为了区分sql的运算符<code>=</code>，推荐使用<code>:=</code></p>
</blockquote>
<ul>
<li><strong>变量赋值方式2：通过 <code>SELECT</code> 关键字</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="variable">@var_name</span> :<span class="operator">=</span> expr [, <span class="variable">@var_name</span> :<span class="operator">=</span> expr] ... ;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>变量赋值方式3：通过 <code>INTO</code> 关键字查询表数据后赋值</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">INTO</span> <span class="variable">@var_name</span> <span class="keyword">FROM</span> 表名;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>变量的使用语法</strong>：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="variable">@var_name</span> [,<span class="variable">@var_name</span>] ...;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notes: 用户定义的变量时无需对其进行声明或初始化，此时获取变量的值为 NULL</p>
</blockquote>
<p>使用示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc04()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">set</span> <span class="variable">@var_name01</span> <span class="operator">=</span> <span class="string">&#x27;ZS&#x27;</span>; <span class="comment">-- 设置用户自定义会话变量</span></span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> proc04(); <span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">select</span> <span class="variable">@var_name01</span>; <span class="comment">-- 可以看到结果</span></span><br></pre></td></tr></table></figure>
<h4 id="2-3-3-局部变量"><a href="#2-3-3-局部变量" class="headerlink" title="2.3.3. 局部变量"></a>2.3.3. 局部变量</h4><p>局部变量是根据需要定义的在局部生效的变量，访问之前，需要 <code>DECLARE</code> 声明。可用作存储过程内的局部变量和输入参数，局部变量的范围是在其内声明的 <code>BEGIN ... END</code> 块。</p>
<h5 id="2-3-3-1-变量定义语法"><a href="#2-3-3-1-变量定义语法" class="headerlink" title="2.3.3.1. 变量定义语法"></a>2.3.3.1. 变量定义语法</h5><p>自定义局部变量，在 begin/end 块内有效。声明变量语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> var_name type [<span class="keyword">default</span> var_value];</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>var_name</code>：变量名称</li>
<li><code>type</code>：变量类型，即数据库字段类型：INT、BIGINT、CHAR、VARCHAR、DATE、TIME 等。</li>
<li><code>var_value</code>：指定默认值（非必须）</li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> nickname <span class="type">varchar</span>(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc02()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> var_name01 <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">default</span> <span class="string">&#x27;aaa&#x27;</span>;  <span class="comment">-- 定义局部变量</span></span><br><span class="line">    <span class="keyword">set</span> var_name01 <span class="operator">=</span> <span class="string">&#x27;MooN&#x27;</span>;</span><br><span class="line">    <span class="keyword">select</span> var_name01;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">call</span> proc02();</span><br></pre></td></tr></table></figure>
<h5 id="2-3-3-2-变量赋值语法"><a href="#2-3-3-2-变量赋值语法" class="headerlink" title="2.3.3.2. 变量赋值语法"></a>2.3.3.2. 变量赋值语法</h5><ul>
<li><strong>变量赋值方式1：通过 <code>SET</code> 关键字</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> 变量名 <span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">SET</span> 变量名 :<span class="operator">=</span> 值;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>变量赋值方式2：通过 <code>SELECT..INTO</code> 语句为变量赋值</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    col_name [...] <span class="keyword">into</span> var_name[,...]</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    table_name</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">condition</span>;</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>col_name</code> 参数表示查询的字段名称</li>
<li><code>var_name</code> 参数是变量的名称</li>
<li><code>table_name</code> 参数指表的名称</li>
<li><code>condition</code> 参数指查询条件</li>
</ul>
<blockquote>
<p>Notes: <font color=purple>注意：当将查询结果赋值给变量时，该查询语句的返回结果只能是单行单列！</font></p>
</blockquote>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc03()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> my_ename <span class="type">varchar</span>(<span class="number">20</span>) ;</span><br><span class="line">  <span class="keyword">select</span> ename <span class="keyword">into</span> my_ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">1001</span>;</span><br><span class="line">  <span class="keyword">select</span> my_ename;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">call</span> proc03();</span><br></pre></td></tr></table></figure>
<h3 id="2-4-存储过程的参数"><a href="#2-4-存储过程的参数" class="headerlink" title="2.4. 存储过程的参数"></a>2.4. 存储过程的参数</h3><p>存储过程参数的类型，主要分为以下三种：IN、OUT、INOUT。具体的含义如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>in</code></td>
<td>输入参数。该值传到存储过程的过程里面去，在存储过程中修改该参数的值不能被返回。不指定时默认</td>
</tr>
<tr>
<td><code>out</code></td>
<td>输出参数。该值可在存储过程内部被改变，并向外输出</td>
</tr>
<tr>
<td><code>inout</code></td>
<td>输入输出参数。既能作为输入的参数，也可以作为输出参数</td>
</tr>
</tbody>
</table>
</div>
<p>用法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> 存储过程名称 ([ <span class="keyword">IN</span><span class="operator">/</span><span class="keyword">OUT</span><span class="operator">/</span><span class="keyword">INOUT</span> 参数名 参数类型 ])</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- SQL语句</span></span><br><span class="line"><span class="keyword">END</span> ;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-1-in-类型参数"><a href="#2-4-1-in-类型参数" class="headerlink" title="2.4.1. in 类型参数"></a>2.4.1. in 类型参数</h4><p><code>in</code> 类型表示传入存储过程的参数，可以传入数值或者变量，即使传入变量，并不会更改变量的值，可以内部更改，仅仅作用在函数范围内。</p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 封装有参数的存储过程，传入员工编号，查找员工信息</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dec_param01(<span class="keyword">in</span> param_empno <span class="type">varchar</span>(<span class="number">20</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">=</span> param_empno;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> dec_param01(<span class="string">&#x27;1001&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 封装有参数的存储过程，可以通过传入部门名和薪资，查询指定部门，并且薪资大于指定值的员工信息</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dec_param0x(<span class="keyword">in</span> dname <span class="type">varchar</span>(<span class="number">50</span>), <span class="keyword">in</span> sal <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept a, emp b <span class="keyword">where</span> b.sal <span class="operator">&gt;</span> sal <span class="keyword">and</span> a.dname <span class="operator">=</span> dname;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> dec_param0x(<span class="string">&#x27;学工部&#x27;</span>,<span class="number">20000</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-4-2-out-类型参数"><a href="#2-4-2-out-类型参数" class="headerlink" title="2.4.2. out 类型参数"></a>2.4.2. out 类型参数</h4><p><code>out</code> 类型的参数表示从存储过程内部传值给调用者</p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ---------传出参数：out---------------------------------</span></span><br><span class="line">use mysql7_procedure;</span><br><span class="line"><span class="comment">-- 封装有参数的存储过程，传入员工编号，返回员工名字</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc08(<span class="keyword">in</span> empno <span class="type">int</span> , <span class="keyword">out</span> out_ename <span class="type">varchar</span>(<span class="number">50</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">select</span> ename <span class="keyword">into</span> out_ename <span class="keyword">from</span> emp <span class="keyword">where</span> emp.empno <span class="operator">=</span> empno;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc08(<span class="number">1001</span>, <span class="variable">@o_ename</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@o_ename</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 封装有参数的存储过程，传入员工编号，返回员工名字和薪资</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc09(<span class="keyword">in</span> empno <span class="type">int</span>, <span class="keyword">out</span> out_ename <span class="type">varchar</span>(<span class="number">50</span>), <span class="keyword">out</span> out_sal <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">select</span> ename,sal <span class="keyword">into</span> out_ename,out_sal <span class="keyword">from</span> emp <span class="keyword">where</span> emp.empno <span class="operator">=</span> empno;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc09(<span class="number">1001</span>, <span class="variable">@o_dname</span>,<span class="variable">@o_sal</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@o_dname</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@o_sal</span>;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-3-inout-类型参数"><a href="#2-4-3-inout-类型参数" class="headerlink" title="2.4.3. inout 类型参数"></a>2.4.3. inout 类型参数</h4><p><code>inout</code> 类型表示从外部传入的参数经过修改后可以返回的变量，既可以使用传入变量的值也可以修改变量的值（即使函数执行完）</p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 传入员工名，拼接部门号，传入薪资，求出年薪</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc10(<span class="keyword">inout</span> inout_ename <span class="type">varchar</span>(<span class="number">50</span>), <span class="keyword">inout</span> inout_sal <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">select</span>  concat(deptno,&quot;_&quot;,inout_ename) <span class="keyword">into</span> inout_ename <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="operator">=</span> inout_ename;</span><br><span class="line">  <span class="keyword">set</span> inout_sal <span class="operator">=</span> inout_sal <span class="operator">*</span> <span class="number">12</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@inout_ename</span> <span class="operator">=</span> <span class="string">&#x27;关羽&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@inout_sal</span> <span class="operator">=</span> <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc10(<span class="variable">@inout_ename</span>, <span class="variable">@inout_sal</span>) ;</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@inout_ename</span> ;</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@inout_sal</span> ;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-流程控制-if-条件判断"><a href="#2-5-流程控制-if-条件判断" class="headerlink" title="2.5. 流程控制 - if 条件判断"></a>2.5. 流程控制 - if 条件判断</h3><p><code>IF</code> 语句包含多个条件判断，根据结果为 <code>TRUE</code>、<code>FALSE</code> 执行语句，与编程语言中的<code>if</code>、<code>else if</code>、<code>else</code> 语法类似，其语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IF search_condition_1 <span class="keyword">THEN</span> statement_list_1</span><br><span class="line">    [ELSEIF search_condition_2 <span class="keyword">THEN</span> statement_list_2]</span><br><span class="line">    ...</span><br><span class="line">    [<span class="keyword">ELSE</span> statement_list_n]</span><br><span class="line"><span class="keyword">END</span> IF</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 判断存储流程输入</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc_12_if(<span class="keyword">in</span> score <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  if score <span class="operator">&lt;</span> <span class="number">60</span></span><br><span class="line">      <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">select</span> <span class="string">&#x27;不及格&#x27;</span>;</span><br><span class="line">    elseif  score <span class="operator">&lt;</span> <span class="number">80</span></span><br><span class="line">      <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">select</span> <span class="string">&#x27;及格&#x27;</span> ;</span><br><span class="line">    elseif score <span class="operator">&gt;=</span> <span class="number">80</span> <span class="keyword">and</span> score <span class="operator">&lt;</span> <span class="number">90</span></span><br><span class="line">       <span class="keyword">then</span></span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;良好&#x27;</span>;</span><br><span class="line">  elseif score <span class="operator">&gt;=</span> <span class="number">90</span> <span class="keyword">and</span> score <span class="operator">&lt;=</span> <span class="number">100</span></span><br><span class="line">       <span class="keyword">then</span></span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;优秀&#x27;</span>;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">       <span class="keyword">select</span> <span class="string">&#x27;成绩错误&#x27;</span>;</span><br><span class="line">  <span class="keyword">end</span> if;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">call</span> proc_12_if(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询数据</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc12_if(<span class="keyword">in</span> in_ename <span class="type">varchar</span>(<span class="number">50</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">declare</span> var_sal <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">select</span> sal <span class="keyword">into</span> var_sal <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="operator">=</span> in_ename;</span><br><span class="line">    if var_sal <span class="operator">&lt;</span> <span class="number">10000</span></span><br><span class="line">        <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> <span class="operator">=</span> <span class="string">&#x27;试用薪资&#x27;</span>;</span><br><span class="line">    elseif var_sal <span class="operator">&lt;</span> <span class="number">30000</span></span><br><span class="line">        <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> <span class="operator">=</span> <span class="string">&#x27;转正薪资&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">set</span> <span class="keyword">result</span> <span class="operator">=</span> <span class="string">&#x27;元老薪资&#x27;</span>;</span><br><span class="line">    <span class="keyword">end</span> if;</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">result</span>;</span><br><span class="line"><span class="keyword">end</span>$$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">call</span> proc12_if(<span class="string">&#x27;庞统&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="2-6-流程控制-case-条件判断"><a href="#2-6-流程控制-case-条件判断" class="headerlink" title="2.6. 流程控制 - case 条件判断"></a>2.6. 流程控制 - case 条件判断</h3><p><code>CASE</code> 是另一个条件判断的语句，类似于编程语言中的switch语法。语法结构如下：</p>
<ul>
<li>语法1：当 <code>case_value = when_value</code> 时，执行相应的 <code>statement_list</code> 逻辑</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> case_value</span><br><span class="line">    <span class="keyword">when</span> when_value <span class="keyword">then</span> statement_list</span><br><span class="line">    [<span class="keyword">when</span> when_value <span class="keyword">then</span> statement_list]</span><br><span class="line">    ...</span><br><span class="line">    [<span class="keyword">else</span> statement_list]</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span></span><br></pre></td></tr></table></figure>
<ul>
<li>语法2：当 <code>search_condition</code> 为 <code>true</code> 时，执行相应的 <code>statement_list</code> 逻辑</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span></span><br><span class="line">    <span class="keyword">when</span> search_condition <span class="keyword">then</span> statement_list</span><br><span class="line">    [<span class="keyword">when</span> search_condition <span class="keyword">then</span> statement_list]</span><br><span class="line">    ...</span><br><span class="line">    [<span class="keyword">else</span> statement_list]</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Tips: 如果判定条件有多个，多个条件之间，可以使用 and 或 or 进行连接。</p>
</blockquote>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 语法1</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc14_case(<span class="keyword">in</span> pay_type <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">case</span> pay_type</span><br><span class="line">      <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;微信支付&#x27;</span>;</span><br><span class="line">      <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;支付宝支付&#x27;</span>;</span><br><span class="line">      <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;银行卡支付&#x27;</span>;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">select</span> <span class="string">&#x27;其他方式支付&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> <span class="keyword">case</span> ;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">call</span> proc14_case(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">call</span> proc14_case(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 语法2</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc_15_case(<span class="keyword">in</span> score <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">case</span></span><br><span class="line">    <span class="keyword">when</span> score <span class="operator">&lt;</span> <span class="number">60</span> <span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;不及格&#x27;</span>;</span><br><span class="line">    <span class="keyword">when</span> score <span class="operator">&lt;</span> <span class="number">80</span> <span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;及格&#x27;</span>;</span><br><span class="line">    <span class="keyword">when</span> score <span class="operator">&gt;=</span> <span class="number">80</span> <span class="keyword">and</span> score <span class="operator">&lt;</span> <span class="number">90</span> <span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;良好&#x27;</span>;</span><br><span class="line">    <span class="keyword">when</span> score <span class="operator">&gt;=</span> <span class="number">90</span> <span class="keyword">and</span> score <span class="operator">&lt;=</span> <span class="number">100</span> <span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;优秀&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">select</span> <span class="string">&#x27;成绩错误&#x27;</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">call</span> proc_15_case(<span class="number">88</span>);</span><br></pre></td></tr></table></figure>
<h3 id="2-7-流程控制-循环"><a href="#2-7-流程控制-循环" class="headerlink" title="2.7. 流程控制 - 循环"></a>2.7. 流程控制 - 循环</h3><h4 id="2-7-1-简述"><a href="#2-7-1-简述" class="headerlink" title="2.7.1. 简述"></a>2.7.1. 简述</h4><ul>
<li>循环是一段在程序中只出现一次，但可能会连续运行多次的代码。</li>
<li>循环中的代码会运行特定的次数，或者是运行到特定条件成立时结束循环</li>
</ul>
<p><img src="https://gitee.com/Bluetom/img2/raw/master/img20240905/202410251023028.png" alt=""></p>
<p><strong>存储过程的循环分类</strong>：</p>
<ul>
<li>while</li>
<li>repeat</li>
<li>loop</li>
</ul>
<p><strong>循环控制（结束/跳过）</strong>：</p>
<ul>
<li><code>leave</code> 类似于java语言的 <code>break</code>，跳出，结束当前所在的循环</li>
<li><code>iterate</code> 类似于java语言的 <code>continue</code>，继续，结束本次循环，继续下一次</li>
</ul>
<h4 id="2-7-2-while-循环"><a href="#2-7-2-while-循环" class="headerlink" title="2.7.2. while 循环"></a>2.7.2. while 循环</h4><p>while 循环是有条件的循环控制语句。满足条件后，再执行循环体中的SQL语句。语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[标签名:]</span><br><span class="line">WHILE</span><br><span class="line">    循环条件</span><br><span class="line">DO</span><br><span class="line">    循环体;</span><br><span class="line"><span class="keyword">END</span> WHILE [标签名];</span><br></pre></td></tr></table></figure>
<p>注：以上标签名可以省略。标签名一般在<code>leave</code>结束与<code>iterate</code>跳过循环时使用</p>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------存储过程-while</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc16_while1(<span class="keyword">in</span> insertcount <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">    label:while i<span class="operator">&lt;=</span>insertcount do</span><br><span class="line">        <span class="keyword">insert into</span> <span class="keyword">user</span>(uid,username,`password`) <span class="keyword">values</span>(i,concat(<span class="string">&#x27;user-&#x27;</span>,i),<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line">        <span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> while label;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc16_while(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------存储过程-while + leave</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc16_while2(<span class="keyword">in</span> insertcount <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">    label:while i<span class="operator">&lt;=</span>insertcount do</span><br><span class="line">        <span class="keyword">insert into</span> <span class="keyword">user</span>(uid,username,`password`) <span class="keyword">values</span>(i,concat(<span class="string">&#x27;user-&#x27;</span>,i),<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line">        if i<span class="operator">=</span><span class="number">5</span> <span class="keyword">then</span> leave label;</span><br><span class="line">        <span class="keyword">end</span> if;</span><br><span class="line">        <span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> while label;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc16_while2(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------存储过程-while+iterate</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc16_while3(<span class="keyword">in</span> insertcount <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">    label:while i<span class="operator">&lt;=</span>insertcount do</span><br><span class="line">        <span class="keyword">set</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">        if i<span class="operator">=</span><span class="number">5</span> <span class="keyword">then</span> iterate label;</span><br><span class="line">        <span class="keyword">end</span> if;</span><br><span class="line">        <span class="keyword">insert into</span> <span class="keyword">user</span>(uid,username,`password`) <span class="keyword">values</span>(i,concat(<span class="string">&#x27;user-&#x27;</span>,i),<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span> while label;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> proc16_while3(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-7-3-repeat-循环"><a href="#2-7-3-repeat-循环" class="headerlink" title="2.7.3. repeat 循环"></a>2.7.3. repeat 循环</h4><p>repeat 是有条件的循环控制语句，当满足 until 声明的条件的时候，则退出循环。语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[标签名:]</span><br><span class="line">REPEAT</span><br><span class="line">    循环体;</span><br><span class="line">    UNTIL 条件表达式</span><br><span class="line"><span class="keyword">END</span> REPEAT [标签名];</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------存储过程-循环控制-repeat</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc18_repeat(<span class="keyword">in</span> insertCount <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">     <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">     label:repeat</span><br><span class="line">         <span class="keyword">insert into</span> <span class="keyword">user</span>(uid, username, password) <span class="keyword">values</span>(i,concat(<span class="string">&#x27;user-&#x27;</span>,i),<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line">         <span class="keyword">set</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">         until  i  <span class="operator">&gt;</span> insertCount</span><br><span class="line">     <span class="keyword">end</span> repeat label;</span><br><span class="line">     <span class="keyword">select</span> <span class="string">&#x27;循环结束&#x27;</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc18_repeat(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-7-4-loop-循环"><a href="#2-7-4-loop-循环" class="headerlink" title="2.7.4. loop 循环"></a>2.7.4. loop 循环</h4><p>LOOP 实现简单的循环，如果不在 SQL 逻辑中增加退出循环的条件，可以用其来实现简单的死循环。LOOP 可以配合以下两个语句使用：</p>
<ul>
<li>LEAVE ：配合循环使用，退出循环。</li>
<li>ITERATE：必须用在循环中，作用是跳过当前循环剩下的语句，直接进入下一次循环。</li>
</ul>
<p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[标签:]</span><br><span class="line">LOOP</span><br><span class="line">    循环体;</span><br><span class="line">	IF</span><br><span class="line">        条件表达式</span><br><span class="line">	<span class="keyword">THEN</span></span><br><span class="line">		LEAVE [标签];</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span> LOOP;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------存储过程-循环控制-loop</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc19_loop(<span class="keyword">in</span> insertCount <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">     <span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">     label:loop</span><br><span class="line">         <span class="keyword">insert into</span> <span class="keyword">user</span>(uid, username, password) <span class="keyword">values</span>(i,concat(<span class="string">&#x27;user-&#x27;</span>,i),<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line">         <span class="keyword">set</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">         if i <span class="operator">&gt;</span> <span class="number">5</span></span><br><span class="line">          <span class="keyword">then</span></span><br><span class="line">           leave label;</span><br><span class="line">         <span class="keyword">end</span> if;</span><br><span class="line">     <span class="keyword">end</span> loop label;</span><br><span class="line">     <span class="keyword">select</span> <span class="string">&#x27;循环结束&#x27;</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc19_loop(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>示例2：计算从1到n之间的偶数累加的值，n为传入的参数值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p10(<span class="keyword">in</span> n <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> total <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    sum:loop</span><br><span class="line">        if n<span class="operator">&lt;=</span><span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            leave sum;</span><br><span class="line">        <span class="keyword">end</span> if;</span><br><span class="line"></span><br><span class="line">        if n<span class="operator">%</span><span class="number">2</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">set</span> n :<span class="operator">=</span> n <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">            iterate sum;</span><br><span class="line">        <span class="keyword">end</span> if;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">set</span> total :<span class="operator">=</span> total <span class="operator">+</span> n;</span><br><span class="line">        <span class="keyword">set</span> n :<span class="operator">=</span> n <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> loop sum;</span><br><span class="line">    <span class="keyword">select</span> total;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> p10(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<h3 id="2-8-游标"><a href="#2-8-游标" class="headerlink" title="2.8. 游标"></a>2.8. 游标</h3><p>游标(cursor)是用来存储查询结果集的数据类型，在存储过程和函数中可以使用游标对结果集进行循环的处理，相当于指针，指向一行一行数据。游标的使用包括游标的声明、<code>OPEN</code>、<code>FETCH</code> 和 <code>CLOSE</code></p>
<h4 id="2-8-1-基础语法"><a href="#2-8-1-基础语法" class="headerlink" title="2.8.1. 基础语法"></a>2.8.1. 基础语法</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 声明语法</span></span><br><span class="line"><span class="keyword">declare</span> cursor_name <span class="keyword">cursor</span> <span class="keyword">for</span> select_statement</span><br><span class="line"><span class="comment">-- 打开语法</span></span><br><span class="line"><span class="keyword">open</span> cursor_name</span><br><span class="line"><span class="comment">-- 取值语法</span></span><br><span class="line"><span class="keyword">fetch</span> cursor_name <span class="keyword">into</span> var_name [, var_name] ...</span><br><span class="line"><span class="comment">-- 关闭语法</span></span><br><span class="line"><span class="keyword">close</span> cursor_name</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>cursor_name</code>：游标的名称</li>
<li><code>select_statement</code>：查询数据表返回的结果集</li>
<li><code>var_name</code>：游标循环结果集每一行数据时，赋值的变量</li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">use mysql7_procedure;</span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc20_cursor(<span class="keyword">in</span> in_dname <span class="type">varchar</span>(<span class="number">50</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"> <span class="comment">-- 定义局部变量</span></span><br><span class="line"> <span class="keyword">declare</span> var_empno <span class="type">varchar</span>(<span class="number">50</span>);</span><br><span class="line"> <span class="keyword">declare</span> var_ename <span class="type">varchar</span>(<span class="number">50</span>);</span><br><span class="line"> <span class="keyword">declare</span> var_sal  <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 声明游标</span></span><br><span class="line"> <span class="keyword">declare</span> my_cursor <span class="keyword">cursor</span> <span class="keyword">for</span></span><br><span class="line">  <span class="keyword">select</span> empno , ename, sal</span><br><span class="line">    <span class="keyword">from</span>  dept a ,emp b</span><br><span class="line">    <span class="keyword">where</span> a.deptno <span class="operator">=</span> b.deptno <span class="keyword">and</span> a.dname <span class="operator">=</span> in_dname;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 打开游标</span></span><br><span class="line">  <span class="keyword">open</span> my_cursor;</span><br><span class="line">  <span class="comment">-- 通过游标获取每一行数据</span></span><br><span class="line">  label:loop</span><br><span class="line">        <span class="keyword">fetch</span> my_cursor <span class="keyword">into</span> var_empno, var_ename, var_sal;</span><br><span class="line">        <span class="keyword">select</span> var_empno, var_ename, var_sal;</span><br><span class="line">    <span class="keyword">end</span> loop label;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 关闭游标</span></span><br><span class="line">    <span class="keyword">close</span> my_cursor;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">call</span> proc20_cursor(<span class="string">&#x27;销售部&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>示例2：游标的使用取每行记录(多字段)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">delimiter $</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">PROCEDURE</span> phoneDeal()</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span>  id <span class="type">varchar</span>(<span class="number">64</span>);   <span class="comment">-- id</span></span><br><span class="line">	<span class="keyword">DECLARE</span>  phone1  <span class="type">varchar</span>(<span class="number">16</span>); <span class="comment">-- phone</span></span><br><span class="line">	<span class="keyword">DECLARE</span>  password1  <span class="type">varchar</span>(<span class="number">32</span>); <span class="comment">-- 密码</span></span><br><span class="line">	<span class="keyword">DECLARE</span>  name1 <span class="type">varchar</span>(<span class="number">64</span>);   <span class="comment">-- id</span></span><br><span class="line">	<span class="comment">-- 遍历数据结束标志</span></span><br><span class="line">	<span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">	<span class="comment">-- 游标</span></span><br><span class="line">	<span class="keyword">DECLARE</span> cur_account <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">select</span> phone,password,name <span class="keyword">from</span> account_temp;</span><br><span class="line">	<span class="comment">-- 将结束标志绑定到游标</span></span><br><span class="line">	<span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done <span class="operator">=</span> <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">-- 打开游标</span></span><br><span class="line">	<span class="keyword">OPEN</span>  cur_account;</span><br><span class="line">	<span class="comment">-- 遍历</span></span><br><span class="line">	read_loop: LOOP</span><br><span class="line">		<span class="comment">-- 取值 取多个字段</span></span><br><span class="line">		<span class="keyword">FETCH</span>  NEXT <span class="keyword">from</span> cur_account <span class="keyword">INTO</span> phone1,password1,name1;</span><br><span class="line">			IF done <span class="keyword">THEN</span></span><br><span class="line">				LEAVE read_loop;</span><br><span class="line">			<span class="keyword">END</span> IF;</span><br><span class="line">		<span class="comment">-- 你自己想做的操作</span></span><br><span class="line">		<span class="keyword">insert into</span> account(id,phone,password,name) <span class="keyword">value</span>(UUID(),phone1,password1,CONCAT(name1,<span class="string">&#x27;的家长&#x27;</span>));</span><br><span class="line">	<span class="keyword">END</span> LOOP;</span><br><span class="line">	<span class="keyword">CLOSE</span> cur_account;</span><br><span class="line"><span class="keyword">END</span> $</span><br></pre></td></tr></table></figure>
<p><strong><em>注意：delimiter关键字后面必须有空格，否则在某些环境或某些情况下使用shell脚本调用执行会出现问题</em></strong></p>
<h3 id="2-9-异常处理-HANDLER-条件处理程序"><a href="#2-9-异常处理-HANDLER-条件处理程序" class="headerlink" title="2.9. 异常处理 - HANDLER 条件处理程序"></a>2.9. 异常处理 - HANDLER 条件处理程序</h3><p>条件处理程序（Handler）可以用来定义在流程控制结构执行过程中遇到问题时相应的处理步骤。具体语法为：</p>
<h4 id="2-9-1-语法定义"><a href="#2-9-1-语法定义" class="headerlink" title="2.9.1. 语法定义"></a>2.9.1. 语法定义</h4><p>MySql存储过程也提供了对异常处理的功能：通过定义 <code>HANDLER</code> 来完成异常声明的实现。</p>
<p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> handler_action HANDLER</span><br><span class="line">    <span class="keyword">FOR</span> condition_value [, condition_value] ...</span><br><span class="line">    statement</span><br><span class="line"></span><br><span class="line"><span class="comment">-- handler_action 取值</span></span><br><span class="line">handler_action: &#123;</span><br><span class="line">    CONTINUE <span class="comment">-- 继续执行剩余的代码</span></span><br><span class="line">  <span class="operator">|</span> EXIT     <span class="comment">-- 直接终止程序</span></span><br><span class="line">  <span class="operator">|</span> UNDO     <span class="comment">-- 不支持</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">-- condition_value 取值</span></span><br><span class="line">condition_value: &#123;</span><br><span class="line">    mysql_error_code</span><br><span class="line">  <span class="operator">|</span> <span class="keyword">SQLSTATE</span> [<span class="keyword">VALUE</span>] sqlstate_value</span><br><span class="line">  <span class="operator">|</span> condition_name</span><br><span class="line">  <span class="operator">|</span> <span class="keyword">SQLWARNING</span></span><br><span class="line">  <span class="operator">|</span> <span class="keyword">NOT</span> FOUND</span><br><span class="line">  <span class="operator">|</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>handler_action 条件处理程序的名称，取值：<ul>
<li>CONTINUE: 继续执行当前程序</li>
<li>EXIT: 终止执行当前程序</li>
</ul>
</li>
<li>condition_value 条件的取值：<ul>
<li>SQLSTATE sqlstate_value: 状态码，如 02000</li>
<li>SQLWARNING: 所有以01开头的SQLSTATE代码的简写</li>
<li>NOT FOUND: 所有以02开头的SQLSTATE代码的简写</li>
<li>SQLEXCEPTION: 所有没有被SQLWARNING 或 NOT FOUND捕获的SQLSTATE代码的简写</li>
</ul>
</li>
</ul>
<blockquote>
<p>具体的错误状态码，可以参考官方文档：</p>
<ul>
<li>5.7版本：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/declare-handler.html">https://dev.mysql.com/doc/refman/5.7/en/declare-handler.html</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/declare-handler.html">https://dev.mysql.com/doc/refman/8.0/en/declare-handler.html</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html">https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html</a></li>
</ul>
</blockquote>
<h4 id="2-9-2-存储过程中使用-handler"><a href="#2-9-2-存储过程中使用-handler" class="headerlink" title="2.9.2. 存储过程中使用 handler"></a>2.9.2. 存储过程中使用 handler</h4><p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc20_cursor(<span class="keyword">in</span> in_dname <span class="type">varchar</span>(<span class="number">50</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">		<span class="comment">-- 定义局部变量</span></span><br><span class="line">    <span class="keyword">declare</span> var_empno <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">declare</span> var_ename <span class="type">varchar</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">declare</span> var_sal <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">declare</span> flag <span class="type">int</span> <span class="keyword">default</span> <span class="number">1</span>; <span class="comment">-- ---------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 声明游标</span></span><br><span class="line">    <span class="keyword">declare</span> my_cursor <span class="keyword">cursor</span> <span class="keyword">for</span></span><br><span class="line">        <span class="keyword">select</span> empno,ename,sal</span><br><span class="line">        <span class="keyword">from</span> dept a, emp b</span><br><span class="line">        <span class="keyword">where</span> a.deptno <span class="operator">=</span> b.deptno <span class="keyword">and</span> a.dname <span class="operator">=</span> in_dname;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 定义句柄，当数据未发现时将标记位设置为0</span></span><br><span class="line">    <span class="keyword">declare</span> continue handler <span class="keyword">for</span> <span class="keyword">NOT</span> FOUND <span class="keyword">set</span> flag <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">-- 打开游标</span></span><br><span class="line">    <span class="keyword">open</span> my_cursor;</span><br><span class="line">    <span class="comment">-- 通过游标获取值</span></span><br><span class="line">    label:loop</span><br><span class="line">        <span class="keyword">fetch</span> my_cursor <span class="keyword">into</span> var_empno, var_ename,var_sal;</span><br><span class="line">        <span class="comment">-- 判断标志位</span></span><br><span class="line">        if flag <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">select</span> var_empno, var_ename,var_sal;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            leave label;</span><br><span class="line">        <span class="keyword">end</span> if;</span><br><span class="line">    <span class="keyword">end</span> loop label;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 关闭游标</span></span><br><span class="line">    <span class="keyword">close</span> my_cursor;</span><br><span class="line"><span class="keyword">end</span> $$;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc21_cursor_handler(<span class="string">&#x27;销售部&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="2-10-获取当前登陆用户"><a href="#2-10-获取当前登陆用户" class="headerlink" title="2.10. 获取当前登陆用户"></a>2.10. 获取当前登陆用户</h3><p><code>user()</code> 函数用于是取得当前登陆的用户。一般在存储过程中使用，获取值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>() <span class="keyword">into</span> 变量名;</span><br></pre></td></tr></table></figure>
<h3 id="2-11-查询最后插入的数据的id"><a href="#2-11-查询最后插入的数据的id" class="headerlink" title="2.11. 查询最后插入的数据的id"></a>2.11. 查询最后插入的数据的id</h3><p><code>last_insert_id()</code> 函数可以获得刚插入的数据的id值，这个是session 级的，并发没有问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> xxxxx....;</span><br><span class="line"><span class="keyword">select</span> last_insert_id() <span class="keyword">into</span> 变量名;</span><br><span class="line"><span class="comment">-- 上面语句可以将最近插入的数据id赋值给变量，后面可以进行对应的逻辑处理</span></span><br></pre></td></tr></table></figure>
<h3 id="2-12-存储过程综合示例"><a href="#2-12-存储过程综合示例" class="headerlink" title="2.12. 存储过程综合示例"></a>2.12. 存储过程综合示例</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	创建下个月的每天对应的表user_2021_11_01、user_2021_11_02、...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	需求描述：</span></span><br><span class="line"><span class="comment">		我们需要用某个表记录很多数据，比如记录某某用户的搜索、购买行为(注意，此处是假设用数据库保存)，</span></span><br><span class="line"><span class="comment">		当每天记录较多时，如果把所有数据都记录到一张表中太庞大，需要分表，我们的要求是，每天一张表，存当天的统计数据，</span></span><br><span class="line"><span class="comment">		就要求提前生产这些表——每月月底创建下一个月每天的表！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">-- 思路：循环构建表名 user_2021_11_01 到 user_2020_11_30；并执行create语句。</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> if <span class="keyword">exists</span> proc22_demo;</span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> proc22_demo()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> next_year <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">declare</span> next_month <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">declare</span> next_month_day <span class="type">int</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">declare</span> next_month_str <span class="type">char</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">declare</span> next_month_day_str <span class="type">char</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 处理每天的表名</span></span><br><span class="line">    <span class="keyword">declare</span> table_name_str <span class="type">char</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">declare</span> t_index <span class="type">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">-- declare create_table_sql varchar(200);</span></span><br><span class="line">    <span class="comment">-- 获取下个月的年份</span></span><br><span class="line">    <span class="keyword">set</span> next_year <span class="operator">=</span> <span class="keyword">year</span>(date_add(now(),<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">month</span>));</span><br><span class="line">    <span class="comment">-- 获取下个月是几月</span></span><br><span class="line">    <span class="keyword">set</span> next_month <span class="operator">=</span> <span class="keyword">month</span>(date_add(now(),<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">month</span>));</span><br><span class="line">    <span class="comment">-- 下个月最后一天是几号</span></span><br><span class="line">    <span class="keyword">set</span> next_month_day <span class="operator">=</span> dayofmonth(LAST_DAY(date_add(now(),<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">month</span>)));</span><br><span class="line"></span><br><span class="line">    if next_month <span class="operator">&lt;</span> <span class="number">10</span></span><br><span class="line">        <span class="keyword">then</span> <span class="keyword">set</span> next_month_str <span class="operator">=</span> concat(<span class="string">&#x27;0&#x27;</span>,next_month);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">set</span> next_month_str <span class="operator">=</span> concat(<span class="string">&#x27;&#x27;</span>,next_month);</span><br><span class="line">    <span class="keyword">end</span> if;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    while t_index <span class="operator">&lt;=</span> next_month_day do</span><br><span class="line">        if (t_index <span class="operator">&lt;</span> <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">then</span> <span class="keyword">set</span> next_month_day_str <span class="operator">=</span> concat(<span class="string">&#x27;0&#x27;</span>,t_index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">set</span> next_month_day_str <span class="operator">=</span> concat(<span class="string">&#x27;&#x27;</span>,t_index);</span><br><span class="line">        <span class="keyword">end</span> if;</span><br><span class="line">				<span class="comment">-- 2021_11_01</span></span><br><span class="line">        <span class="keyword">set</span> table_name_str <span class="operator">=</span> concat(next_year,<span class="string">&#x27;_&#x27;</span>,next_month_str,<span class="string">&#x27;_&#x27;</span>,next_month_day_str);</span><br><span class="line">        <span class="comment">-- 拼接create sql语句</span></span><br><span class="line">        <span class="keyword">set</span> <span class="variable">@create_table_sql</span> <span class="operator">=</span> concat(</span><br><span class="line">                    <span class="string">&#x27;create table user_&#x27;</span>,</span><br><span class="line">                    table_name_str,</span><br><span class="line">                    <span class="string">&#x27;(`uid` INT ,`ename` varchar(50) ,`information` varchar(50)) COLLATE=\&#x27;</span>utf8_general_ci\<span class="string">&#x27; ENGINE=InnoDB&#x27;</span>);</span><br><span class="line">        <span class="comment">-- FROM后面不能使用局部变量！</span></span><br><span class="line">        <span class="keyword">prepare</span> create_table_stmt <span class="keyword">FROM</span> <span class="variable">@create_table_sql</span>;</span><br><span class="line">        <span class="keyword">execute</span> create_table_stmt;</span><br><span class="line">        <span class="keyword">DEALLOCATE</span> <span class="keyword">prepare</span> create_table_stmt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">set</span> t_index <span class="operator">=</span> t_index <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span> while;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> proc22_demo();</span><br></pre></td></tr></table></figure>
<h3 id="2-13-存储过程优化思路"><a href="#2-13-存储过程优化思路" class="headerlink" title="2.13. 存储过程优化思路"></a>2.13. 存储过程优化思路</h3><ol>
<li>尽量利用一些 sql 语句来替代一些小循环，例如聚合函数，求平均函数等。</li>
<li>中间结果存放于临时表，加索引。</li>
<li>少使用游标。sql 是个集合语言，对于集合运算具有较高性能。而 cursors 是过程运算。比如对一个 100 万行的数据进行查询。游标需要读表 100 万次，而不使用游标则只需要少量几次读取。</li>
<li>事务越短越好。sqlserver 支持并发操作。如果事务过多过长，或者隔离级别过高，都会造成并发操作的阻塞，死锁。导致查询极慢，cpu 占用率极地。</li>
<li>使用 try-catch 处理错误异常。</li>
<li>查找语句尽量不要放在循环内</li>
</ol>
<h2 id="3-存储函数"><a href="#3-存储函数" class="headerlink" title="3. 存储函数"></a>3. 存储函数</h2><h3 id="3-1-概述"><a href="#3-1-概述" class="headerlink" title="3.1. 概述"></a>3.1. 概述</h3><p>MySQL存储函数（自定义函数），函数一般用于计算和返回一个值，可以将经常需要使用的计算或功能写成一个函数。存储函数和存储过程一样，都是在数据库中定义一些 SQL 语句的集合。</p>
<h3 id="3-2-创建语法"><a href="#3-2-创建语法" class="headerlink" title="3.2. 创建语法"></a>3.2. 创建语法</h3><p>在MySQL中，创建存储函数使用 <code>create function</code> 关键字，其基本形式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> func_name ([param_name type[,...]])</span><br><span class="line"><span class="keyword">returns</span> type</span><br><span class="line">	[characteristic ...]</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    routine_body</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>func_name</code>：存储函数的名称。</li>
<li><code>param_name type</code>：可选项，指定存储函数的参数。<code>type</code>参数用于指定存储函数的参数类型，该类型可以是MySQL数据库中所有支持的类型。</li>
<li><code>RETURNS type</code>：指定返回值的类型。</li>
<li><code>characteristic</code>：可选项，指定存储函数的特性。<ul>
<li><code>DETERMINISTIC</code>：相同的输入参数总是产生相同的结果</li>
<li><code>NO SQL</code>：不包含 SQL 语句</li>
<li><code>READS SQL DATA</code>：包含读取数据的语句，但不包含写入数据的语句</li>
</ul>
</li>
<li><code>routine_body</code>：SQL 代码内容。</li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建存储函数-没有输输入参数</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> if <span class="keyword">exists</span> myfunc1_emp;</span><br><span class="line"></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> myfunc1_emp() <span class="keyword">returns</span> <span class="type">int</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> cnt <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">into</span>  cnt <span class="keyword">from</span> emp;</span><br><span class="line">  <span class="keyword">return</span> cnt;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"><span class="comment">-- 调用存储函数</span></span><br><span class="line"><span class="keyword">select</span> myfunc1_emp();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建存储过程-有输入参数</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> if <span class="keyword">exists</span> myfunc2_emp;</span><br><span class="line"></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> myfunc2_emp(in_empno <span class="type">int</span>) <span class="keyword">returns</span> <span class="type">varchar</span>(<span class="number">50</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> out_name <span class="type">varchar</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">select</span> ename <span class="keyword">into</span> out_name <span class="keyword">from</span> emp <span class="keyword">where</span>  empno <span class="operator">=</span> in_empno;</span><br><span class="line">    <span class="keyword">return</span> out_name;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> myfunc2_emp(<span class="number">1008</span>);</span><br></pre></td></tr></table></figure>
<h3 id="3-3-注意问题"><a href="#3-3-注意问题" class="headerlink" title="3.3. 注意问题"></a>3.3. 注意问题</h3><ol>
<li>在 mysql8.0 版本中 binlog 默认是开启的，一旦开启了，mysql 就要求在定义存储过程时，需要指定 <code>characteristic</code> 特性，否则就会报如下错误：</li>
</ol>
<p><img src="https://gitee.com/Bluetom/img2/raw/master/img20240905/202410251023029.png" alt=""></p>
<ol>
<li>如果创建时出现错误，执行以下命令</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_bin_trust_function_creators<span class="operator">=</span><span class="literal">TRUE</span>; <span class="comment">-- 信任子程序的创建者</span></span><br></pre></td></tr></table></figure>
<h3 id="3-4-存储函数与存储过程的区别"><a href="#3-4-存储函数与存储过程的区别" class="headerlink" title="3.4. 存储函数与存储过程的区别"></a>3.4. 存储函数与存储过程的区别</h3><ol>
<li>存储函数有且只有一个返回值，而存储过程可以有多个返回值，也可以没有返回值。</li>
<li>存储函数只能有输入参数，而且不能带<code>in</code>，而存储过程可以有多个<code>in</code>、<code>out</code>、<code>inout</code>参数。</li>
<li>存储过程中的语句功能更强大，存储过程可以实现很复杂的业务逻辑，而函数有很多限制，如不能在函数中使用<code>insert</code>、<code>update</code>、<code>delete</code>、<code>create</code>等语句；</li>
<li>存储函数只完成查询的工作，可接受输入参数并返回一个结果，也就是函数实现的功能针对性比较强。</li>
<li>存储过程可以调用存储函数。但函数不能调用存储过程。</li>
<li>存储过程一般是作为一个独立的部分来执行(<code>call</code>调用)。而函数可以作为查询语句的一个部分来调用</li>
</ol>
<h2 id="4-触发器"><a href="#4-触发器" class="headerlink" title="4. 触发器"></a>4. 触发器</h2><h3 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1. 概述"></a>4.1. 概述</h3><p>触发器，就是一种特殊的存储过程。触发器和存储过程一样是一个能够完成特定功能、存储在数据库服务器上的 SQL 片段，但是触发器无需调用，当对数据库表中的数据执行 DML 操作时自动触发这个 SQL 片段的执行，无需手动调用。</p>
<p><strong>在MySQL中，只有执行<code>insert</code>,<code>delete</code>,<code>update</code>操作时才能触发触发器的执行</strong>。</p>
<p>触发器的这种特性可以协助应用在数据库端确保数据的完整性，日志记录，数据校验等操作。</p>
<p>使用别名 <code>OLD</code> 和 <code>NEW</code> 来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。现在触发器还只支持行级触发，不支持语句级触发</p>
<h3 id="4-2-触发器的特性"><a href="#4-2-触发器的特性" class="headerlink" title="4.2. 触发器的特性"></a>4.2. 触发器的特性</h3><ol>
<li>什么条件会触发：I、D、U</li>
<li>什么时候触发：在增删改前或者后</li>
<li>触发频率：针对每一行执行</li>
<li>触发器定义在表上，附着在表上</li>
</ol>
<p><img src="https://gitee.com/Bluetom/img2/raw/master/img20240905/202410251023030.png" alt=""></p>
<h3 id="4-3-触发器语法定义"><a href="#4-3-触发器语法定义" class="headerlink" title="4.3. 触发器语法定义"></a>4.3. 触发器语法定义</h3><h4 id="4-3-1-创建语法"><a href="#4-3-1-创建语法" class="headerlink" title="4.3.1. 创建语法"></a>4.3.1. 创建语法</h4><ul>
<li>创建只有一个执行语句的触发器</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> 触发器名 BEFORE <span class="operator">|</span> AFTER 触发事件[ <span class="keyword">INSERT</span> <span class="operator">|</span> <span class="keyword">UPDATE</span> <span class="operator">|</span> <span class="keyword">DELETE</span> ]</span><br><span class="line"><span class="keyword">ON</span> 表名 <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line">执行语句;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建有多个执行语句的触发器</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> 触发器名 BEFORE <span class="operator">|</span> AFTER 触发事件[ <span class="keyword">INSERT</span> <span class="operator">|</span> <span class="keyword">UPDATE</span> <span class="operator">|</span> <span class="keyword">DELETE</span> ]</span><br><span class="line"><span class="keyword">ON</span> 表名 <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	执行语句列表</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>触发事件：取值：<code>insert</code> | <code>update</code> | <code>delete</code></li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 如果触发器存在，则先删除</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> if  <span class="keyword">exists</span> trigger_test1;</span><br><span class="line"><span class="comment">-- 创建触发器trigger_test1</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> trigger_test1</span><br><span class="line">after <span class="keyword">insert</span> <span class="keyword">on</span> <span class="keyword">user</span> <span class="comment">-- 触发时机：当添加user表数据时触发</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line">    <span class="keyword">insert into</span> user_logs <span class="keyword">values</span>(<span class="keyword">NULL</span>,now(), <span class="string">&#x27;有新用户注册&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加数据，触发器自动执行并添加日志代码</span></span><br><span class="line"><span class="keyword">insert into</span> <span class="keyword">user</span> <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果触发器trigger_test2存在，则先删除</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> if <span class="keyword">exists</span> trigger_test2;</span><br><span class="line"><span class="comment">-- 创建触发器trigger_test2</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> trigger_test2</span><br><span class="line">after <span class="keyword">update</span> <span class="keyword">on</span> <span class="keyword">user</span>  <span class="comment">-- 触发时机：当修改user表数据时触发</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span> <span class="comment">-- 每一行</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">insert into</span> user_logs <span class="keyword">values</span>(<span class="keyword">NULL</span>,now(), <span class="string">&#x27;用户修改发生了修改&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加数据，触发器自动执行并添加日志代码</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> password <span class="operator">=</span> <span class="string">&#x27;888888&#x27;</span> <span class="keyword">where</span> uid <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-2-操作关键字-NEW-OLD"><a href="#4-3-2-操作关键字-NEW-OLD" class="headerlink" title="4.3.2. 操作关键字 (NEW|OLD)"></a>4.3.2. 操作关键字 (NEW|OLD)</h4><p>MySQL 中定义了 <code>NEW</code> 和 <code>OLD</code>，用来表示触发器的所在表中，触发了触发器的那一行数据，来引用触发器中发生变化的记录内容。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">触发器类型</th>
<th>触发器类型<code>NEW</code> 和 <code>OLD</code> 的使用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>INSERT</code> 型触发器</td>
<td><code>NEW</code> 表示将要或者已经新增的数据</td>
</tr>
<tr>
<td style="text-align:center"><code>UPDATE</code> 型触发器</td>
<td><code>OLD</code> 表示修改之前的数据，<code>NEW</code> 表示将要或已经修改后的数据</td>
</tr>
<tr>
<td style="text-align:center"><code>DELETE</code> 型触发器</td>
<td><code>OLD</code> 表示将要或者已经删除的数据</td>
</tr>
</tbody>
</table>
</div>
<p>使用方法：</p>
<ul>
<li><code>NEW.columnName</code>：获取新增数据某一列的值，<code>columnName</code>为相应数据表某一列名</li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> trigger_test3 after <span class="keyword">insert</span></span><br><span class="line"><span class="keyword">on</span> <span class="keyword">user</span> <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">insert into</span> user_logs <span class="keyword">values</span>(<span class="keyword">NULL</span>,now(),concat(<span class="string">&#x27;有新用户添加，信息为:&#x27;</span>,NEW.uid,NEW.username,NEW.password));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试</span></span><br><span class="line"><span class="keyword">insert into</span> <span class="keyword">user</span> <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;赵六&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="4-3-3-查看触发器"><a href="#4-3-3-查看触发器" class="headerlink" title="4.3.3. 查看触发器"></a>4.3.3. 查看触发器</h4><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> triggers;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-4-删除触发器"><a href="#4-3-4-删除触发器" class="headerlink" title="4.3.4. 删除触发器"></a>4.3.4. 删除触发器</h4><p>如果没有指定 schema_name，默认为当前数据库。语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> [if <span class="keyword">exists</span>] [schema_name.]trigger_name;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> if <span class="keyword">exists</span> trigger_test1;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-触发器注意事项"><a href="#4-4-触发器注意事项" class="headerlink" title="4.4. 触发器注意事项"></a>4.4. 触发器注意事项</h3><ol>
<li>MYSQL 中触发器中不能对本表进行 <code>insert</code>, <code>update</code>, <code>delete</code> 操作，以免递归循环触发</li>
<li>尽量少使用触发器，假设触发器触发每次执行1s，insert table 500条数据，那么就需要触发500次触发器，光是触发器执行的时间就花费了500s，而insert 500条数据一共是1s，那么这个insert的效率就非常低了。</li>
<li>触发器是针对每一行的；对增删改非常频繁的表上切记不要使用触发器，因为它会非常消耗资源。</li>
</ol>
<h2 id="5-分区表-了解"><a href="#5-分区表-了解" class="headerlink" title="5. 分区表(了解)"></a>5. 分区表(了解)</h2><blockquote>
<p>Tips: 此知识点只需要了解，实际项目的应用极少</p>
</blockquote>
<h3 id="5-1-简介"><a href="#5-1-简介" class="headerlink" title="5.1. 简介"></a>5.1. 简介</h3><p>分区是指根据一定的规则，数据库把一个表分解成多个更小的、更容易管理的部分。就访问数据库的应用而言，逻辑上只有一个表或一个索引，但是实际上这个表可能由数 10 个物理分区对象组成，每个分区都是一个独立的对象，可以独自处理，可以作为表的一部分进行处理。</p>
<p>分区表是一个独立的逻辑表，但是底层由多个物理子表组成。实现分区的代码实际上是对一组底层表的的封装。对分区表的请求，都会转化成对存储引擎的接口调用。<strong>分区对于 SQL 层来说是一个完全封装底层实现的黑盒子，对应用是透明的</strong>。从底层的文件系统可以看出，每一个分区表都有一个使用<code>#</code>分隔命名的表文件。</p>
<p>MySQL 在创建表时使用<code>PARTITION BY</code>子句定义每个分区存放的数据。在执行查询的时候，优化器根据分区定义过滤那些数据不在的分区，这样查询就无须扫描所有分区。</p>
<p>分区的一个主要目的是将数据按照一个较粗的粒度分在不同的表中。另外，也方便一次批量删除整个分区的数据。</p>
<h3 id="5-2-分区表的优点与限制"><a href="#5-2-分区表的优点与限制" class="headerlink" title="5.2. 分区表的优点与限制"></a>5.2. 分区表的优点与限制</h3><p><strong>分区表的优点</strong>：</p>
<ul>
<li>当表非常大以至于无法全部都放在内存中，或者只在表的最后部分有热点数据，其他均是历史数据。此时分区表与单个磁盘或文件系统分区相比，可以存储更多的数据。</li>
<li>对于那些已经失去保存意义的数据，通常可以通过删除与那些数据有关的分区，很容易地删除那些数据。相反地，在某些情况下，添加新数据的过程又可以通过为那些新数据专门增加一个新的分区，来很方便地实现。</li>
<li>一些查询可以得到极大的优化，这主要是借助于满足一个给定 WHERE 语句的数据可以只保存在一个或多个分区内，这样在查找时就不用查找其他剩余的分区。因为分区可以在创建了分区表后进行修改，所以在第一次配置分区方案时不曾这么做时，可以重新组织数据，来提高那些常用查询的效率。</li>
<li>涉及到例如 <code>SUM()</code> 和 <code>COUNT()</code> 这样聚合函数的查询，可以很容易地进行并行处理。这种查询的一个简单例子如 <code>SELECT salesperson_id, COUNT (orders) as order_total FROM sales GROUP BY salesperson_id;</code>。通过“并行”，这意味着该查询可以在每个分区上同时进行，最终结果只需通过总计所有分区得到的结果。</li>
<li>通过跨多个磁盘来分散数据查询，来获得更大的查询吞吐量。</li>
<li>分区表的数据更容易维护。例如，想批量删除大量数据可以使用清除整个分区的方式。另外，还可以对一个独立分区进行优化、检查、修复等操作。</li>
<li>分区表的数据可以分布在不同的物理设备上，从而高效地利用多个硬件设备。可以使用分区表来避免某些特殊的瓶颈，例如 InnoDB 的单个索引的互斥访问、ext3 文件系统的 inode 锁竞争等。</li>
<li>如果需要，还可以备份和恢复独立的分区，这在非常大的数据集的场景下效果非常好。</li>
</ul>
<p><strong>分区表的限制</strong>：</p>
<ul>
<li>一个表最多只能有 1024 个分区。</li>
<li>MySQL 5.1 中，分区表达式必须是整数，或者返回整数的表达式。在 MySQL 5.5 中提供了非整数表达式分区的支持。</li>
<li>如果分区字段中有主键或者唯一索引的列，那么所有主键列和唯一索引列都必须包含进来。即：分区字段要么不包含主键或者索引列，要么包含全部主键和索引列。</li>
<li>分区表中无法使用外键约束。</li>
<li>MySQL的分区适用于一个表的所有数据和索引，不能只对表数据分区而不对索引分区，也不能只对索引分区而不对表分区，也不能只对表的一部分数据分区。</li>
</ul>
<h3 id="5-3-分区表的原理"><a href="#5-3-分区表的原理" class="headerlink" title="5.3. 分区表的原理"></a>5.3. 分区表的原理</h3><p>分区表由多个相关的底层表实现，这些底层表也是由句柄对象（Handlerobject)表示，所以也可以直接访问各个分区。存储引擎管理分区的各个底层表和管理普通表一样（所有的底层表都必须使用相同的存储引擎)，分区表的索引只是在各个底层表上各自加上一个完全相同的索引。从存储引擎的角度来看，底层表和一个普通表没有任何不同，存储引擎也无须知道这是一个普通表还是一个分区表的一部分。分区表上的操作按照下面的操作逻辑进行:</p>
<p>虽然每个操作都会“先打开并锁住所有的底层表”，但这并不是说分区表在处理过程中是锁住全表的。如果存储引擎能够自己实现行级锁，例如 InnoDB，则会在分区层释放对应表锁。这个加锁和解锁过程与普通 InnoDB 上的查询类似。</p>
<h3 id="5-4-分区表的类型"><a href="#5-4-分区表的类型" class="headerlink" title="5.4. 分区表的类型"></a>5.4. 分区表的类型</h3><h4 id="5-4-1-MySQL-支持的分区表"><a href="#5-4-1-MySQL-支持的分区表" class="headerlink" title="5.4.1. MySQL 支持的分区表"></a>5.4.1. MySQL 支持的分区表</h4><ul>
<li>RANGE 分区：基于属于一个给定连续区间的列值，把多行分配给分区。</li>
<li>LIST 分区：类似于按 RANGE 分区，区别在于 LIST 分区是基于列值匹配一个离散值集合中的某个值来进行选择。</li>
<li>HASH 分区：基于用户定义的表达式的返回值来进行选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含 MySQL 中有效的、产生非负整数值的任何表达式。</li>
<li>KEY 分区：类似于按 HASH 分区，区别在于 KEY 分区只支持计算一列或多列，且 MySQL 服务器提供其自身的哈希函数。必须有一列或多列包含整数值。</li>
<li>复合分区/子分区：目前只支持 RANGE 和 LIST 的子分区，且子分区的类型只能为 HASH 和 KEY。</li>
</ul>
<h4 id="5-4-2-查询数据库表是否支持分区"><a href="#5-4-2-查询数据库表是否支持分区" class="headerlink" title="5.4.2. 查询数据库表是否支持分区"></a>5.4.2. 查询数据库表是否支持分区</h4><p>在进行分区之前，可以使用如下语句检查数据库表是否支持分区：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%partition%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name     <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> have_partitioning <span class="operator">|</span> YES   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+-------+</span></span><br></pre></td></tr></table></figure>
<h4 id="5-4-3-分区的基本语法"><a href="#5-4-3-分区的基本语法" class="headerlink" title="5.4.3. 分区的基本语法"></a>5.4.3. 分区的基本语法</h4><ul>
<li>RANGE 分区</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> test (</span><br><span class="line">    order_date DATETIME <span class="keyword">NOT NULL</span>,</span><br><span class="line">）ENGINE<span class="operator">=</span>InnoDB</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(<span class="keyword">YEAR</span>(order_date))(</span><br><span class="line"><span class="keyword">PARTITION</span> p_0 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2010</span>) ,</span><br><span class="line"><span class="keyword">PARTITION</span> p_1 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2011</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p_2 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2012</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p_other <span class="keyword">VALUES</span> LESS THAN MAXVALUE);</span><br></pre></td></tr></table></figure>
<ul>
<li>LIST 分区(类似枚举)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> h2 (</span><br><span class="line">    c1 <span class="type">INT</span>,</span><br><span class="line">    c2 <span class="type">INT</span></span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> LIST(c1) (</span><br><span class="line"><span class="keyword">PARTITION</span> p0 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">4</span>, <span class="number">7</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="number">2</span>, <span class="number">5</span>, <span class="number">8</span>));</span><br></pre></td></tr></table></figure>
<ul>
<li>range 和 List 都是整数类型分区，其实 range 和 List 也支持非整数分区，但是要结合 COLUMN 分区，支持整形、日期、字符串</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> emp_date(</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    ename <span class="type">VARCHAR</span> (<span class="number">30</span>),</span><br><span class="line">    hired <span class="type">DATE</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01&#x27;</span>,</span><br><span class="line">    separated <span class="type">DATE</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;9999-12-31&#x27;</span>,</span><br><span class="line">    job <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    store_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> COLUMNS (separated)(</span><br><span class="line"><span class="keyword">PARTITION</span> pO <span class="keyword">VALUES</span> LESS THAN (<span class="string">&#x27;1996-01-01&#x27;</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> LESS THAN (<span class="string">&#x27;2001-01-01&#x27;</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p2 <span class="keyword">VALUES</span> LESS THAN (<span class="string">&#x27;2006-01-01&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> expenses (</span><br><span class="line">    expense_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    category <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">    amount <span class="type">DECIMAL</span> (<span class="number">10</span>,<span class="number">3</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> LIST COLUMNS (category)(</span><br><span class="line"><span class="keyword">PARTITION</span> p0 <span class="keyword">VALUES</span> <span class="keyword">IN</span> (<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>) ,</span><br><span class="line"><span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> <span class="keyword">IN</span>(<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p2 <span class="keyword">VALUES</span> <span class="keyword">IN</span>(<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;f&#x27;</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p3 <span class="keyword">VALUES</span> <span class="keyword">IN</span>(<span class="string">&#x27;g&#x27;</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p4 <span class="keyword">VALUES</span> <span class="keyword">IN</span>(<span class="string">&#x27;h&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在结合 COLUMN 分区时还支持多列</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> rc3(</span><br><span class="line">    a <span class="type">INT</span>,</span><br><span class="line">    b <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> COLUMNS(a,b)(</span><br><span class="line"><span class="keyword">PARTITION</span> p01 <span class="keyword">VALUES</span> LESS THAN (<span class="number">0</span>,<span class="number">10</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p02 <span class="keyword">VALUES</span> LESS THAN (<span class="number">10</span>,<span class="number">10</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p03 <span class="keyword">VALUES</span> LESS THAN (<span class="number">10</span>,<span class="number">20</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p04 <span class="keyword">VALUES</span> LESS THAN (<span class="number">10</span>,<span class="number">35</span>),</span><br><span class="line"><span class="keyword">PARTITION</span> p05 <span class="keyword">VALUES</span> LESS THAN (<span class="number">10</span>,MAXVALUE),</span><br><span class="line"><span class="keyword">PARTITION</span> p06 <span class="keyword">VALUES</span> LESS THAN (MAXVALUE,MAXVALUE));</span><br></pre></td></tr></table></figure>
<ul>
<li>Hash 分区</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> emp (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    ename <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">    hired <span class="type">DATE</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01&#x27;</span></span><br><span class="line">    separated DATENOT <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;9999-12-31&#x27;</span>,</span><br><span class="line">    job <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    store_id <span class="type">INT</span> <span class="keyword">NOT NULL</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> HASH (store_id) PARTITIONS <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上示例创建了一个基于 store_id 列 HASH 分区的表，表被分成了 4 个分区，如果我们插入的记录<code>store_id=234</code>，则 <code>234 mod 4 = 2</code>，这条记录就会保存到第二个分区。虽然在HASH()中直接使用的 store_id 列，但是 MySQL 是允许基于某列值返回一个整数值的表达式或者 MySQL 中有效的任何函数或者其他表达式都是可以的。</p>
</blockquote>
<ul>
<li>key分区</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span> 创建了一个基于 job 字段进行 Key 分区的表，表被分成了 <span class="number">4</span> 个分区。KEY ()里只允许出现表中的字段。</span><br><span class="line"><span class="keyword">CREATE TABLE</span> emp (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    ename <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">    hired <span class="type">DATE</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1970-01-01&#x27;</span></span><br><span class="line">    separated DATENOT <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;9999-12-31&#x27;</span>,</span><br><span class="line">    job <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    store_id <span class="type">INT</span> <span class="keyword">NOT NULL</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> KEY (job) PARTITIONS <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-不建议使用-mysql-分区表"><a href="#5-5-不建议使用-mysql-分区表" class="headerlink" title="5.5. 不建议使用 mysql 分区表"></a>5.5. 不建议使用 mysql 分区表</h3><p>在实际互联网项目中，MySQL 分区表用的极少，更多的是分库分表。</p>
<p>分库分表除了支持 MySQL 分区表的水平切分以外，还支持垂直切分，把一个很大的库（表）的数据分到几个库（表）中，每个库（表）的结构都相同，但他们可能分布在不同的 mysql 实例，甚至不同的物理机器上，以达到降低单库（表）数据量，提高访问性能的目的。两者对比如下：</p>
<ul>
<li>分区表，分区键设计不太灵活，如果不走分区键，很容易出现全表锁</li>
<li>一旦数据量并发量上来，如果在分区表实施关联，就是一个灾难</li>
<li>分库分表，使用者来掌控业务场景与访问模式，可控。分区表，由 mysql 本身来实现，不太可控</li>
<li>分区表无论怎么分，都是在一台机器上，天然就有性能的上限</li>
</ul>
<h2 id="6-Mysql-8-0-新特性详解"><a href="#6-Mysql-8-0-新特性详解" class="headerlink" title="6. Mysql 8.0 新特性详解"></a>6. Mysql 8.0 新特性详解</h2><blockquote>
<p>Tips: 建议使用 8.0.17 及之后的版本</p>
</blockquote>
<h3 id="6-1-新增降序索引"><a href="#6-1-新增降序索引" class="headerlink" title="6.1. 新增降序索引"></a>6.1. 新增降序索引</h3><p>MySQL 早期的版本中在语法上是支持降序索引，但实际上创建的仍然是升序索引。如下MySQL 5.7 所示，c2字段降序，但是从<code>show create table</code>看c2仍然是升序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>MySQL <span class="number">5.7</span>演示<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create table</span> t1(c1 <span class="type">int</span>,c2 <span class="type">int</span>,index idx_c1_c2(c1,c2 <span class="keyword">desc</span>));</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t1 (c1,c2) <span class="keyword">values</span>(<span class="number">1</span>, <span class="number">10</span>),(<span class="number">2</span>,<span class="number">50</span>),(<span class="number">3</span>,<span class="number">50</span>),(<span class="number">4</span>,<span class="number">100</span>),(<span class="number">5</span>,<span class="number">80</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create table</span> t1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: t1</span><br><span class="line"><span class="keyword">Create Table</span>: <span class="keyword">CREATE TABLE</span> `t1` (</span><br><span class="line">  `c1` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c2` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  KEY `idx_c1_c2` (`c1`,`c2`)    <span class="comment">-- 注意这里，c2字段是升序</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>latin1</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">order</span> <span class="keyword">by</span> c1,c2 <span class="keyword">desc</span>;  <span class="comment">--5.7也会使用索引，但是Extra字段里有filesort文件排序</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key       <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_c1_c2 <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> index; <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br></pre></td></tr></table></figure>
<p>8.0 版本可见 c2 字段降序。<font color=red><strong>注意：只有 Innodb 存储引擎支持降序索引</strong></font>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>MySQL <span class="number">8.0</span>演示<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create table</span> t1(c1 <span class="type">int</span>,c2 <span class="type">int</span>,index idx_c1_c2(c1,c2 <span class="keyword">desc</span>));</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t1 (c1,c2) <span class="keyword">values</span>(<span class="number">1</span>, <span class="number">10</span>),(<span class="number">2</span>,<span class="number">50</span>),(<span class="number">3</span>,<span class="number">50</span>),(<span class="number">4</span>,<span class="number">100</span>),(<span class="number">5</span>,<span class="number">80</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create table</span> t1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: t1</span><br><span class="line"><span class="keyword">Create Table</span>: <span class="keyword">CREATE TABLE</span> `t1` (</span><br><span class="line">  `c1` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c2` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  KEY `idx_c1_c2` (`c1`,`c2` <span class="keyword">DESC</span>)  <span class="comment">--注意这里的区别，降序索引生效了</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">order</span> <span class="keyword">by</span> c1,c2 <span class="keyword">desc</span>;  <span class="comment">--Extra字段里没有filesort文件排序，充分利用了降序索引</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key       <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_c1_c2 <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">order</span> <span class="keyword">by</span> c1 <span class="keyword">desc</span>,c2;  <span class="comment">--Extra字段里有Backward index scan，意思是反向扫描索引;</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key       <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra                            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+----------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_c1_c2 <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> Backward index scan; <span class="keyword">Using</span> index <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+----------------------------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">order</span> <span class="keyword">by</span> c1 <span class="keyword">desc</span>,c2 <span class="keyword">desc</span>;  <span class="comment">--Extra字段里有filesort文件排序，排序必须按照每个字段定义的排序或按相反顺序才能充分利用索引</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key       <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_c1_c2 <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> index; <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">order</span> <span class="keyword">by</span> c1,c2;    <span class="comment">--Extra字段里有filesort文件排序，排序必须按照每个字段定义的排序或按相反顺序才能充分利用索引</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type  <span class="operator">|</span> possible_keys <span class="operator">|</span> key       <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t1    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> index <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> idx_c1_c2 <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> index; <span class="keyword">Using</span> filesort <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+-----------------------------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6-2-group-by-不再隐式排序"><a href="#6-2-group-by-不再隐式排序" class="headerlink" title="6.2. group by 不再隐式排序"></a>6.2. group by 不再隐式排序</h3><p>5.7 版本使用<code>group by</code>进行排序，会隐式将对分组的字段进行排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>MySQL <span class="number">5.7</span>演示<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),c2 <span class="keyword">from</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> c2;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span> c2   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   <span class="number">80</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>  <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br></pre></td></tr></table></figure>
<p>8.0 版本对于 <code>group by</code> 字段不再隐式排序，如需要排序，必须显式加上 <code>order by</code> 子句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>MySQL <span class="number">8.0</span>演示<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),c2 <span class="keyword">from</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> c2;   <span class="comment">--8.0版本group by不再默认排序</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span> c2   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>  <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   <span class="number">80</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),c2 <span class="keyword">from</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> c2 <span class="keyword">order</span> <span class="keyword">by</span> c2;  <span class="comment">--8.0版本group by不再默认排序，需要自己加order by</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span> c2   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>   <span class="number">80</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span>  <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6-3-增加隐藏索引"><a href="#6-3-增加隐藏索引" class="headerlink" title="6.3. 增加隐藏索引"></a>6.3. 增加隐藏索引</h3><p>在 8.0 版本中，可以使用 <code>invisible</code> 关键字在创建表或者进行表变更中设置索引为隐藏索引。索引隐藏只是不可见，但是数据库后台还是会维护隐藏索引的，但在查询时优化器不使用该索引，就算使用<code>force index</code> 关键字，优化器也不会使用该索引，同时优化器也不会报索引不存在的错误，因为索引仍然真实存在，必要时，也可以把隐藏索引快速恢复成可见。</p>
<blockquote>
<p>Notes: <font color=red><strong>主键不能设置为 invisible</strong></font>。</p>
</blockquote>
<p>软删除就可以使用隐藏索引，比如分析某个索引没用了，删除后发现这个索引在某些时候还是有用的，就要把该索引恢复回去，如果表数据量很大的话，这种操作耗费时间是很多的，成本很高，此时就可以将索引先设置为隐藏索引，等到真的确认索引没用了再删除。</p>
<ul>
<li><strong>创建隐藏索引</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 创建t2表，里面的c2字段为隐藏索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create table</span> t2(c1 <span class="type">int</span>, c2 <span class="type">int</span>, index idx_c1(c1), index idx_c2(c2) invisible);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> t2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: t2</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_c1</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: c1</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">      Visible: YES</span><br><span class="line">   Expression: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: t2</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_c2</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: c2</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">      Visible: <span class="keyword">NO</span>   <span class="comment">--隐藏索引不可见</span></span><br><span class="line">   Expression: <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>测试隐藏索引c2是否被使用</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t2 <span class="keyword">where</span> c1<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key    <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t2    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> idx_c1        <span class="operator">|</span> idx_c1 <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t2 <span class="keyword">where</span> c2<span class="operator">=</span><span class="number">1</span>;  <span class="comment">--隐藏索引c2不会被使用</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t2    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>设置会话查询优化器对隐藏索引可见</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@optimizer_switch</span>\G   <span class="comment">-- 查看各种参数</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">@<span class="variable">@optimizer_switch</span>: index_merge<span class="operator">=</span><span class="keyword">on</span>,index_merge_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_sort_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_intersection<span class="operator">=</span><span class="keyword">on</span>,engine_condition_pushdown<span class="operator">=</span><span class="keyword">on</span>,index_condition_pushdown<span class="operator">=</span><span class="keyword">on</span>,mrr<span class="operator">=</span><span class="keyword">on</span>,mrr_cost_based<span class="operator">=</span><span class="keyword">on</span>,block_nested_loop<span class="operator">=</span><span class="keyword">on</span>,batched_key_access<span class="operator">=</span>off,materialization<span class="operator">=</span><span class="keyword">on</span>,semijoin<span class="operator">=</span><span class="keyword">on</span>,loosescan<span class="operator">=</span><span class="keyword">on</span>,firstmatch<span class="operator">=</span><span class="keyword">on</span>,duplicateweedout<span class="operator">=</span><span class="keyword">on</span>,subquery_materialization_cost_based<span class="operator">=</span><span class="keyword">on</span>,use_index_extensions<span class="operator">=</span><span class="keyword">on</span>,condition_fanout_filter<span class="operator">=</span><span class="keyword">on</span>,derived_merge<span class="operator">=</span><span class="keyword">on</span>,use_invisible_indexes<span class="operator">=</span>off,skip_scan<span class="operator">=</span><span class="keyword">on</span>,hash_join<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> session optimizer_switch<span class="operator">=</span>&quot;use_invisible_indexes=on&quot;;  <span class="comment">-- 在会话级别设置查询优化器可以看到隐藏索引</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@optimizer_switch</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">@<span class="variable">@optimizer_switch</span>: index_merge<span class="operator">=</span><span class="keyword">on</span>,index_merge_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_sort_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_intersection<span class="operator">=</span><span class="keyword">on</span>,engine_condition_pushdown<span class="operator">=</span><span class="keyword">on</span>,index_condition_pushdown<span class="operator">=</span><span class="keyword">on</span>,mrr<span class="operator">=</span><span class="keyword">on</span>,mrr_cost_based<span class="operator">=</span><span class="keyword">on</span>,block_nested_loop<span class="operator">=</span><span class="keyword">on</span>,batched_key_access<span class="operator">=</span>off,materialization<span class="operator">=</span><span class="keyword">on</span>,semijoin<span class="operator">=</span><span class="keyword">on</span>,loosescan<span class="operator">=</span><span class="keyword">on</span>,firstmatch<span class="operator">=</span><span class="keyword">on</span>,duplicateweedout<span class="operator">=</span><span class="keyword">on</span>,subquery_materialization_cost_based<span class="operator">=</span><span class="keyword">on</span>,use_index_extensions<span class="operator">=</span><span class="keyword">on</span>,condition_fanout_filter<span class="operator">=</span><span class="keyword">on</span>,derived_merge<span class="operator">=</span><span class="keyword">on</span>,use_invisible_indexes<span class="operator">=</span><span class="keyword">on</span>,skip_scan<span class="operator">=</span><span class="keyword">on</span>,hash_join<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t2 <span class="keyword">where</span> c2<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key    <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t2    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> idx_c2        <span class="operator">|</span> idx_c2 <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>修改索引是否隐藏</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter table</span> t2 <span class="keyword">alter</span> index idx_c2 visible;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter table</span> t2 <span class="keyword">alter</span> index idx_c2 invisible;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="6-4-新增函数索引"><a href="#6-4-新增函数索引" class="headerlink" title="6.4. 新增函数索引"></a>6.4. 新增函数索引</h3><p>MySQL 早期的版本中，如果在查询中加入了函数，索引不生效。在 8.0 版本之后引入了函数索引，MySQL 8.0.13 开始支持在索引中使用<code>函数(表达式)</code>的值。</p>
<p><strong>函数索引基于虚拟列功能实现</strong>，在 MySQL 中相当于新增了一个列，这个列会根据查询条件中的函数来进行计算结果，然后使用函数索引的时候就会用这个计算后的列作为索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create table</span> t3(c1 <span class="type">varchar</span>(<span class="number">10</span>),c2 <span class="type">varchar</span>(<span class="number">10</span>)); <span class="comment">-- 创建测试的表</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> index idx_c1 <span class="keyword">on</span> t3(c1);     <span class="comment">-- 创建普通索引</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> index func_idx <span class="keyword">on</span> t3((<span class="built_in">UPPER</span>(c2)));  <span class="comment">-- 创建一个大写的函数索引</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> t3\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: t3</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_c1</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: c1</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">      Visible: YES</span><br><span class="line">   Expression: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: t3</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: func_idx</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: <span class="keyword">NULL</span></span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">      Visible: YES</span><br><span class="line">   Expression: <span class="built_in">upper</span>(`c2`)    <span class="comment">-- 函数表达式</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t3 <span class="keyword">where</span> <span class="built_in">upper</span>(c1)<span class="operator">=</span><span class="string">&#x27;moonzero&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t3    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t3 <span class="keyword">where</span> <span class="built_in">upper</span>(c2)<span class="operator">=</span><span class="string">&#x27;moonzero&#x27;</span>;  <span class="comment">--使用了函数索引</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key      <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>   <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> t3    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> func_idx      <span class="operator">|</span> func_idx <span class="operator">|</span> <span class="number">43</span>      <span class="operator">|</span> const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+----------+---------+-------+------+----------+-------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6-5-innodb-存储引擎可跳过锁等待"><a href="#6-5-innodb-存储引擎可跳过锁等待" class="headerlink" title="6.5. innodb 存储引擎可跳过锁等待"></a>6.5. innodb 存储引擎可跳过锁等待</h3><p>在 5.7 及之前的版本，执行<code>select...for update</code>语句时，如果获取不到锁则会一直等待，直到 <code>innodb_lock_wait_timeout</code> 超时。</p>
<p>在 8.0 版本后，对于<code>select …… for share</code>(8.0新增加查询共享锁的语法)或<code>select …… for update</code>，在语句后面添加 <code>NOWAIT</code>、<code>SKIP LOCKED</code> 等关键字语法，可以跳过锁等待，或者跳过锁定，能够立即返回。假设查询的行已经加锁，两个关键字分别处理逻辑如下：</p>
<ul>
<li><code>nowait</code> 关键字的语句会立即报错返回。</li>
<li><code>skip locked</code> 关键字的语句也会立即返回，但只是返回的结果中不包含被锁定的行。</li>
</ul>
<blockquote>
<p>应用场景：比如查询余票记录，如果某些记录已经被锁定，用 skip locked 可以跳过被锁定的记录，只返回没有锁定的记录，提高系统性能。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 先打开一个session1:</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span> c1   <span class="operator">|</span> c2   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span>  <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span>   <span class="number">80</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line">    </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>; <span class="comment">-- 开启事务</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> t1 <span class="keyword">set</span> c2 <span class="operator">=</span> <span class="number">60</span> <span class="keyword">where</span> c1 <span class="operator">=</span> <span class="number">2</span>;     <span class="comment">-- 锁定第二条记录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 打开另外一个session2:    </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c1 <span class="operator">=</span> <span class="number">2</span> <span class="keyword">for</span> <span class="keyword">update</span>;   <span class="comment">-- 等待超时</span></span><br><span class="line">ERROR <span class="number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c1 <span class="operator">=</span> <span class="number">2</span> <span class="keyword">for</span> <span class="keyword">update</span> nowait;   <span class="comment">-- 查询立即返回</span></span><br><span class="line">ERROR <span class="number">3572</span> (HY000): Statement aborted because lock(s) could <span class="keyword">not</span> be acquired immediately <span class="keyword">and</span> NOWAIT <span class="keyword">is</span> set.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">for</span> <span class="keyword">update</span> <span class="keyword">skip</span> locked;  <span class="comment">-- 查询立即返回，过滤掉了第二行记录</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span> c1   <span class="operator">|</span> c2   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span>  <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span>   <span class="number">80</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6-6-新增-innodb-dedicated-server-自适应参数"><a href="#6-6-新增-innodb-dedicated-server-自适应参数" class="headerlink" title="6.6. 新增 innodb_dedicated_server 自适应参数"></a>6.6. 新增 innodb_dedicated_server 自适应参数</h3><p>8.0 版本新增 <code>innodb_dedicated_server</code>参数，能够让 InnoDB 根据服务器上检测到的内存大小自动配置 <code>innodb_buffer_pool_size</code>，<code>innodb_log_file_size</code> 等参数，会尽可能多的占用系统可占用资源提升性能。解决非专业人员安装数据库后默认初始化数据库参数默认值偏低的问题。<u><strong>但前提是服务器是专用来给 MySQL 数据库的，如果还有其他软件或者资源或者多实例 MySQL 使用，不建议开启该参数，不然会影响其它程序。</strong></u></p>
<h3 id="6-7-死锁检查控制"><a href="#6-7-死锁检查控制" class="headerlink" title="6.7. 死锁检查控制"></a>6.7. 死锁检查控制</h3><p>MySQL 8.0（MySQL 5.7.15）增加了一个新的动态变量 <code>innodb_deadlock_detect</code>，用于控制系统是否执行 InnoDB 死锁检查，默认是打开的。死锁检测会耗费数据库性能的，对于高并发的系统，可以关闭死锁检测功能，提高系统性能。但是要确保系统极少情况会发生死锁，同时要将锁等待超时参数调小一点，以防出现死锁等待过久的情况。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%innodb_deadlock_detect%&#x27;</span>;  <span class="comment">-- 默认值是ON，打开</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name          <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_deadlock_detect <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+-------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6-8-undo-文件不再使用系统表空间"><a href="#6-8-undo-文件不再使用系统表空间" class="headerlink" title="6.8. undo 文件不再使用系统表空间"></a>6.8. undo 文件不再使用系统表空间</h3><p>默认创建2个UNDO表空间，不再使用系统表空间。</p>
<p><img src="https://gitee.com/Bluetom/img2/raw/master/img20240905/202410251023031.png" alt=""></p>
<h3 id="6-9-binlog-日志过期时间精确到秒"><a href="#6-9-binlog-日志过期时间精确到秒" class="headerlink" title="6.9. binlog 日志过期时间精确到秒"></a>6.9. binlog 日志过期时间精确到秒</h3><p>在 8.0 版本之前，binlog 日志过期时间是通过 <code>expire_logs_days</code> 参数来设置，时间单位是“天”；而在 8.0 版本中，默认日志过期时间使用 <code>binlog_expire_logs_seconds</code> 参数（名称发生变化）来配置，并且单位为“秒”。</p>
<h3 id="6-10-默认字符集的变动"><a href="#6-10-默认字符集的变动" class="headerlink" title="6.10. 默认字符集的变动"></a>6.10. 默认字符集的变动</h3><p>在 8.0 版本之前，默认字符集为<code>latin1</code>，utf8 默认指向的是<code>utf8mb3</code>；8.0 版本默认字符集为<code>utf8mb4</code>，utf8 默认指向的也是<code>utf8mb4</code>。</p>
<h3 id="6-11-系统表的存储引擎的变动"><a href="#6-11-系统表的存储引擎的变动" class="headerlink" title="6.11. 系统表的存储引擎的变动"></a>6.11. 系统表的存储引擎的变动</h3><p>8.0 版本将系统表(mysql)和数据字典表全部改为 InnoDB 存储引擎，默认的 MySQL 实例将不包含 MyISAM 表，除非手动创建 MyISAM 表。</p>
<h3 id="6-12-元数据存储变动"><a href="#6-12-元数据存储变动" class="headerlink" title="6.12. 元数据存储变动"></a>6.12. 元数据存储变动</h3><p>MySQL 8.0删除了之前版本的元数据文件，例如表结构.frm等文件，全部集中放入mysql.ibd文件里。可以看见下图test库文件夹里已经没有了frm文件。</p>
<p><img src="https://gitee.com/Bluetom/img2/raw/master/img20240905/202410251023032.png" alt=""></p>
<h3 id="6-13-自增变量持久化"><a href="#6-13-自增变量持久化" class="headerlink" title="6.13. 自增变量持久化"></a>6.13. 自增变量持久化</h3><p>在 8.0 以前的版本，自增主键 AUTO_INCREMENT 的值如果大于<code>max(primary key)+1</code>，在 MySQL 重启后，会重置<code>AUTO_INCREMENT=max(primary key)+1</code>，这种现象在某些情况下会导致业务主键冲突或者其他难以发现的问题。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://bugs.mysql.com/bug.php?id=199">官网对于自增主键重启重置问题的说明</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"># <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>MySQL <span class="number">5.7</span>演示<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create table</span> t(id <span class="type">int</span> auto_increment <span class="keyword">primary key</span>,c1 <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t(c1) <span class="keyword">values</span>(<span class="string">&#x27;Laker1&#x27;</span>),(<span class="string">&#x27;Laker2&#x27;</span>),(<span class="string">&#x27;Laker3&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Laker3 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> exit;</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line"># 重启MySQL服务，并重新连接MySQL，此时自增主键 AUTO_INCREMENT 为 <span class="number">3</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t(c1) <span class="keyword">values</span>(<span class="string">&#x27;Laker4&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Laker4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> t <span class="keyword">set</span> id <span class="operator">=</span> <span class="number">5</span> <span class="keyword">where</span> c1 <span class="operator">=</span> <span class="string">&#x27;Laker1&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Laker4 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t(c1) <span class="keyword">values</span>(<span class="string">&#x27;Laker5&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Laker4 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Laker5 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t(c1) <span class="keyword">values</span>(<span class="string">&#x27;Laker6&#x27;</span>);</span><br><span class="line">ERROR <span class="number">1062</span> (<span class="number">23000</span>): Duplicate entry <span class="string">&#x27;5&#x27;</span> <span class="keyword">for</span> key <span class="string">&#x27;PRIMARY&#x27;</span></span><br></pre></td></tr></table></figure>
<p>在 8.0 版本将会对 AUTO_INCREMENT 值进行持久化，MySQL 重启后，该值将不会改变，从而解决以上问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span>MySQL <span class="number">8.0</span>演示<span class="operator">=</span><span class="operator">=</span><span class="operator">=</span><span class="operator">=</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create table</span> t(id <span class="type">int</span> auto_increment <span class="keyword">primary key</span>,c1 <span class="type">varchar</span>(<span class="number">20</span>));</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t(c1) <span class="keyword">values</span>(<span class="string">&#x27;Laker1&#x27;</span>),(<span class="string">&#x27;Laker2&#x27;</span>),(<span class="string">&#x27;Laker3&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Laker3 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> exit;</span><br><span class="line">Bye</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# service mysqld restart</span><br><span class="line">Shutting down MySQL.... SUCCESS<span class="operator">!</span> </span><br><span class="line">Starting MySQL... SUCCESS<span class="operator">!</span> </span><br><span class="line"></span><br><span class="line"># 重新连接MySQL</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t(c1) <span class="keyword">values</span>(<span class="string">&#x27;Laker4&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;  <span class="comment">--生成的id为4，不是3</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Laker4 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> t <span class="keyword">set</span> id <span class="operator">=</span> <span class="number">5</span> <span class="keyword">where</span> c1 <span class="operator">=</span> <span class="string">&#x27;Laker1&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Laker4 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t(c1) <span class="keyword">values</span>(<span class="string">&#x27;Laker5&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> c1     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Laker2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Laker4 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Laker1 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6</span> <span class="operator">|</span> Laker5 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6-14-DDL-操作原子化"><a href="#6-14-DDL-操作原子化" class="headerlink" title="6.14. DDL 操作原子化"></a>6.14. DDL 操作原子化</h3><p>MySQL 8.0 开始支持原子 DDL 操作，保证事务完整性，要么成功要么回滚。其中与表相关的原子 DDL 只支持 InnoDB 存储引擎。</p>
<ul>
<li>一个原子 DDL 操作内容包括：更新数据字典，存储引擎层的操作，在 binlog 中记录 DDL 操作。</li>
<li>支持与表相关的 DDL：数据库、表空间、表、索引的 CREATE、ALTER、DROP 以及 TRUNCATE TABLE。</li>
<li>支持的其它 DDL ：存储程序、触发器、视图、UDF 的 CREATE、DROP 以及ALTER 语句。</li>
<li>支持账户管理相关的 DDL：用户和角色的 CREATE、ALTER、DROP 以及适用的 RENAME等等。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># MySQL <span class="number">5.7</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_test <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> account        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employee       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t1             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> t1,t2;  <span class="comment">-- 删除表报错不会回滚，t1表会被删除</span></span><br><span class="line">ERROR <span class="number">1051</span> (<span class="number">42</span>S02): <span class="literal">Unknown</span> <span class="keyword">table</span> <span class="string">&#x27;test.t2&#x27;</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_test <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> account        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employee       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># MySQL <span class="number">8.0</span>  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_test <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> account        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employee       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t1             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> t1,t2;  <span class="comment">-- 删除表报错会回滚，t1表依然还在</span></span><br><span class="line">ERROR <span class="number">1051</span> (<span class="number">42</span>S02): <span class="literal">Unknown</span> <span class="keyword">table</span> <span class="string">&#x27;test.t2&#x27;</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;  </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_test <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> account        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employee       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t1             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6-15-参数修改持久化"><a href="#6-15-参数修改持久化" class="headerlink" title="6.15. 参数修改持久化"></a>6.15. 参数修改持久化</h3><p>MySQL 8.0 版本支持在线修改全局参数并持久化，通过加上 <code>PERSIST</code> 关键字，可以将修改的参数持久化到新的配置文件（mysqld-auto.cnf）中，重启 MySQL 时，可以从该配置文件获取到最新的配置参数。而通过<code>set global</code>命令设置的变量参数在 MySQL 重启后会失效。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> persist innodb_lock_wait_timeout<span class="operator">=</span><span class="number">25</span>;</span><br></pre></td></tr></table></figure>
<p>系统会在数据目录下生成一个 json 格式的 mysqld-auto.cnf 的文件，格式化后如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;mysql_server&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;innodb_lock_wait_timeout&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;Value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;25&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;Metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;Timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675290252103863</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;User&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<font color=red>**当 my.cnf 和 mysqld-auto.cnf 同时存在时，后者具有更高优先级。**</font>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://ktzxy.github.io">蓝桉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://ktzxy.github.io/posts/884c668c.html">https://ktzxy.github.io/posts/884c668c.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://ktzxy.github.io" target="_blank">蓝桉`Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><div class="post-share"><div class="social-share" data-image="/bg/Image00015.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">不给糖果就捣蛋</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" src="/img/wechat.webp" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src="/img/alipay.webp" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><audio id="coinAudio" src="https://cdn.cbd.int/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin/coin.js"></script><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/49de8711.html" title="MySQL-锁"><img class="cover" src="/bg/Image00027.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">MySQL-锁</div></div><div class="info-2"><div class="info-item-1">1. MySQL 锁机制概述锁是计算机协调多个进程或线程并发访问某一资源的机制（避免争抢）。在数据库中，除传统的计算资源（CPU、RAM、I/O）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。 加锁是实现数据库并发控制的一个非常重要的技术。当事务在对某个数据对象进行操作前，先向系统发出请求，对其加锁。加锁后事务就对该数据对象有了一定的控制，在该事务释放锁之前，其他的事务不能对此数据对象进行更新操作。 1.1. 锁的分类从性能的角度，可以分为以下两类：  乐观锁(用版本对比或CAS机制)：适合读操作较多的场景 悲观锁：适合写操作较多的场景   Tips: 如果在写操作较多的场景使用乐观锁会导致比对次数过多，影响性能  从数据操作的粒度，分为以下四类：  全局锁 表级锁 页级锁 行级锁  从对数据库（表）操作的类型，分为以下三类：  读锁（共享锁、S 锁(Shared)） 写锁（独占锁、排他锁、X 锁(eXclusive)） 意向锁（Intention Lock）   ...</div></div></div></a><a class="pagination-related" href="/posts/d97c3bd3.html" title="MySQL-索引"><img class="cover" src="/bg/Image00025.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">MySQL-索引</div></div><div class="info-2"><div class="info-item-1">1. 索引概述1.1. 什么是索引MySQL 官方对索引的定义为：索引（index）是帮助 MySQL 高效获取数据的数据结构（有序）。在数据之外，数据库系统还维护者满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。如下面的示意图所示：  **索引的本质是：一种数据结构** **索引的作用是：高效获取数据**     左边是数据表，一共有两列七条记录，最左边的是数据记录的物理地址（注意逻辑上相邻的记录在磁盘上也并不是一定物理相邻的）。为了加快Col2的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用二叉查找快速获取到相应数据。 一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上。索引是数据库中用来提高性能的最常用的工具。 1.2. 索引的优缺点1.2.1. 索引的优势 类似于书籍的目录索引，提高数据检索的效率，降低数据库的IO成本。 通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/a318ca1f.html" title="MySQL数据库150道高频面试题"><img class="cover" src="/bg/Image00018.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">MySQL数据库150道高频面试题</div></div><div class="info-2"><div class="info-item-1">[toc] 1. Mysql 索引1.1. Mysql如何实现的索引机制？MySQL中索引分三类：B+树索引、Hash索引、全文索引 1.1.1. InnoDB索引与MyISAM索引实现的区别是什么？ MyISAM的索引方式都是非聚簇的，与InnoDB包含1个聚簇索引是不同的。 在InnoDB存储引擎中，我们只需要根据主键值对聚簇索引进行一次查找就能找到对应的记录，而在MyISAM中却需要进行一次回表操作，意味着MyISAM中建立的索引相当于全部都是二级索引。 InnoDB的数据文件本身就是索引文件，而MyISAM索引文件和数据文件是分离的 ，索引文件仅保存数据记录的地址。 MyISAM的表在磁盘上存储在以下文件中：  *.sdi（描述表结构）、*.MYD（数据），*.MYI（索引） InnoDB的表在磁盘上存储在以下文件中： .ibd（表结构、索引和数据都存在一起）   InnoDB的非聚簇索引data域存储相应记录主键的值 ，而MyISAM索引记录的是地址 。换句话说，InnoDB的所有非聚簇索引都引用主键作为data域。 MyISAM的回表操作是十分快速的，因为是拿着地址偏...</div></div></div></a><a class="pagination-related" href="/posts/8f9b37aa.html" title="技术同学必会的MySQL设计规约"><img class="cover" src="/bg/Image00014.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">技术同学必会的MySQL设计规约</div></div><div class="info-2"><div class="info-item-1">在我们对数据库技术方案设计的时候，我们是否有自己的设计理念或者原则，还是更多的依据自己的直觉去设计，是否曾经懊悔线上发生过的一次低级故障，可能稍微注意点就可以避免，是否想过怎么才能很好的避免，下面规范的价值正是我们工作的检查清单，需要我们不断从错误中积累有效经验来指导未来的工作。以下规范在大型互联网公司经过了充分的验证，尤其适用于并发量大、数据量大的业务场景。先介绍的是安全规范，因为安全无小事，很多公司都曾经因为自己的数据泄露导致用户的惨痛损失，所以将安全规范放到了第一位。﻿ 一、安全规范1.【强制】禁止在数据库中存储明文密码，需把密码加密后存储 说明：对于加密操作建议由公司的中间件团队基于如mybatis的扩展，提供统一的加密算法及密钥管理，避免每个业务线单独开发一套，同时也与具体的业务进行了解耦 2.【强制】禁止在数据库中明文存储用户敏感信息，如手机号等 说明：对于手机号建议公司搭建统一的手机号查询服务，避免在每个业务线单独存储 3.【强制】禁止开发直接给业务同学导出或者查询涉及到用户敏感信息的数据，如需要需上级领导审批 4.【强制】涉及到导出数据功能的操作，如包含敏感字段都...</div></div></div></a><a class="pagination-related" href="/posts/dfdfdf4.html" title="数据库概述"><img class="cover" src="/bg/Image00002.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">数据库概述</div></div><div class="info-2"><div class="info-item-1">1. 数据库技术1.1. 概述数据库（DB）是一个以某种组织方式存储在磁盘上的数据的集合。简单理解就是用来存储数据的仓库。  数据库 DataBase（DB）：存储数据的仓库，数据是有组织的进行存储。 数据库管理系统 DataBase Management System (DBMS)：操纵和管理数据库的大型软件。  1.2. 数据库的分类  1.3. 不同的数据存储方式数据存储在集合（内存）中  优点：读写速度快 缺点：不能永久存储  数据存储在文件中  优点：可以永久存储 缺点：频繁的IO操作效率低，查询数据很不方便。  数据存储在数据库中  优点：可以永久存储。查询速度快，查询数据很方便 缺点：要使用 SQL 语言执行增删改查操作  2. 关系型数据库 关系型数据库 - 百度百科  2.1. 概念关系型数据库，是指采用了关系模型来组织数据的数据库，其以行和列的形式存储数据，以便于用户理解，关系型数据库这一系列的行和列被称为表，一组表组成了数据库。用户通过查询来检索数据库中的数据，而查询是一个用于限定数据库中某些区域的执行代码。关系模型可以简单理解为二维表格模型，而一个关系型数...</div></div></div></a><a class="pagination-related" href="/posts/75522c08.html" title="第4节-布隆过滤器"><img class="cover" src="/bg/Image00003.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">第4节-布隆过滤器</div></div><div class="info-2"><div class="info-item-1">第4节-布隆过滤器BloomFilter面试题： 现有50亿个电话号码，选定其中10w个电话号码，如何要快速准确的判断这些号码是否已经存在？ 思路：  1、通过数据库查询———-实现快速有点难。  2、数据预放到内存集合中：50亿*8字节大约40G，内存太大了。 1、布隆过滤器是什么？它实际上==是一个很长的二进制数组+一系列随机hash算法映射函数，主要用于判断一个元素是否在集合中==。 通常我们会遇到很多要判断一个元素是否在某个集合中的业务场景，一般想到的是将集合中所有元素保存起来，然后通过比较确定。 链表、树、散列表（又叫哈希表，Hash table）等等数据结构都是这种思路。 但是随着集合中元素的增加，我们需要的存储空间也会呈现线性增长，最终达到瓶颈。 同时检索速度也越来越慢，上述三种结构的检索时间复杂度分别为O(n),O(logn),O(1)。这个时候，布隆过滤器（Bloom Filter）就应运而生  一句话概述：由一个初值为零的bit数组和多个哈希函数构成，用来快速判断某个数据是否存在。 本质就是判断具体元素存不存在一个大的集合中。 布隆过滤器是一种类似set的数据...</div></div></div></a><a class="pagination-related" href="/posts/e4cd3c5b.html" title="第5节-缓存预热+缓存雪崩+缓存击穿+缓存穿透"><img class="cover" src="/bg/Image00008.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">第5节-缓存预热+缓存雪崩+缓存击穿+缓存穿透</div></div><div class="info-2"><div class="info-item-1">第5节-缓存预热+缓存雪崩+缓存击穿+缓存穿透1、缓存雪崩发生情况： ​    redis主机挂了，redis全盘崩溃，比如缓存中有大量数据同时过期。 解决方案：  redis缓存集群实现高可用，主从+哨兵|| redis cluster ehcache本地缓存 + hystrix 或者 阿里sentinel限流&amp;降级 开启Redis持久化机制/aof+rdb，尽快恢复缓存集群 2、缓存穿透 什么是缓存穿透  请求去查询一条记录，先redis后mysql发现，都查不到该条记录，但是每次请求都会打到数据库上面去，导致后台数据库压力暴增，这种现象我们称为缓存穿透，redis成为了一个摆设。 简单说就是，本来无一物，即不再redis中，也不在mysql中。  危害  数据库可能会被打崩。导致服务不可用。 第一次来查询后，一般我们会有回写redis机制， 第二次来查询的时候redis就有了，偶尔出现穿透现象一般情况无关紧要。  解决方案   1、返回空对象缓存或者缺省值 一般OK  但是存在黑客和恶意攻击情况 黑客会对你的系统进行攻击，拿到一个不存在的id，去查询数据，会产生大量...</div></div></div></a><a class="pagination-related" href="/posts/41ae0132.html" title="MongoDB-基础"><img class="cover" src="/bg/Image00026.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">MongoDB-基础</div></div><div class="info-2"><div class="info-item-1">1. MongoDb 概述MongoDB 是一个跨平台的，面向文档的数据库，是当前 NoSQL 数据库产品中最热门的一种。它介于关系数据库和非关系数据库之间，是非关系数据库当中功能最丰富，最像关系数据库的产品。它支持的数据结构非常松散，是类似 JSON 的 BSON 格式，因此可以存储比较复杂的数据类型。 1.1. MongoDB 特点MongoDB 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。它是一个面向集合的，模式自由的文档型数据库，具体特点总结如下：  面向集合存储，易于存储对象类型的数据 模式自由 支持动态查询 支持完全索引，包含内部对象 支持复制和故障恢复 使用高效的二进制数据存储，包括大型对象（如视频等） 自动处理碎片，以支持云计算层次的扩展性 支持 Python，PHP，Ruby，Java，C，C#，Javascript，Perl 及 C++语言的驱动程序，社区中也提供了对 Erlang 及.NET 等平台的驱动程序 文件存储格式为 BSON（一种 JSON 的...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">蓝桉</div><div class="author-info-description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">生活、学习、技术</b>相关的问题和看法，还有<b style="color:#fff">文章教程</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">264</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ktzxy"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon faa-parent animated-hover" href="https://github.com/ktzxy" target="_blank" title="Github"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-github"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=2251511764@qq.com" target="_blank" title="Email"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"></use></svg></a><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-RSS"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/496148176" target="_blank" title="BiliBili"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QX-BILIBILI"></use></svg></a><a class="social-icon faa-parent animated-hover" href="tencent://Message/?Uin=2251511764&amp;amp;websiteName=local.edu.com:8888=&amp;amp;Menu=yes" target="_blank" title="QQ"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QQ"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MySQL-%E7%9A%84%E8%A7%86%E5%9B%BE"><span class="toc-number">1.</span> <span class="toc-text">1. MySQL 的视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%AE%80%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1.1. 简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%A7%86%E5%9B%BE%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">1.2. 视图的语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.2.1. 创建视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E6%9F%A5%E8%AF%A2%E8%A7%86%E5%9B%BE"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2.2. 查询视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.2.3. 修改视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-%E9%87%8D%E5%91%BD%E5%90%8D%E8%A7%86%E5%9B%BE"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.2.4. 重命名视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-5-%E5%88%A0%E9%99%A4%E8%A7%86%E5%9B%BE"><span class="toc-number">1.2.5.</span> <span class="toc-text">1.2.5. 删除视图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%9B%B4%E6%96%B0%E8%A7%86%E5%9B%BE"><span class="toc-number">1.3.</span> <span class="toc-text">1.3. 更新视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%A3%80%E6%9F%A5%E9%80%89%E9%A1%B9"><span class="toc-number">1.4.</span> <span class="toc-text">1.4. 检查选项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-CASCADED"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.4.1. CASCADED</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-LOCAL"><span class="toc-number">1.4.2.</span> <span class="toc-text">1.4.2. LOCAL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E8%A7%86%E5%9B%BE%E8%BF%90%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">1.5. 视图运用案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-%E8%A7%86%E5%9B%BE%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.</span> <span class="toc-text">1.6. 视图总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-1-%E8%A7%86%E5%9B%BE%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.6.1.</span> <span class="toc-text">1.6.1. 视图的优缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-2-%E8%A7%86%E5%9B%BE%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.6.2.</span> <span class="toc-text">1.6.2. 视图的特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-3-%E8%A7%86%E5%9B%BE%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.6.3.</span> <span class="toc-text">1.6.3. 视图的使用场景</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">2. 存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%AE%80%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">2.1. 简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">2.2. 存储过程基础语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1. 创建存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E8%B0%83%E7%94%A8%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2. 调用存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E6%9F%A5%E7%9C%8B%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3. 查看存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-%E5%88%A0%E9%99%A4%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4. 删除存储过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.</span> <span class="toc-text">2.3. 变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1. 系统变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E7%94%A8%E6%88%B7%EF%BC%88%E4%BC%9A%E8%AF%9D%EF%BC%89%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2. 用户（会话）定义变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3. 局部变量</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-1-%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E8%AF%AD%E6%B3%95"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">2.3.3.1. 变量定义语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-2-%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC%E8%AF%AD%E6%B3%95"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">2.3.3.2. 变量赋值语法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.</span> <span class="toc-text">2.4. 存储过程的参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-in-%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1. in 类型参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-out-%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2. out 类型参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-inout-%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.3.</span> <span class="toc-text">2.4.3. inout 类型参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6-if-%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="toc-number">2.5.</span> <span class="toc-text">2.5. 流程控制 - if 条件判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6-case-%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="toc-number">2.6.</span> <span class="toc-text">2.6. 流程控制 - case 条件判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6-%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.7.</span> <span class="toc-text">2.7. 流程控制 - 循环</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-1-%E7%AE%80%E8%BF%B0"><span class="toc-number">2.7.1.</span> <span class="toc-text">2.7.1. 简述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-2-while-%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.7.2.</span> <span class="toc-text">2.7.2. while 循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-3-repeat-%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.7.3.</span> <span class="toc-text">2.7.3. repeat 循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-4-loop-%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.7.4.</span> <span class="toc-text">2.7.4. loop 循环</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E6%B8%B8%E6%A0%87"><span class="toc-number">2.8.</span> <span class="toc-text">2.8. 游标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-1-%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-number">2.8.1.</span> <span class="toc-text">2.8.1. 基础语法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-HANDLER-%E6%9D%A1%E4%BB%B6%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.9.</span> <span class="toc-text">2.9. 异常处理 - HANDLER 条件处理程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-1-%E8%AF%AD%E6%B3%95%E5%AE%9A%E4%B9%89"><span class="toc-number">2.9.1.</span> <span class="toc-text">2.9.1. 语法定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-2-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BD%BF%E7%94%A8-handler"><span class="toc-number">2.9.2.</span> <span class="toc-text">2.9.2. 存储过程中使用 handler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%99%BB%E9%99%86%E7%94%A8%E6%88%B7"><span class="toc-number">2.10.</span> <span class="toc-text">2.10. 获取当前登陆用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-%E6%9F%A5%E8%AF%A2%E6%9C%80%E5%90%8E%E6%8F%92%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9A%84id"><span class="toc-number">2.11.</span> <span class="toc-text">2.11. 查询最后插入的数据的id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.12.</span> <span class="toc-text">2.12. 存储过程综合示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-13-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="toc-number">2.13.</span> <span class="toc-text">2.13. 存储过程优化思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">3. 存储函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">3.1. 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%88%9B%E5%BB%BA%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">3.2. 创建语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%B3%A8%E6%84%8F%E9%97%AE%E9%A2%98"><span class="toc-number">3.3.</span> <span class="toc-text">3.3. 注意问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0%E4%B8%8E%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">3.4.</span> <span class="toc-text">3.4. 存储函数与存储过程的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">4. 触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">4.1.</span> <span class="toc-text">4.1. 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">4.2. 触发器的特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%A7%A6%E5%8F%91%E5%99%A8%E8%AF%AD%E6%B3%95%E5%AE%9A%E4%B9%89"><span class="toc-number">4.3.</span> <span class="toc-text">4.3. 触发器语法定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-%E5%88%9B%E5%BB%BA%E8%AF%AD%E6%B3%95"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1. 创建语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-%E6%93%8D%E4%BD%9C%E5%85%B3%E9%94%AE%E5%AD%97-NEW-OLD"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2. 操作关键字 (NEW|OLD)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-%E6%9F%A5%E7%9C%8B%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">4.3.3.</span> <span class="toc-text">4.3.3. 查看触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-4-%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">4.3.4.</span> <span class="toc-text">4.3.4. 删除触发器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E8%A7%A6%E5%8F%91%E5%99%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.4.</span> <span class="toc-text">4.4. 触发器注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%86%E5%8C%BA%E8%A1%A8-%E4%BA%86%E8%A7%A3"><span class="toc-number">5.</span> <span class="toc-text">5. 分区表(了解)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">5.1.</span> <span class="toc-text">5.1. 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%88%86%E5%8C%BA%E8%A1%A8%E7%9A%84%E4%BC%98%E7%82%B9%E4%B8%8E%E9%99%90%E5%88%B6"><span class="toc-number">5.2.</span> <span class="toc-text">5.2. 分区表的优点与限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%88%86%E5%8C%BA%E8%A1%A8%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">5.3. 分区表的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%88%86%E5%8C%BA%E8%A1%A8%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.4.</span> <span class="toc-text">5.4. 分区表的类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-MySQL-%E6%94%AF%E6%8C%81%E7%9A%84%E5%88%86%E5%8C%BA%E8%A1%A8"><span class="toc-number">5.4.1.</span> <span class="toc-text">5.4.1. MySQL 支持的分区表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E5%88%86%E5%8C%BA"><span class="toc-number">5.4.2.</span> <span class="toc-text">5.4.2. 查询数据库表是否支持分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-3-%E5%88%86%E5%8C%BA%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">5.4.3.</span> <span class="toc-text">5.4.3. 分区的基本语法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E4%B8%8D%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8-mysql-%E5%88%86%E5%8C%BA%E8%A1%A8"><span class="toc-number">5.5.</span> <span class="toc-text">5.5. 不建议使用 mysql 分区表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Mysql-8-0-%E6%96%B0%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3"><span class="toc-number">6.</span> <span class="toc-text">6. Mysql 8.0 新特性详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%96%B0%E5%A2%9E%E9%99%8D%E5%BA%8F%E7%B4%A2%E5%BC%95"><span class="toc-number">6.1.</span> <span class="toc-text">6.1. 新增降序索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-group-by-%E4%B8%8D%E5%86%8D%E9%9A%90%E5%BC%8F%E6%8E%92%E5%BA%8F"><span class="toc-number">6.2.</span> <span class="toc-text">6.2. group by 不再隐式排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%A2%9E%E5%8A%A0%E9%9A%90%E8%97%8F%E7%B4%A2%E5%BC%95"><span class="toc-number">6.3.</span> <span class="toc-text">6.3. 增加隐藏索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E6%96%B0%E5%A2%9E%E5%87%BD%E6%95%B0%E7%B4%A2%E5%BC%95"><span class="toc-number">6.4.</span> <span class="toc-text">6.4. 新增函数索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-innodb-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%8F%AF%E8%B7%B3%E8%BF%87%E9%94%81%E7%AD%89%E5%BE%85"><span class="toc-number">6.5.</span> <span class="toc-text">6.5. innodb 存储引擎可跳过锁等待</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E6%96%B0%E5%A2%9E-innodb-dedicated-server-%E8%87%AA%E9%80%82%E5%BA%94%E5%8F%82%E6%95%B0"><span class="toc-number">6.6.</span> <span class="toc-text">6.6. 新增 innodb_dedicated_server 自适应参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E6%AD%BB%E9%94%81%E6%A3%80%E6%9F%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">6.7.</span> <span class="toc-text">6.7. 死锁检查控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-undo-%E6%96%87%E4%BB%B6%E4%B8%8D%E5%86%8D%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="toc-number">6.8.</span> <span class="toc-text">6.8. undo 文件不再使用系统表空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-9-binlog-%E6%97%A5%E5%BF%97%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%E7%B2%BE%E7%A1%AE%E5%88%B0%E7%A7%92"><span class="toc-number">6.9.</span> <span class="toc-text">6.9. binlog 日志过期时间精确到秒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-10-%E9%BB%98%E8%AE%A4%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E5%8F%98%E5%8A%A8"><span class="toc-number">6.10.</span> <span class="toc-text">6.10. 默认字符集的变动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-11-%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E5%8F%98%E5%8A%A8"><span class="toc-number">6.11.</span> <span class="toc-text">6.11. 系统表的存储引擎的变动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-12-%E5%85%83%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%8F%98%E5%8A%A8"><span class="toc-number">6.12.</span> <span class="toc-text">6.12. 元数据存储变动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-13-%E8%87%AA%E5%A2%9E%E5%8F%98%E9%87%8F%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.13.</span> <span class="toc-text">6.13. 自增变量持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-14-DDL-%E6%93%8D%E4%BD%9C%E5%8E%9F%E5%AD%90%E5%8C%96"><span class="toc-number">6.14.</span> <span class="toc-text">6.14. DDL 操作原子化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-15-%E5%8F%82%E6%95%B0%E4%BF%AE%E6%94%B9%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.15.</span> <span class="toc-text">6.15. 参数修改持久化</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/a318ca1f.html" title="MySQL数据库150道高频面试题"><img src="/bg/Image00018.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL数据库150道高频面试题"/></a><div class="content"><a class="title" href="/posts/a318ca1f.html" title="MySQL数据库150道高频面试题">MySQL数据库150道高频面试题</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8f9b37aa.html" title="技术同学必会的MySQL设计规约"><img src="/bg/Image00014.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="技术同学必会的MySQL设计规约"/></a><div class="content"><a class="title" href="/posts/8f9b37aa.html" title="技术同学必会的MySQL设计规约">技术同学必会的MySQL设计规约</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/dfdfdf4.html" title="数据库概述"><img src="/bg/Image00002.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据库概述"/></a><div class="content"><a class="title" href="/posts/dfdfdf4.html" title="数据库概述">数据库概述</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/490575ab.html" title="24工厂模式俗话解释"><img src="/bg/Image00024.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="24工厂模式俗话解释"/></a><div class="content"><a class="title" href="/posts/490575ab.html" title="24工厂模式俗话解释">24工厂模式俗话解释</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/364ea8cc.html" title="设计模式"><img src="/bg/Image00014.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式"/></a><div class="content"><a class="title" href="/posts/364ea8cc.html" title="设计模式">设计模式</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2020 - 2025 By 蓝桉</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="8152976493" data-server="netease" data-type="playlist"   data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true" ></div><script async src="//at.alicdn.com/t/c/font_4379924_273fk05h86zi.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/cat/cat.js"></script><script async data-pjax src="/js/meting/music_lanan.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script defer src="/js/day/lunar.js"></script><script defer src="/js/day/day.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = '10a7db1c41b6489db9c830c668a18304';
  var gaud_map_key = '82a64bc994fb6494830f157f319f9f69';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.2.2" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="本站使用JsDelivr为静态资源提供CDN加速" title=""><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime/runtime.min.js"></script><script async src="/js/font/ali_font_all.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>