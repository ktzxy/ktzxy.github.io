<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>nginx学习 | 蓝桉`Blog</title><meta name="author" content="蓝桉,kt_zxh@163.com"><meta name="copyright" content="蓝桉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Nginx服务端404以及502等页面配置进入nginx.conf配置文件:1vi &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf 新手请记得备份一下再操作。 添加页面重定向http内添加一行 fastcgi_intercept_errors on; 开启页面重定向功能。12345678910111213http &#123;    include       mime.type">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx学习">
<meta property="og:url" content="https://ktzxy.github.io/posts/5b3c514b.html">
<meta property="og:site_name" content="蓝桉&#96;Blog">
<meta property="og:description" content="Nginx服务端404以及502等页面配置进入nginx.conf配置文件:1vi &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf 新手请记得备份一下再操作。 添加页面重定向http内添加一行 fastcgi_intercept_errors on; 开启页面重定向功能。12345678910111213http &#123;    include       mime.type">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ktzxy.github.io/bg/Image00010.webp">
<meta property="article:published_time" content="2025-07-09T17:28:45.000Z">
<meta property="article:modified_time" content="2025-07-13T15:45:18.536Z">
<meta property="article:author" content="蓝桉">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ktzxy.github.io/bg/Image00010.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "nginx学习",
  "url": "https://ktzxy.github.io/posts/5b3c514b.html",
  "image": "https://ktzxy.github.io/bg/Image00010.webp",
  "datePublished": "2025-07-09T17:28:45.000Z",
  "dateModified": "2025-07-13T15:45:18.536Z",
  "author": [
    {
      "@type": "Person",
      "name": "蓝桉",
      "url": "https://ktzxy.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ktzxy.github.io/posts/5b3c514b.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'nginx学习',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4379924_273fk05h86zi.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/progress_bar/progress_bar.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/windmill/windmill.css"><link rel="stylesheet" href="/css/cat.css"><link rel="stylesheet" href="/css/meting/music_lanan.css"><div id="myscoll"></div><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="/css/runtime/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="蓝桉`Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/bg.webp);"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">264</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-zhuye-"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhuye-"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-shijianzhou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijianzhou"></use></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/essay/"><i class="fa-fw icon-xiaoxi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiaoxi"></use></svg><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/"><i class="fa-fw icon-music"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/fcircle/"><i class="fa-fw icon-pengyouquan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan"></use></svg><span> 朋友圈</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:randomPost();"><i class="fa-fw icon-wodezhuifan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wodezhuifan"></use></svg><span> 随机访问</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-guanyuwomen2"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyuwomen2"></use></svg><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/bg/Image00010.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">蓝桉`Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">nginx学习</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-zhuye-"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhuye-"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-shijianzhou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shijianzhou"></use></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/essay/"><i class="fa-fw icon-xiaoxi"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiaoxi"></use></svg><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/"><i class="fa-fw icon-music"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-music"></use></svg><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/fcircle/"><i class="fa-fw icon-pengyouquan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-pengyouquan"></use></svg><span> 朋友圈</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:randomPost();"><i class="fa-fw icon-wodezhuifan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wodezhuifan"></use></svg><span> 随机访问</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-guanyuwomen2"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyuwomen2"></use></svg><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">nginx学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-09T17:28:45.000Z" title="发表于 2025-07-09 17:28:45">2025-07-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-13T15:45:18.536Z" title="更新于 2025-07-13 15:45:18">2025-07-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/nginx/">nginx</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Nginx服务端404以及502等页面配置"><a href="#Nginx服务端404以及502等页面配置" class="headerlink" title="Nginx服务端404以及502等页面配置"></a>Nginx服务端404以及502等页面配置</h1><h4 id="进入nginx-conf配置文件"><a href="#进入nginx-conf配置文件" class="headerlink" title="进入nginx.conf配置文件:"></a>进入nginx.conf配置文件:</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>新手请记得备份一下再操作。</p>
<h4 id="添加页面重定向"><a href="#添加页面重定向" class="headerlink" title="添加页面重定向"></a>添加页面重定向</h4><h4 id="http内添加一行-fastcgi-intercept-errors-on-开启页面重定向功能。"><a href="#http内添加一行-fastcgi-intercept-errors-on-开启页面重定向功能。" class="headerlink" title="http内添加一行 fastcgi_intercept_errors on; 开启页面重定向功能。"></a><code>http</code>内添加一行 <code>fastcgi_intercept_errors on;</code> 开启页面重定向功能。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    # 404 500</span><br><span class="line">    fastcgi_intercept_errors on;</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<h4 id="server-内添加页面指向"><a href="#server-内添加页面指向" class="headerlink" title="server 内添加页面指向"></a><code>server</code> 内添加页面指向</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        # 假如服务器ip是192.168.10.125，则访问 192.168.10.125 实际访问的目录是：/usr/local/nginx/html/index.html</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            proxy_pass http://127.0.0.1:3000;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 配置 404 状态页面指向，指向的是：root 中的 html 的绝对路径是 /usr/local/nginx/html/404.html 文件</span><br><span class="line">        error_page  404              /404.html;</span><br><span class="line">        location = /404.html &#123;</span><br><span class="line">            root html;</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br><span class="line">		error_page   500  /500.html;</span><br><span class="line">        location = /500.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   502   /502.html;</span><br><span class="line">        location = /502.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br></pre></td></tr></table></figure>
<h4 id="检查nginx配置文件是否准确"><a href="#检查nginx配置文件是否准确" class="headerlink" title="检查nginx配置文件是否准确"></a>检查nginx配置文件是否准确</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -t</span><br></pre></td></tr></table></figure>
<h4 id="重启nginx"><a href="#重启nginx" class="headerlink" title="重启nginx"></a>重启nginx</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="访问服务失败"><a href="#访问服务失败" class="headerlink" title="访问服务失败"></a>访问服务失败</h3><p>访问服务器ip时，失败，通过<code>tail -n 5  /usr/local/nginx/logs/error.log</code>查看nginx错误日志发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2019/01/29 16:01:10 [error] 4351#0: *21 connect() failed (111: Connection refused) while connecting to ups</span><br><span class="line">tream, client: xxx.xxx.xxx.xxx, server: localhost, request: &quot;GET / HTTP/1.1&quot;, upstream: &quot;http://127.0.0.1:3</span><br><span class="line">000/&quot;, host: &quot;xxx.xxx.xxx.xxx:80&quot;</span><br></pre></td></tr></table></figure>
<p>原因可能是：</p>
<h4 id="php-fpm没有安装"><a href="#php-fpm没有安装" class="headerlink" title="php-fpm没有安装"></a>php-fpm没有安装</h4><p>新买的阿里云服务器 就属于这种情况,有nginx，但是没安装php-fpm<br>这种情况下可参考<br>centos安装php php-fpm 以及 配置nginx</p>
<h3 id="Nginx的页面乱码解决方法"><a href="#Nginx的页面乱码解决方法" class="headerlink" title="Nginx的页面乱码解决方法"></a>Nginx的页面乱码解决方法</h3><p>在server段里加字符集配置：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">default_type &#x27;text/html&#x27;;</span><br><span class="line">charset utf-8;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">检查:</span><br><span class="line">/usr/local/nginx/sbin/nginx -t</span><br><span class="line"></span><br><span class="line">重启:</span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>
<h1 id="Nginx实现虚拟主机、反向代理、负载均衡、高可用"><a href="#Nginx实现虚拟主机、反向代理、负载均衡、高可用" class="headerlink" title="Nginx实现虚拟主机、反向代理、负载均衡、高可用"></a>Nginx实现虚拟主机、反向代理、负载均衡、高可用</h1><h2 id="一-虚拟主机"><a href="#一-虚拟主机" class="headerlink" title="一 虚拟主机"></a>一 虚拟主机</h2><p>概念： </p>
<p>​        虚拟主机是一种特殊的模拟硬件的软件技术，它可以将网络上的一台物理计算机映射成多个虚拟主机，每个虚拟主机可以独立对外提供www服务，这样就可以实现一台物理主机对外提供多个web服务了。并且每个虚拟主机之间是独立的，互不影响的。</p>
<p>nginx支持三种类型的虚拟主机配置：</p>
<ul>
<li>1、基于ip的虚拟主机</li>
<li>2、基于域名的虚拟主机 </li>
<li>3、基于端口的虚拟主机</li>
</ul>
<p>这里我们主要讲一下基于域名的虚拟主机配置，也是使用最多的。</p>
<h3 id="基于域名的虚拟主机配置"><a href="#基于域名的虚拟主机配置" class="headerlink" title="基于域名的虚拟主机配置"></a>基于域名的虚拟主机配置</h3><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>两个域名都指向一台机器， 使用不同的域名访问会得到不同的内容。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ul>
<li>使用一台虚拟机作为物理机。</li>
<li>使用两个域名：www.szlocal1.com、www.szlocal2.com</li>
<li>分别为两个域名创建访问资源目录：  usr/local/szlocal1/index.html、usr/local/szlocal2/index.html</li>
</ul>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p><strong>虚拟主机配置</strong></p>
<p>在<code>/usr/local/nginx/conf/nginx.conf</code>文件，添加两个虚拟主机，即添加两个server配置项：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加szlocal1</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  www.szlocal1.com;</span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">root</span>   /usr/local/szlocal1;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加szlocal2</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  www.szlocal2.com;</span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">root</span>   /usr/local/szlocal2;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>在宿主机中访问</strong></p>
<p>​        这样我们的基于域名的虚拟主机就配置好了，但是在浏览中会访问不到，因为DNS服务器中并没有我们刚配置的的两个域名，我们要模拟的话，可以配置我们宿主机的hosts文件，windows系统hosts所在的路径是： </p>
<p><code>C:\Windows\System32\drivers\etc</code></p>
<p>在hosts文件中添加以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.75.135 www.szlocal1.com</span><br><span class="line">192.168.75.135 www.szlocal2.com</span><br></pre></td></tr></table></figure>
<p>在浏览器中访问www.szlocal1.com、www.szlocal2.com，即可分别看到页面输出： szlocal1、szlocal2</p>
<h2 id="二-反向代理"><a href="#二-反向代理" class="headerlink" title="二 反向代理"></a>二 反向代理</h2><p>概念：</p>
<p>​        <strong>反向代理</strong>（Reverse Proxy）：指以代理服务器来接受internet上的连接请求，然后将请求转发给==内部网络==上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。==反向代理，客户端并不知道目标资源在哪里，主动权也不在客户端==。</p>
<p>​        反向代理特点： 保护和隐藏原始资源服务器。</p>
<p>​        <strong>正向代理</strong>：和反向代理不同之处在于，典型的==正向代理是一种用户知道目标地址并主动使用的代理方式==。例如Chrome浏览器中安装了switchysharp以后，通过switchysharp方便地进行代理转发服务。而为此用户必须要提前在switchysharp中做好设置才能达到相应的效果。</p>
<h3 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h3><p>在一台虚拟机中使用nginx配置反向代理，代理到tomcat服务。</p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>一台虚拟机：192.168.75.135</p>
<p>安装了nginx、tomcat</p>
<p>需要使用虚拟主机的配置，这里增加一个配置为 www.szlocal3.com</p>
<h3 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h3><p>在<code>/usr/local/nginx/conf/nginx.conf</code>文件，添加一个server配置项，并且增加==proxy_pass（反向代理）==的配置。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加szlocal3 虚拟主机</span></span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  www.szlocal3.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">			<span class="attribute">proxy_pass</span> http://localhost:8080;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在宿主机windows的hosts配置: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.75.135 www.szlocal3.com</span><br></pre></td></tr></table></figure>
<p>然后浏览器访问： www.szlocal3.com 即可。</p>
<p>说明： 访问www.szlocal3.com时，是监听了80端口，然后反向代理到了该机器的8080端口。用户并不知道资源在8080的tomcat服务中。</p>
<h2 id="三-负载均衡"><a href="#三-负载均衡" class="headerlink" title="三 负载均衡"></a>三 负载均衡</h2><p>概念：</p>
<p>​        负载均衡（Load Balance，LB）：意思是当一台机器支撑不住访问流量的时候，可以通过水平扩展、增加廉价的机器设备来分担访问请求。</p>
<p>​        举个栗子：假设你开发了一个web应用，使用的是单机的tomcat，并发请求仅仅能支撑400，做活动期间达到了900的请求，这时候，一台机器搞不定，就需要再扩展2台，可以支撑1200的请求，最开始的1台+后面的2台就可以分摊请求，达到负载均衡的目的。</p>
<p>​        所以说，负载均衡可以增加系统的吞吐。</p>
<p>Nginx就是一个负载均衡服务器：</p>
<blockquote>
<p>数据转发功能，为nginx提供了跨越单机的横向处理能力，使nginx摆脱只能为终端节点提供单一功能的限制，而使它具备了网路应用级别的拆分、封装和整合的战略功能。在云模型大行其道的今天，数据转发是nginx有能力构建一个网络应用的关键组件。</p>
</blockquote>
<p>Nginx中upstream模块就拥有数据转发功能，实现负载均衡。upstream不产生自己的内容，而是通过请求后端服务器得到内容，所以才称为upstream（上游）。upstream按照轮询（默认）方式进行负载，每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>
<p>Nginx负载均衡配置步骤：</p>
<ol>
<li>在http节点添加upstream节点，如：</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置当前机器为upstream配置列表中服务的上游节点（意思是一个nginx可以是多个应用服务的上游节点）</span></span><br><span class="line"><span class="section">upstream</span> myapp&#123;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.75.130:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.75.134:8080</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>在server节点下的location节点中添加 proxy_pass 配置项， 格式：  proxy_pass  <a target="_blank" rel="noopener" href="http://upstream后面的名字">http://upstream后面的名字</a></li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加szlocal4 虚拟主机</span></span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">		<span class="comment"># 虚拟主机</span></span><br><span class="line">        <span class="attribute">server_name</span>  www.szlocal4.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">			<span class="attribute">root</span>   html;</span><br><span class="line">			<span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">			<span class="comment"># 反向代理到upstream</span></span><br><span class="line">			<span class="attribute">proxy_pass</span> http://myapp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h3><p>实现一个简单的负载均衡，访问www.szlocal4.com，会在两台机器之间来回切换。</p>
<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><ul>
<li>需要设置基于域名的虚拟主机www.szlocal4.com</li>
<li>负载均衡使用 upstream</li>
<li>结合反向代理 proxy_pass </li>
</ul>
<h3 id="实战-2"><a href="#实战-2" class="headerlink" title="实战"></a>实战</h3><ol>
<li><p>在192.168.75.130、192.168.75.134 两台虚拟机中开启tomcat服务, tomcat版本号不一致，便于后面访问时观察页面变化。</p>
</li>
<li><p>在Nginx负载均衡服务器中配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在http节点中配置</span></span><br><span class="line"><span class="section">upstream</span> myapp&#123;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.75.130:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.75.134:8080</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置一个server节点，配置了虚拟主机www.szlocal4.com ;  并且反向代理结合upstream的名字myapp。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加szlocal4 虚拟主机</span></span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">		<span class="comment"># 虚拟主机</span></span><br><span class="line">        <span class="attribute">server_name</span>  www.szlocal4.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">			<span class="attribute">root</span>   html;</span><br><span class="line">			<span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">			<span class="comment"># 反向代理到upstream，这样访问www.szlocal4.com前先访问其上游节点</span></span><br><span class="line">			<span class="attribute">proxy_pass</span> http://myapp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置宿主机，修改windows的hosts，添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.75.135 www.szlocal4.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启192.168.75.135的nginx</p>
</li>
<li><p>浏览器访问； 会看到在两个tomcat服务之间来回切换，见下图：（这里为了以示区分，在2台机器上的tomcat版本不一致）。</p>
</li>
</ol>
<h2 id="四-高可用"><a href="#四-高可用" class="headerlink" title="四 高可用"></a>四 高可用</h2><p>如果nginx服务存在异常，上面的负载均衡架构就面临问题，服务不可用。</p>
<p>这个时候就会采用高可用方案了，简单的高可用是一般主从备份机制。</p>
<blockquote>
<p>我们可以使用2台机器，作为主、备服务器，各自运行nginx服务。</p>
<p>需要一个监控程序，来控制传输主、备之间的心跳信息（我是否还活着的信息），如果备份机在一段时间内没有收到主的发送信息，则认为主已经挂了，自己上去挑大梁，接管主服务继续提供负载均衡服务。</p>
<p>当备再次可以从主那里获得信息时，释放主服务，这样原来的主又可以再次提供负载均衡服务了。</p>
</blockquote>
<p>这里有3个角色： 一主、一备、监控程序。其中的监控程序或者软件我们可以采用Keepalived。</p>
<h2 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a>Keepalived</h2><h3 id="Keepalived工作原理"><a href="#Keepalived工作原理" class="headerlink" title="Keepalived工作原理"></a>Keepalived工作原理</h3><blockquote>
<p>Keepalived类似一个工作在layer3,4&amp;7的交换机。</p>
<p>Layer3,4&amp;7工作在IP/TCP协议栈的IP层，TCP层，及应用层,原理分别如下：</p>
<p>Layer3：Keepalived使用Layer3的方式工作式时，Keepalived会定期向服务器群中的服务器发送一个ICMP的数据包（即我们平时用的Ping程序）,如果发现某台服务的IP地址没有激活，Keepalived便报告这台服务器失效，并将它从服务器群中剔除，这种情况的典型例子是某台服务器被 非法关机。Layer3的方式是以服务器的IP地址是否有效作为服务器工作正常与否的标准。</p>
<p>Layer4:如果您理解了Layer3的方式，Layer4就容易了。Layer4主要以TCP端口的状态来决定服务器工作正常与否。如web server的服务端口一般是80，如果Keepalived检测到80端口没有启动，则Keepalived将把这台服务器从服务器群中剔除。</p>
<p>Layer7：Layer7就是工作在具体的应用层了，比Layer3,Layer4要复杂一点，在网络上占用的带宽也要大一些。Keepalived将根据用户的设定检查服务器程序的运行是否正常，如果与用户的设定不相符，则Keepalived将把服务器从服务器群中剔除。</p>
<p>—— 来自搜狗百科</p>
</blockquote>
<h3 id="Keepalived作用"><a href="#Keepalived作用" class="headerlink" title="Keepalived作用"></a>Keepalived作用</h3><p>主要用作真实服务器的健康状态检查以及负载均衡的主机和备机之间故障切换实现。</p>
<p>一般的高可用web架构组件：LVS+keepalived+nginx</p>
<h3 id="Keepalived高可用架构"><a href="#Keepalived高可用架构" class="headerlink" title="Keepalived高可用架构"></a>Keepalived高可用架构</h3><p>Keepalived高可用简单架构概念视图：</p>
<p>当主down机后，会提升备为主，保证服务可用。</p>
<p>当主再次上线时，备会退位，主继续服务。</p>
<h3 id="Keepalived组成"><a href="#Keepalived组成" class="headerlink" title="Keepalived组成"></a>Keepalived组成</h3><p>Keepalived 模块化设计，主要有三个模块，分别是<code>core</code>、<code>check</code>和 <code>vrrp</code>。 </p>
<ul>
<li>core<ul>
<li><strong>keepalived的核心，负责主进程的启动和维护、全局配置文件的加载解析</strong> </li>
</ul>
</li>
<li>check<ul>
<li><strong>负责healthchecker(健康检查)，包括各种健康检查方式，以及对应的配置的解析包括LVS的配置解析；可基于脚本检查对IPVS后端服务器健康状况进行检查。</strong> </li>
</ul>
</li>
<li>vrrp<ul>
<li><strong>VRRPD子进程就是来实现VRRP（虚拟路由冗余协议）协议的</strong></li>
</ul>
</li>
</ul>
<h3 id="安装Keepalived"><a href="#安装Keepalived" class="headerlink" title="安装Keepalived"></a>安装Keepalived</h3><ul>
<li>方式一：可以直接使用yum安装。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>
<ul>
<li>方拾二： 使用源码安装方式。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载</span></span><br><span class="line">wget http://www.keepalived.org/software/keepalived-1.2.23.tar.gz</span><br><span class="line"><span class="comment">#解压</span></span><br><span class="line">tar -zxvf keepalived-1.2.23.tar.gz</span><br><span class="line"><span class="built_in">cd</span> keepalived-1.2.23</span><br><span class="line"><span class="comment">#安装</span></span><br><span class="line">./configure --prefix=/usr/local/keepalived   <span class="comment">#prefix指定安装目录</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi /usr/local/keepalived/etc/keepalived/keepalived.conf</span><br><span class="line">替换为你自身逻辑的配置文件的内容。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi /usr/local/keepalived/etc/sysconfig/keepalived</span><br><span class="line">添加以下内容：</span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">&quot;-D -f /usr/local/keepalived/etc/keepalived/keepalived.conf&quot;</span> <span class="comment">#不使用默认的，自己显示指定keepalived配置文件路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为我们使用非默认路径（/usr/local）安装keepalived，需要设置一些软链接以保证keepalived能正常启动：</span></span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/keepalived/sbin/keepalived  /usr/bin <span class="comment">#将keepalived主程序加入到环境变量</span></span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/keepalived/etc/rc.d/init.d/keepalived  /etc/init.d/ <span class="comment">#keepalived启动脚本，放到/etc/init.d/目录下就可以使用service命令便捷调用</span></span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/keepalived/etc/sysconfig/keepalived  /etc/sysconfig/ <span class="comment">#keepalived启动脚本变量引用文件，默认文件路径是/etc/sysconfig/，也可以不做软链接，直接修改启动脚本中文件路径即可</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动服务</span><br><span class="line">service keepalived start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以检查下服务是否正常（没有消息就是最好的消息）</span></span><br><span class="line">chkconfig keepalived on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看绑定好的虚拟ip（vip）</span></span><br><span class="line">ip addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">使用配置好的虚拟ip，在浏览器访问测试一下即可。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>也可以这样设置，<strong>配置文件</strong>：安装完成之后，可以把配置文件放到目录：  <code>/etc/keepalived</code> </p>
<p>后面则统一修改 <code>/etc/keepalived/keepalived.conf</code> 配置文件即可。</p>
<p>/usr/local/keepalived/etc/keepalived/keepalived.conf</p>
<p>/etc/keepalived/keepalived.conf</p>
<p><strong>启动|停止|重启服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start|stop|restart</span><br></pre></td></tr></table></figure>
<p><strong>检查服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig keepalived on</span><br></pre></td></tr></table></figure>
<p><strong>查看keepalived版本</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keepalived -v</span><br><span class="line">Keepalived v1.2.23 (12/20,2019)</span><br></pre></td></tr></table></figure>
<h3 id="需求-3"><a href="#需求-3" class="headerlink" title="需求"></a>需求</h3><p>使用keepalived结合nginx，搭建一套简单的高可用集群方案。</p>
<p>并且测试主宕机的情况；</p>
<p>演示主上线的情况。</p>
<h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><ul>
<li>选择4台虚拟机：2台做nginx的主、备；2台做tomcat集群。<ul>
<li>为了使nginx命令方便的话，可以将其所在目录添加到：<code>/etc/profile</code> 文件中。</li>
</ul>
</li>
<li>选择192.168.75.132、192.168.75.135安装keepalived和nginx并分别做主、备。</li>
<li>选择192.168.75.130、192.168.75.134安装tomcat做应用集群。</li>
</ul>
<h3 id="实战-3"><a href="#实战-3" class="headerlink" title="实战"></a>实战</h3><ol>
<li><p>在192.168.75.132、192.168.75.135分别安装keepalived并配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载</span></span><br><span class="line"><span class="built_in">mkdir</span> /usr/local/keepalived</span><br><span class="line"><span class="built_in">cd</span> /usr/local/keepalived</span><br><span class="line">wget http://www.keepalived.org/software/keepalived-1.2.23.tar.gz</span><br><span class="line"><span class="comment"># 或者 wget http://www.keepalived.org/software/keepalived-1.2.23.tar.gz --no-check-certificate  跳过证书验证</span></span><br><span class="line"><span class="comment">#解压</span></span><br><span class="line">tar -zxvf keepalived-1.2.23.tar.gz</span><br><span class="line"><span class="comment"># cd 到解压后的目录</span></span><br><span class="line"><span class="built_in">cd</span> keepalived-1.2.23</span><br><span class="line"><span class="comment"># 源码安装三板斧搞起来</span></span><br><span class="line">./configure --prefix=/usr/local/keepalived   <span class="comment">#prefix指定安装目录</span></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>​    在192.168.75.132(作为主)修改配置文件 keepalived.conf：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   <span class="comment"># 发生切换时，需要通知的邮件； 一行一个用户的email地址；这里假定了几个人..</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     zs@163.com</span><br><span class="line">     <span class="built_in">ls</span>@163.com</span><br><span class="line">     ww@163.com</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   notification_email_from admin@163.com    				<span class="comment"># 发件人，谁发的；这里假定了一个管理员邮箱admin@163.com</span></span><br><span class="line">   smtp_server smtp.163.com                                 <span class="comment"># smtp服务器地址，这里示例使用163的公开地址</span></span><br><span class="line">   smtp_connect_timeout 30									<span class="comment"># smtp连接超时时间设置</span></span><br><span class="line">   router_id LVS_DEVEL										<span class="comment"># 运行keepalived的一个路由标志id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># VRRP 配置</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER											<span class="comment"># 配置标志，MASTER 为主；BACKUP 为备</span></span><br><span class="line">    interface eth0						<span class="comment"># 该keepalived实例绑定的网卡; RHEL7以前可以设置为eth0,7以及之后可以设置为ens33</span></span><br><span class="line">    virtual_router_id 51				<span class="comment">#VRRP组名，两个节点的设置必须一样，以指明各个节点属于同一VRRP组</span></span><br><span class="line">    priority 100											<span class="comment"># 主节点的优先级（1-254之间），备用节点必须比主节点优先级低</span></span><br><span class="line">    advert_int 1											<span class="comment"># 主、备之间检查是否一致的时间间隔：单位秒</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment"># 认证配置   设置验证信息，主、备节点必须一致</span></span><br><span class="line">	authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;					<span class="comment"># 指定虚拟IP, 主、备节点设置必须一样</span></span><br><span class="line">		<span class="comment"># 可以设置多个虚拟ip，换行即可；随便写；这个地址是虚拟的，并不需要实体机器</span></span><br><span class="line">		<span class="comment"># 会将该vip绑定到当前机器的网卡eth0上（因为vrrp_instance的interface指定了eth0）</span></span><br><span class="line">        192.168.75.88					</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在192.168.75.135（作为备）修改配置文件 keepalived.conf：</p>
<ul>
<li>vrrp_instance 下面的state改为了 <strong>BACKUP</strong>。</li>
<li><p>vrrp_instance  下面的额priority改为了<strong>90</strong> ，比主的100低即可。</p>
</li>
<li><p>其他的配置项一样。</p>
</li>
</ul>
<ol>
<li>启动keepalived服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用 <code>ip  addr</code> 命令查看vip是否已经绑定</li>
</ul>
<ol>
<li><p><strong>测试正常情况</strong></p>
<p>在Master和Backup上分别启动keepalived。此时VIP(192.168.75.88)是可访问的，也可以ping通，通过虚拟ip（192.168.75.88）访问，可以看到一直访问的是主（192.168.75.132）：</p>
</li>
<li><p><strong>测试Master宕掉的情况</strong></p>
</li>
</ol>
<p><strong>现在把主（192.168.75.132）的keepalived关掉</strong>，在浏览器上再次访问192.168.75.88，会发现此时访问的是备（192.168.75.135）了：</p>
<ol>
<li><p>测试Master宕掉又恢复的情况</p>
<p>重新把192.168.75.132的keepalived启动后，会看到浏览器输入192.168.75.88访问的一直是192.168.75.132（主）。</p>
</li>
</ol>
<p><strong>综上所述，当前的架构方案，在keepalived出现问题时，是可以及时更换主备的。</strong></p>
<h2 id="原始高可用方案存在的问题"><a href="#原始高可用方案存在的问题" class="headerlink" title="原始高可用方案存在的问题"></a>原始高可用方案存在的问题</h2><p>我们把主的nginx服务关闭，再访问192.168.75.88，发现服务访问失败，因为此时一直访问的是主192.168.75.132的nginx。但是<a target="_blank" rel="noopener" href="http://192.168.75.132:8080/服务其实是可用的。">http://192.168.75.132:8080/服务其实是可用的。</a></p>
<p>这不是我们想要的结果，因为此时备（192.168.75.135）的nginx服务是OK的。能不能在主的nginx挂掉后，自动地切换到备的nginx服务呢？</p>
<p>毋庸置疑，肯定是可以的，我们还需要更多的配置。</p>
<p><strong>截至目前，该方案不能保证主nginx挂掉后服务仍可用。所以，还需要继续提高高可用性。</strong></p>
<p>我们需要在<code>keepalived.conf</code>中增加对nginx服务的检测，根据nginx服务的状态做出一些处理。</p>
<h3 id="vrrp-script节点"><a href="#vrrp-script节点" class="headerlink" title="vrrp_script节点"></a>vrrp_script节点</h3><p>​        此模块专门用于对集群中服务资源进行监控 。与此模块同时使用的还有 track_script 模块，在此模块中可以引入监控脚本、命令组合、shell 语句等 ，以实现对服务、端口等多方面的监控。</p>
<p>​        track_script 模块主要用来调用 vrrp_script 模块使 keepalived执行对集群服务资源的检测。</p>
<p>​        vrrp_script 模块中还可以定义对服务资源检测的时间间隔、权重等参数，通过 vrrp_script 和 track_script 组合，可以实现对集群资源的监控并改变优先级，进而实现 keepalived 主备节点切换。</p>
<p>我们可以在<code>keepalived.conf</code>文件中新增一个<code>vrrp_script</code>节点，来指定监控一个shell脚本文件: <code>/etc/keepalived/check_and_start_nginx.sh</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增一个vrrp_script节点，用来监控nginx</span></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_and_start_nginx.sh&quot;   	# 检测nginx服务并尝试重启</span><br><span class="line">    interval 2                    							# 每2s检查一次</span><br><span class="line">    weight -5                     							# 检测失败（脚本返回非0）则优先级减少5个值</span><br><span class="line">    fall 3                        							# 如果连续失败次数达到此值，则认为服务器已down</span><br><span class="line">    rise 2                        							# 如果连续成功次数达到此值，则认为服务器已up，但不修改优先级</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还需要在虚拟节点中增加<code>track_script</code>子节点引用<code>vrrp_script</code>节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VRRP 配置</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER											# 配置标志，MASTER 为主；BACKUP </span><br><span class="line">    </span><br><span class="line">    # ...... 省略</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">引用VRRP脚本，即在 vrrp_script 中定义的</span></span><br><span class="line">    track_script &#123;                # 引用VRRP脚本</span><br><span class="line">        chk_nginx          </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="shell脚本编写"><a href="#shell脚本编写" class="headerlink" title="shell脚本编写"></a>shell脚本编写</h3><p><code>vi /etc/keepalived/check_and_start_nginx.sh</code> 编写以下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看nginx进程是否正在运行，为0则表示已经down掉</span></span><br><span class="line">nginx_result=$(ps -C nginx --no-heading|wc -l)</span><br><span class="line">if [ &quot;$&#123;nginx_result&#125;&quot; = &quot;0&quot; ]; then</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">使用service的前提需要将nginx设置为servic； 或者直接使用nginx所在绝对路径比如： /usr/local/nginx/sbin/nginx</span></span><br><span class="line">    service nginx start   # 或者使用   /usr/local/nginx/sbin/nginx</span><br><span class="line">    sleep 2</span><br><span class="line">    nginx_result=$(ps -C nginx --no-heading|wc -l)</span><br><span class="line">    if [ &quot;$&#123;nginx_result&#125;&quot; = &quot;0&quot; ]; then</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">如果重启nginx服务还是不行的话，就把keepalived也停止；</span></span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">这样会访问备keepalived，从而保证主的nginx挂掉备也能使用</span></span><br><span class="line">        /etc/rc.d/init.d/keepalived stop</span><br><span class="line">    fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><strong>注意！！！！</strong>：  需要加执行权限：   </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x /etc/keepalived/check_and_start_nginx.sh </span><br></pre></td></tr></table></figure>
<h3 id="主的keepalived-conf"><a href="#主的keepalived-conf" class="headerlink" title="主的keepalived.conf"></a>主的keepalived.conf</h3><p>以下是完整的主的keepalived.conf（/etc/keepalived/keepalived.conf）文件配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">全局配置</span></span><br><span class="line">global_defs &#123;</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">发生切换时，需要通知的邮件； 一行一个用户的email地址；这里假定了几个人..</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     zs@163.com</span><br><span class="line">     ls@163.com</span><br><span class="line">     ww@163.com</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   notification_email_from admin@163.com    				# 发件人，谁发的；这里假定了一个管理员邮箱admin@163.com</span><br><span class="line">   smtp_server smtp.163.com                                 # smtp服务器地址，这里示例使用163的公开地址</span><br><span class="line">   smtp_connect_timeout 30									# smtp连接超时时间设置</span><br><span class="line">   router_id LVS_DEVEL										# 运行keepalived的一个路由标志id</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增一个vrrp_script节点，用来监控nginx</span></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_and_start_nginx.sh&quot;   	# 检测nginx服务并尝试重启</span><br><span class="line">    interval 2                    							# 每2s检查一次</span><br><span class="line">    weight -5                     							# 检测失败（脚本返回非0）则优先级减少5个值</span><br><span class="line">    fall 3                        							# 如果连续失败次数达到此值，则认为服务器已down</span><br><span class="line">    rise 2                        							# 如果连续成功次数达到此值，则认为服务器已up，但不修改优先级</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VRRP 配置</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER											# 配置标志，MASTER 为主；BACKUP 为备</span><br><span class="line">    interface eth0						# 该keepalived实例绑定的网卡; RHEL7以前可以设置为eth0,7以及之后可以设置为ens33</span><br><span class="line">    virtual_router_id 51				#VRRP组名，两个节点的设置必须一样，以指明各个节点属于同一VRRP组</span><br><span class="line">    priority 100											# 主节点的优先级（1-254之间），备用节点必须比主节点优先级低</span><br><span class="line">    advert_int 1											# 主、备之间检查是否一致的时间间隔：单位秒</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">认证配置   设置验证信息，主、备节点必须一致</span></span><br><span class="line">	authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;					# 指定虚拟IP, 主、备节点设置必须一样</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">可以设置多个虚拟ip，换行即可；随便写；这个地址是虚拟的，并不需要实体机器</span></span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">会将该vip绑定到当前机器的网卡eth0上</span></span><br><span class="line">        192.168.75.88					</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">引用VRRP脚本，即在 vrrp_script 中定义的</span></span><br><span class="line">    track_script &#123;                # 引用VRRP脚本</span><br><span class="line">        chk_nginx          </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>启动keepalived：  <code>service keepalived start</code></li>
</ul>
<p>现在主（192.168.75.132）和备（192.168.75.135）的keepalived、nginx都已经启动；</p>
<p>此时 浏览器访问vip ： <a target="_blank" rel="noopener" href="http://192.168.75.88/，">http://192.168.75.88/，</a> 回请求到主192.168.75.132：</p>
<p>现在将主的keepalived关闭，再访问<a target="_blank" rel="noopener" href="http://192.168.75.88/，会请求到备192.168.75.135。">http://192.168.75.88/，会请求到备192.168.75.135。</a></p>
<p>再将主的keepalived启动，又会访问到主。</p>
<p><strong>注意</strong>：  原来我们将主的nginx关闭，访问 <a target="_blank" rel="noopener" href="http://192.168.75.88/">http://192.168.75.88/</a> 时会一直调用主，导致服务不可用。现在我们在主的keepalived中配置了监控nginx服务，看他是否会尝试重启主的nginx服务并且保证给外界提供访问。</p>
<p>我们在主上关闭nginx服务。稍等一会，访问 <a target="_blank" rel="noopener" href="http://192.168.75.88/">http://192.168.75.88/</a>  ，发现可以访问到主的页面，这样keepalived监控了nginx的状态并将nginx服务启动了，保证了高可用，现在不需要人工干预去启动服务了。</p>
<h1 id="多学一招"><a href="#多学一招" class="headerlink" title="多学一招"></a>多学一招</h1><h2 id="将nginx设置为系统service【掌握】"><a href="#将nginx设置为系统service【掌握】" class="headerlink" title="将nginx设置为系统service【掌握】"></a>将nginx设置为系统service【掌握】</h2><p>源码编译的一个缺陷是没法将安装好的应用设置为系统的service， 即无法使用 service 服务名 start | stop | restart 等命令统一操作。</p>
<p>以nginx为例，需要做一些配置，该配置文件的样本示例： <a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/">https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/</a></p>
<ul>
<li><code>vi /etc/init.d/nginx</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># nginx - this script starts and stops the nginx daemon</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig:   - 85 15</span></span><br><span class="line"><span class="comment"># description:  NGINX is an HTTP(S) server, HTTP(S) reverse \</span></span><br><span class="line"><span class="comment">#               proxy and IMAP/POP3 proxy server</span></span><br><span class="line"><span class="comment"># processname: nginx</span></span><br><span class="line"><span class="comment"># config:      /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># config:      /etc/sysconfig/nginx</span></span><br><span class="line"><span class="comment"># pidfile:     /var/run/nginx.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source function library.</span></span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line"></span><br><span class="line"><span class="comment"># Source networking configuration.</span></span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check that networking is up.</span></span><br><span class="line">[ <span class="string">&quot;<span class="variable">$NETWORKING</span>&quot;</span> = <span class="string">&quot;no&quot;</span> ] &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置nginx命令的位置</span></span><br><span class="line"><span class="comment"># 修改为你的nginx可执行命令的路径如： /usr/local/nginx/sbin/nginx</span></span><br><span class="line">nginx=<span class="string">&quot;/usr/local/nginx/sbin/nginx&quot;</span></span><br><span class="line">prog=$(<span class="built_in">basename</span> <span class="variable">$nginx</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指向你的配置文件路径，如：/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line">NGINX_CONF_FILE=<span class="string">&quot;/usr/local/nginx/conf/nginx.conf&quot;</span></span><br><span class="line"></span><br><span class="line">[ -f /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx</span><br><span class="line"></span><br><span class="line">lockfile=/var/lock/subsys/nginx</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">make_dirs</span></span>() &#123;</span><br><span class="line">   <span class="comment"># make required directories</span></span><br><span class="line">   user=`<span class="variable">$nginx</span> -V 2&gt;&amp;1 | grep <span class="string">&quot;configure arguments:.*--user=&quot;</span> | sed <span class="string">&#x27;s/[^*]*--user=\([^ ]*\).*/\1/g&#x27;</span> -`</span><br><span class="line">   <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$user</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [ -z <span class="string">&quot;`grep <span class="variable">$user</span> /etc/passwd`&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">         useradd -M -s /bin/nologin <span class="variable">$user</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      options=`<span class="variable">$nginx</span> -V 2&gt;&amp;1 | grep <span class="string">&#x27;configure arguments:&#x27;</span>`</span><br><span class="line">      <span class="keyword">for</span> opt <span class="keyword">in</span> <span class="variable">$options</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="keyword">if</span> [ `<span class="built_in">echo</span> <span class="variable">$opt</span> | grep <span class="string">&#x27;.*-temp-path&#x27;</span>` ]; <span class="keyword">then</span></span><br><span class="line">              value=`<span class="built_in">echo</span> <span class="variable">$opt</span> | <span class="built_in">cut</span> -d <span class="string">&quot;=&quot;</span> -f 2`</span><br><span class="line">              <span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$value</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">                  <span class="comment"># echo &quot;creating&quot; $value</span></span><br><span class="line">                  <span class="built_in">mkdir</span> -p <span class="variable">$value</span> &amp;&amp; <span class="built_in">chown</span> -R <span class="variable">$user</span> <span class="variable">$value</span></span><br><span class="line">              <span class="keyword">fi</span></span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">       <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    [ -x <span class="variable">$nginx</span> ] || <span class="built_in">exit</span> 5</span><br><span class="line">    [ -f <span class="variable">$NGINX_CONF_FILE</span> ] || <span class="built_in">exit</span> 6</span><br><span class="line">    make_dirs</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">&quot;Starting <span class="variable">$prog</span>: &quot;</span></span><br><span class="line">    daemon <span class="variable">$nginx</span> -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; <span class="built_in">touch</span> <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">&quot;Stopping <span class="variable">$prog</span>: &quot;</span></span><br><span class="line">    killproc <span class="variable">$prog</span> -QUIT</span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; <span class="built_in">rm</span> -f <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">    configtest || <span class="built_in">return</span> $?</span><br><span class="line">    stop</span><br><span class="line">    <span class="built_in">sleep</span> 1</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">reload</span></span>() &#123;</span><br><span class="line">    configtest || <span class="built_in">return</span> $?</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">&quot;Reloading <span class="variable">$prog</span>: &quot;</span></span><br><span class="line">    killproc <span class="variable">$prog</span> -HUP</span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">force_reload</span></span>() &#123;</span><br><span class="line">    restart</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">configtest</span></span>() &#123;</span><br><span class="line">  <span class="variable">$nginx</span> -t -c <span class="variable">$NGINX_CONF_FILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</span><br><span class="line">    status <span class="variable">$prog</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rh_status_q</span></span>() &#123;</span><br><span class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        rh_status_q &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    restart|configtest)</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 7</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    force-reload)</span><br><span class="line">        force_reload</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        rh_status</span><br><span class="line">        ;;</span><br><span class="line">    condrestart|try-restart)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 0</span><br><span class="line">            ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">&quot;Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest&#125;&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>添加可执行权限： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> a+x /etc/init.d/nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>将一个新服务添加到启动列表中(关于chkconfig 命令更多详情，可以参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1577072100&amp;ver=2051&amp;signature=y-131MCP3pZ*oQ6x7ylxbr-*Z1WND5itrTbxzh7eXzoCfrhsHc7X7dUqPjjaP91Nv4YJYxTuWmqcr9yZrRLyoSgQtIl1CXDCGlHiM9tC4S4LvdPCn-sfQq5ZOYpa6DQx&amp;new=1">这里</a> )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add /etc/init.d/nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig nginx on</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>OK。 就可以使用：  <code>service nginx start</code> 之类的命令了。</p>
<h1 id="负载均衡实现实践"><a href="#负载均衡实现实践" class="headerlink" title="负载均衡实现实践"></a>负载均衡实现实践</h1><h2 id="负载均衡技术"><a href="#负载均衡技术" class="headerlink" title="负载均衡技术"></a>负载均衡技术</h2><p>负载均衡实现多种，硬件到软件，商业的、开源的。常见的负载均衡方式：</p>
<h3 id="HTTP重定向负载均衡（较差）"><a href="#HTTP重定向负载均衡（较差）" class="headerlink" title="HTTP重定向负载均衡（较差）"></a>HTTP重定向负载均衡（较差）</h3><p>需要<strong>HTTP重定向服务器</strong>。</p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><ul>
<li>浏览器先去HTTP重定向服务器请求，获取到实际被定向到的服务器；浏览器再请求被实际定向到的服务器。</li>
</ul>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><p>简单易实现。</p>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>浏览器需要两次请求才能完成一次完整的访问，性能以及体验太差。</li>
<li>依赖于<strong>重定向服务器</strong>自身处理能力，集群伸缩性规模有限。</li>
<li>使用HTTP 302进行重定向可能使搜索引擎判断为SEO作弊，降低搜索排名。</li>
</ul>
<h3 id="DNS域名解析负载均衡（一般）"><a href="#DNS域名解析负载均衡（一般）" class="headerlink" title="DNS域名解析负载均衡（一般）"></a>DNS域名解析负载均衡（一般）</h3><p>需要<strong>DNS服务器</strong>。</p>
<h4 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h4><ul>
<li>浏览器请求某个域名，DNS服务器返回web服务器集群中的某个ip地址。</li>
<li>浏览器再去请求DNS返回的服务器地址。</li>
</ul>
<h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h4><p>该方案要要求在DNS服务器中配置多个A记录，例如：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">www.example.com IN A</th>
<th style="text-align:left">10.192.168.66</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">www.example.com IN A</td>
<td style="text-align:left">10.192.168.77</td>
</tr>
<tr>
<td style="text-align:left">www.example.com IN A</td>
<td style="text-align:left">10.192.168.88</td>
</tr>
</tbody>
</table>
</div>
<p>该方案将负载均衡的工作交给了DNS，节省了网站管理维护负载均衡服务器的麻烦。</p>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>目前的DNS是<strong>多级解析</strong>的，每一级别都可能缓存了A记录，当某台业务服务器下线后，即使修改了DNS的A记录，要使其生效还需要一定时间。这期间，可能导致用户会访问已下线的服务器造成访问失败。</li>
<li>DNS负载均衡的控制权在域名服务商那里，网站无法对其做出更多的改善和管理。</li>
</ul>
<blockquote>
<p><strong>温馨提示</strong></p>
<p>事实上，可能是部分使用DNS域名解析，利用域名解析作为第一级的负载均衡手段，域名解析得到的是同样提供负载均衡的内部服务器，这组服务器再进行负载均衡，请求分发到真是的web应用服务器。</p>
</blockquote>
<h3 id="反向代理负载均衡（良）"><a href="#反向代理负载均衡（良）" class="headerlink" title="反向代理负载均衡（良）"></a>反向代理负载均衡（良）</h3><p>反向代理服务器需要配置双网卡和内外部两套IP地址。即<strong>反向代理服务器需要有外部IP、内部IP</strong>。</p>
<h4 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h4><p>部署简单，负载均衡功能和反向代理服务器功能集成在一块。</p>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><p>反向代理服务器是所有请求和相应的中转站，性能可能成为瓶颈。</p>
<h3 id="IP负载均衡（良）"><a href="#IP负载均衡（良）" class="headerlink" title="IP负载均衡（良）"></a>IP负载均衡（良）</h3><h4 id="特点-3"><a href="#特点-3" class="headerlink" title="特点"></a>特点</h4><p>优点是在<strong>内核进程</strong>中完成了数据分发，而反向代理负载均衡是在应用程序中分发数据，IP负载均衡处理性能更优。</p>
<h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><p>所有请求、响应都经由负载均衡服务器，导致<strong>集群最大响应数据吞吐量不得不受制于负载均衡服务器网卡带宽</strong>。</p>
<h3 id="数据链路层负载均衡（优）"><a href="#数据链路层负载均衡（优）" class="headerlink" title="数据链路层负载均衡（优）"></a>数据链路层负载均衡（优）</h3><h4 id="特点-4"><a href="#特点-4" class="headerlink" title="特点"></a>特点</h4><ul>
<li>数据链路层负载均衡也叫<strong>三角传输模式</strong>。</li>
<li>负载均衡数据分发过程中<strong>不修改IP地址，而是修改MAC地址</strong>。</li>
<li>由于实际处理请求的真实物理IP地址和数据请求目的IP地址一致，所以不需要通过负载均衡服务器进行地址转换，可以将响应数据包直接返回给用户浏览器，<strong>避免负载均衡服务器网卡宽带成为瓶颈</strong>。</li>
</ul>
<p>这种负载均衡方式也叫作<strong>直接路由方式（DR）</strong>。</p>
<blockquote>
<p>使用三角传输模式的链路层负载均衡是目前大型网站使用最广泛的一种负载均衡手段。</p>
<p>在Linux平台上最好的链路层负载均衡开源产品是LVS（Linux Virutal Server）。</p>
</blockquote>
<h2 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h2><p>如何从web服务器列表中计算得到一台目标web服务器地址，就是负载均衡算法。</p>
<h3 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h3><p>表示一个web服务器ip、权重的字典映射。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String,Integer&gt; serverMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,Integer&gt;()&#123;&#123;</span><br><span class="line">    put(<span class="string">&quot;192.168.1.100&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.101&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.102&quot;</span>,<span class="number">4</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.103&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.104&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.105&quot;</span>,<span class="number">3</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.106&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.107&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.108&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.109&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    put(<span class="string">&quot;192.168.1.110&quot;</span>,<span class="number">1</span>);</span><br><span class="line">&#125;&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h3><p>这是最简单的调度算法，调度器将收到的请求循环分配到服务器集群中的每台机器，这种算法平等地对待每一台服务器，而不管服务器上实际的负载状况和连接状态，适合所有服务器有相同或者相近性能的情况.</p>
<p>轮询记录一个字段，记录下一次的字典位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">roundRobin</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;String&gt; keyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(serverMap.keySet());</span><br><span class="line">    <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (pos)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pos &gt; keyList.size())&#123;</span><br><span class="line">            pos = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        server = keyList.get(pos);</span><br><span class="line">        pos++;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(server);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="加权轮询"><a href="#加权轮询" class="headerlink" title="加权轮询"></a>加权轮询</h3><p>加权轮询，旨在轮询的基础上，增加权重的影响。<br>用一个列表获取web服务器的字典映射，权重大的在列表中出现的次数就多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">weightRoundRobin</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 所有的服务器字典集合</span></span><br><span class="line">    Set&lt;String&gt; keySet = serverMap.keySet();</span><br><span class="line">    <span class="comment">// 权重影响的可选列表(权重大的出现的次数较多)</span></span><br><span class="line">    List&lt;String&gt; servers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Iterator&lt;String&gt; it = keySet.iterator();it.hasNext();)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> it.next();</span><br><span class="line">        <span class="type">int</span> <span class="variable">weithgt</span> <span class="operator">=</span> serverMap.get(server);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;weithgt;i++)&#123;</span><br><span class="line">           servers.add(server);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (pos)&#123;</span><br><span class="line">        <span class="comment">// 如果位置大于服务器个数，则选择第一个服务器</span></span><br><span class="line">        <span class="keyword">if</span>(pos &gt; keySet.size())&#123;</span><br><span class="line">            pos = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 其他则每一次选择，都自增位置，从【权重影响的可选列表】中获取索引位置上的服务器</span></span><br><span class="line">        server = servers.get(pos);</span><br><span class="line">        pos++;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(server);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="随机"><a href="#随机" class="headerlink" title="随机"></a>随机</h3><p>维护一个服务列表，随机调取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">random</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;String&gt; keyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(serverMap.keySet());</span><br><span class="line">    <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> random.nextInt(keyList.size());</span><br><span class="line">    <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> keyList.get(idx);</span><br><span class="line">    System.out.println(server);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="权重随机"><a href="#权重随机" class="headerlink" title="权重随机"></a>权重随机</h3><p>维护一个列表, 但是会读取web服务器的权重，权重大的出现次数较多，再随机调取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">weightRandom</span><span class="params">()</span>&#123;</span><br><span class="line">    Set&lt;String&gt; keySet = serverMap.keySet();</span><br><span class="line">    List&lt;String&gt; servers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Iterator&lt;String&gt; it = keySet.iterator();it.hasNext();)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> it.next();</span><br><span class="line">        <span class="type">int</span> <span class="variable">weithgt</span> <span class="operator">=</span> serverMap.get(server);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;weithgt;i++)&#123;</span><br><span class="line">            servers.add(server);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> random.nextInt(servers.size());</span><br><span class="line">    server = servers.get(idx);</span><br><span class="line">    System.out.println(server);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="最少连接"><a href="#最少连接" class="headerlink" title="最少连接"></a>最少连接</h3><p>选择与当前连接数最少的服务器通信。</p>
<h4 id="加权最少链接"><a href="#加权最少链接" class="headerlink" title="加权最少链接"></a>加权最少链接</h4><p>为最少连接算法中的每台服务器附加权重的算法，该算法事先为每台服务器分配处理连接的数量，并将客户端请求转至连接数最少的服务器上。</p>
<h3 id="散列（哈希）"><a href="#散列（哈希）" class="headerlink" title="散列（哈希）"></a>散列（哈希）</h3><h4 id="普通哈希"><a href="#普通哈希" class="headerlink" title="普通哈希"></a>普通哈希</h4><p>可以将请求源地址的ip；将其哈希值与web服务器字典集合映射做取模运算，获取合适的web服务器发送请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hash</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;String&gt; keyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(serverMap.keySet());</span><br><span class="line">    <span class="comment">// 可能是源地址-请求地址的ip；将其哈希值与web服务器字典集合映射做取模运算，获取合适的web服务器发送请求。</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">remoteIp</span> <span class="operator">=</span> <span class="string">&quot;192.168.2.215&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> remoteIp.hashCode();</span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> hashCode % keyList.size();</span><br><span class="line">    <span class="type">String</span> <span class="variable">server</span> <span class="operator">=</span> keyList.get(Math.abs(idx));</span><br><span class="line">    System.out.println(server);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h4><ul>
<li>一致性Hash，相同参数的请求总是发到同一提供者。当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。<br>实现可以参考dubbo的一致性哈希算法： <a target="_blank" rel="noopener" href="https://github.com/apache/dubbo/blob/master/dubbo-cluster/src/main/java/org/apache/dubbo/rpc/cluster/loadbalance/ConsistentHashLoadBalance.java"><code>org.apache.dubbo.rpc.cluster.loadbalance.ConsistentHashLoadBalance</code></a></li>
</ul>
<h2 id="参考干货资料"><a href="#参考干货资料" class="headerlink" title="参考干货资料"></a>参考干货资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000004492447">SegmentFault负载均衡算法实现详细介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/information/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95">云栖社区-负载均衡调度算法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edisonchou/p/3851333.html">淘宝大牛分享经验</a></li>
<li><p><a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/balanced-algorithm.html">菜鸟教程-负载均衡算法大全</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liwei0526vip/p/6370103.html">LVS实战</a></p>
</li>
</ul>
<h1 id="Nginx配置文件nginx-conf详细介绍"><a href="#Nginx配置文件nginx-conf详细介绍" class="headerlink" title="Nginx配置文件nginx.conf详细介绍"></a>Nginx配置文件nginx.conf详细介绍</h1><h3 id="Nginx配置文件nginx-conf全解"><a href="#Nginx配置文件nginx-conf全解" class="headerlink" title="Nginx配置文件nginx.conf全解"></a>Nginx配置文件nginx.conf全解</h3><p>nginx配置文件nginx.conf的配置http、upstream、server、location等；</p>
<p>nginx负载均衡算法：轮询、加权轮询、ip_hash、url_hash等策略配置；</p>
<p>nginx日志文件access_log配置；</p>
<p>代理服务缓存proxy_buffer设置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">user  nobody;   <span class="comment"># 用户  用户组  ；一般只有类unix系统有，windows不需要</span></span></span><br><span class="line">worker_processes  1;   # 工作进程，一般配置为cpu核心数的2倍</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 错误日志的配置路径</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">error_log  logs/error.log;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">error_log  logs/error.log  info;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进程<span class="built_in">id</span>存放路径</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定进程可以打开的最大描述符的数量</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">整个系统的最大文件描述符打开数目可以通过命令 <span class="built_in">ulimit</span> -n  查看</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所以一般而言，这个值可以是 <span class="built_in">ulimit</span> -n 除以nginx进程数</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> worker_rlimit_nofile 65535;</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    # 使用epoll的I/O 模型；epoll 使用于Linux内核2.6版本及以后的系统</span><br><span class="line">    use epoll;</span><br><span class="line">    # 每一个工作进程的最大连接数量； 理论上而言每一台nginx服务器的最大连接数为： worker_processes*worker_connections</span><br><span class="line">    worker_connections  1024;</span><br><span class="line"></span><br><span class="line">    # 超时时间</span><br><span class="line">    #keepalive_timeout 60</span><br><span class="line"></span><br><span class="line">    # 客户端请求头部的缓冲区大小，客户端请求一般会小于一页； 可以根据你的系统的分页大小来设定， 命令 getconf PAGESIZE 可以获得当前系统的分页大小（一般4K）</span><br><span class="line">    #client_header_buffer_size 4k;</span><br><span class="line"></span><br><span class="line">    # 为打开的文件指定缓存，默认是不启用； max指定缓存数量，建议和打开文件数一致；inactive是指经过这个时间后还没有被请求过则清除该文件的缓存。</span><br><span class="line">    #open_file_cache max=65535 inactive=60s;</span><br><span class="line"></span><br><span class="line">    # 多久会检查一次缓存的有效信息</span><br><span class="line">    #open_file_cache_valid 80s;</span><br><span class="line"></span><br><span class="line">    # 如果在指定的参数open_file_cache的属性inactive设置的值之内，没有被访问这么多次（open_file_cache_min_uses），则清除缓存</span><br><span class="line">    # 则这里指的是 60s内都没有被访问过一次则清除 的意思</span><br><span class="line">    # open_file_cache_min_uses 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设定http服务；可以利用它的反向代理功能提供负载均衡支持</span></span><br><span class="line">http &#123;</span><br><span class="line">    #设定mime类型,类型由mime.types文件定义；  可以 cat nginx/conf/mime.types  查看下支持哪些类型</span><br><span class="line">    include       mime.types;</span><br><span class="line">    # 默认mime类型；  application/octet-stream 指的是原始二进制流</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # --------------------------------------------------------------------------   #</span><br><span class="line">    # 日志格式设置：</span><br><span class="line">    #   $remote_addr、$http_x_forwarded_for     可以获得客户端ip地址</span><br><span class="line">    #   $remote_user                            可以获得客户端用户名</span><br><span class="line">    #   $time_local                             记录访问的时区以及时间</span><br><span class="line">    #   $request                                请求的url与http协议</span><br><span class="line">    #   $status                                 响应状态成功为200</span><br><span class="line">    #   $body_bytes_sent                        发送给客户端主体内容大小</span><br><span class="line">    #   $http_referer                           记录从哪个页面过来的请求</span><br><span class="line">    #   $http_user_agent                        客户端浏览器信息</span><br><span class="line">    #</span><br><span class="line">    #   注意事项：</span><br><span class="line">    #           通常web服务器(我们的tomcat)放在反向代理(nginx)的后面，这样就不能获取到客户的IP地址了，通过$remote_add拿到的IP地址是反向代理服务器的iP地址。</span><br><span class="line">    #           反向代理服务器(nginx)在转发请求的http头信息中，可以增加$http_x_forwarded_for信息，记录原有客户端的IP地址和原来客户端的请求的服务器地址。</span><br><span class="line">    # --------------------------------------------------------------------------   #</span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    #log_format log404 &#x27;$status [$time_local] $remote_addr $host$request_uri $sent_http_location&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 日志文件；  【注意：】用了log_format则必须指定access_log来指定日志文件</span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line">    #access_log  logs/access.404.log  log404;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 保存服务器名字的hash表由 server_names_hash_bucket_size、server_names_hash_max_size 控制</span><br><span class="line">    # server_names_hash_bucket_size 128;</span><br><span class="line"></span><br><span class="line">    # 限制通过nginx上传文件的大小</span><br><span class="line">    #client_max_body_size 300m;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # sendfile 指定 nginx 是否调用sendfile 函数（零拷贝 方式）来输出文件；</span><br><span class="line">    # 对于一般常见应用，必须设为on。</span><br><span class="line">    # 如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络IO处理速度，降低系统uptime。</span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    # 此选项允许或禁止使用socke的TCP_CORK的选项，此选项仅在使用sendfile的时候使用；TCP_CORK TCP_NODELAY 选项可以是否打开TCP的内格尔算法</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #tcp_nodelay on;</span><br><span class="line"></span><br><span class="line">    # 后端服务器连接的超时时间_发起握手等候响应超时时间</span><br><span class="line">    #proxy_connect_timeout 90; </span><br><span class="line"></span><br><span class="line">    # 连接成功后_等候后端服务器响应时间_其实已经进入后端的排队之中等候处理（也可以说是后端服务器处理请求的时间）</span><br><span class="line">    #proxy_read_timeout 180;</span><br><span class="line"></span><br><span class="line">    # 后端服务器数据回传时间_就是在规定时间之内后端服务器必须传完所有的数据</span><br><span class="line">    #proxy_send_timeout 180;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # proxy_buffering 这个参数用来控制是否打开后端响应内容的缓冲区，如果这个设置为on，以下的proxy_buffers才生效</span><br><span class="line">    #proxy_buffering on</span><br><span class="line"></span><br><span class="line">    # 设置从被代理服务器读取的第一部分应答的缓冲区大小，通常情况下这部分应答中包含一个小的应答头，</span><br><span class="line">    # 默认情况下这个值的大小为指令proxy_buffers中指定的一个缓冲区的大小，不过可以将其设置为更小</span><br><span class="line">    #proxy_buffer_size 256k;</span><br><span class="line"></span><br><span class="line">    # 设置用于读取应答（来自被代理服务器--如tomcat）的缓冲区数目和大小，默认情况也为分页大小，根据操作系统的不同可能是4k或者8k</span><br><span class="line">    #proxy_buffers 4 256k;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 同一时间处理的请求buffer大小；也可以说是一个最大的限制值--控制同时传输到客户端的buffer大小的。</span><br><span class="line">    #proxy_busy_buffers_size 256k;</span><br><span class="line"></span><br><span class="line">    # 设置在写入proxy_temp_path时数据的大小，预防一个工作进程在传递文件时阻塞太长</span><br><span class="line">    #proxy_temp_file_write_size 256k;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # proxy_temp_path和proxy_cache_path指定的路径必须在同一分区</span><br><span class="line">    #proxy_temp_path /app/tmp/proxy_temp_dir;</span><br><span class="line"></span><br><span class="line">    # 设置内存缓存空间大小为200MB，1天没有被访问的内容自动清除，硬盘缓存空间大小为10GB。</span><br><span class="line">    #proxy_cache_path /app/tmp/proxy_cache_dir levels=1:2 keys_zone=cache_one:200m inactive=1d max_size=30g;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 如果把它设置为比较大的数值，例如256k，那么，无论使用firefox还是IE浏览器，来提交任意小于256k的图片，都很正常。</span><br><span class="line">    # 如果注释该指令，使用默认的client_body_buffer_size设置，也就是操作系统页面大小的两倍，8k或者16k，问题就出现了。</span><br><span class="line">    # 无论使用firefox4.0还是IE8.0，提交一个比较大，200k左右的图片，都返回500 Internal Server Error错误</span><br><span class="line">    #client_body_buffer_size 512k;   # 默认是页大小的两倍</span><br><span class="line"></span><br><span class="line">    # 表示使nginx阻止HTTP应答代码为400或者更高的应答。可以结合error_page指向特定的错误页面展示错误信息</span><br><span class="line">    #proxy_intercept_errors on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 负载均衡 START&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">    # upstream 指令定义的节点可以被proxy_pass指令引用；二者结合用来反向代理+负载均衡配置</span><br><span class="line">    # 【内置策略】：轮询、加权轮询、ip_hash、最少连接 默认编译进了nginx</span><br><span class="line">    # 【扩展策略】：fair、通用hash、一致性hash 默认没有编译进nginx</span><br><span class="line">    #-----------------------------------------------------------------------------------------------#</span><br><span class="line">    # 【1】默认是轮询；如果后端服务器down掉，能自动剔除。</span><br><span class="line">    #   upstream bakend &#123;</span><br><span class="line">    #        server 192.168.75.130:8080;</span><br><span class="line">    #        server 192.168.75.132:8080;</span><br><span class="line">    #        server 192.168.75.134:8080;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #【2】权重轮询(加权轮询)：这样配置后，如果总共请求了3次，则前面两次请求到130，后面一次请求到132</span><br><span class="line">    #   upstream bakend &#123;</span><br><span class="line">    #        server 192.168.75.130:8080 weight=2;</span><br><span class="line">    #        server 192.168.75.132:8080 weight=1;</span><br><span class="line">    #   &#125;</span><br><span class="line">    #</span><br><span class="line">    #【3】ip_hash：这种配置会使得每个请求按访问者的ip的hash结果分配，这样每个访客固定访问一个后端服务器，这样也可以解决session的问题。</span><br><span class="line">    #   upstream bakend &#123;</span><br><span class="line">    #        ip_hash;</span><br><span class="line">    #        server 192.168.75.130:8080;</span><br><span class="line">    #        server 192.168.75.132:8080;</span><br><span class="line">    #   &#125;</span><br><span class="line">    #</span><br><span class="line">    #【4】最少连接：将请求分配给连接数最少的服务器。Nginx会统计哪些服务器的连接数最少。</span><br><span class="line">    #   upstream bakend &#123;</span><br><span class="line">    #        least_conn;</span><br><span class="line">    #        server 192.168.75.130:8080;</span><br><span class="line">    #        server 192.168.75.132:8080;</span><br><span class="line">    #   &#125;</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #【5】fair策略(需要安装nginx的第三方模块fair)：按后端服务器的响应时间来分配请求，响应时间短的优先分配。</span><br><span class="line">    #   upstream bakend &#123;</span><br><span class="line">    #        fair;</span><br><span class="line">    #        server 192.168.75.130:8080;</span><br><span class="line">    #        server 192.168.75.132:8080;</span><br><span class="line">    #   &#125;</span><br><span class="line">    #</span><br><span class="line">    #【6】url_hash策略（也是第三方策略）：按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。</span><br><span class="line">    #               在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method指定hash算法</span><br><span class="line">    #   upstream bakend &#123;</span><br><span class="line">    #        server 192.168.75.130:8080;</span><br><span class="line">    #        server 192.168.75.132:8080;</span><br><span class="line">    #        hash $request_uri;</span><br><span class="line">    #        hash_method crc32;</span><br><span class="line">    #   &#125;</span><br><span class="line">    #</span><br><span class="line">    #【7】其他设置，主要是设备的状态设置</span><br><span class="line">    #   upstream bakend&#123;</span><br><span class="line">    #       ip_hash;</span><br><span class="line">    #       server 127.0.0.1:9090 down;   # down 表示该机器处于下线状态不可用</span><br><span class="line">    #       server 127.0.0.1:8080 weight=2;</span><br><span class="line">    #       server 127.0.0.1:6060;</span><br><span class="line">    #       </span><br><span class="line">    #       # max_fails 默认为1； 最大请求失败的次数，结合fail_timeout使用；</span><br><span class="line">    #       # 以下配置表示 192.168.0.100:8080在处理请求失败3次后，将在15s内不会受到任何请求了</span><br><span class="line">    #       # fail_timeout 默认为10秒。某台Server达到max_fails次失败请求后，在fail_timeout期间内，nginx会认为这台Server暂时不可用，不会将请求分配给它。</span><br><span class="line">    #       server 192.168.0.100:8080 weight=2 max_fails=3 fail_timeout=15;</span><br><span class="line">    #       server 192.168.0.101:8080 weight=3;</span><br><span class="line">    #       server 192.168.0.102:8080 weight=1;</span><br><span class="line">    #       # 限制分配给某台Server处理的最大连接数量，超过这个数量，将不会分配新的连接给它。默认为0，表示不限制。注意：1.5.9之后的版本才有这个配置</span><br><span class="line">    #       server 192.168.0.103:8080 max_conns=1000;</span><br><span class="line">    #       server 127.0.0.1:7070 backup;  # 备份机；其他机器都不可用时，这台机器就上场了</span><br><span class="line">    #       server example.com my_dns_resolve;  # 指定域名解析器；my_dns_resolve需要在http节点配置resolver节点如：resolver 10.0.0.1;</span><br><span class="line">    #   &#125;</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #负载均衡 END&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">    #-----------------------------------------------------------------------------------------------#</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ###配置虚拟机START&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">    #</span><br><span class="line">    #server&#123;</span><br><span class="line">    #    listen 80;</span><br><span class="line">    #    配置监听端口</span><br><span class="line">    #    server_name image.***.com;</span><br><span class="line">    #    配置访问域名</span><br><span class="line">    #    location ~* \.(mp3|exe)$ &#123;</span><br><span class="line">    #        对以“mp3或exe”结尾的地址进行负载均衡</span><br><span class="line">    #        proxy_pass http://img_relay$request_uri;</span><br><span class="line">    #        设置被代理服务器的端口或套接字，以及URL</span><br><span class="line">    #        proxy_set_header Host $host;</span><br><span class="line">    #        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #        以上三行，目的是将代理服务器收到的用户的信息传到真实服务器上</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #    location /face &#123;</span><br><span class="line">    #        if ($http_user_agent ~* &quot;xnp&quot;) &#123;</span><br><span class="line">    #            rewrite ^(.*)$ http://211.151.188.190:8080/face.jpg redirect;</span><br><span class="line">    #        &#125;</span><br><span class="line">    #        proxy_pass http://img_relay$request_uri;</span><br><span class="line">    #        proxy_set_header Host $host;</span><br><span class="line">    #        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #        error_page 404 502 = @fetch;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    location @fetch &#123;</span><br><span class="line">    #        access_log /data/logs/face.log log404;</span><br><span class="line">    #        rewrite ^(.*)$ http://211.151.188.190:8080/face.jpg redirect;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    location /image &#123;</span><br><span class="line">    #        if ($http_user_agent ~* &quot;xnp&quot;) &#123;</span><br><span class="line">    #            rewrite ^(.*)$ http://211.151.188.190:8080/face.jpg redirect;</span><br><span class="line">    #</span><br><span class="line">    #        &#125;</span><br><span class="line">    #        proxy_pass http://img_relay$request_uri;</span><br><span class="line">    #        proxy_set_header Host $host;</span><br><span class="line">    #        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #        error_page 404 502 = @fetch;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    location @fetch &#123;</span><br><span class="line">    #        access_log /data/logs/image.log log404;</span><br><span class="line">    #        rewrite ^(.*)$ http://211.151.188.190:8080/face.jpg redirect;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    ###其他举例</span><br><span class="line">    #</span><br><span class="line">    #server&#123;</span><br><span class="line">    #</span><br><span class="line">    #    listen 80;</span><br><span class="line">    #</span><br><span class="line">    #    server_name *.***.com *.***.cn;</span><br><span class="line">    #</span><br><span class="line">    #    location ~* \.(mp3|exe)$ &#123;</span><br><span class="line">    #        proxy_pass http://img_relay$request_uri;</span><br><span class="line">    #        proxy_set_header Host $host;</span><br><span class="line">    #        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        if ($http_user_agent ~* &quot;xnp&quot;) &#123;</span><br><span class="line">    #            rewrite ^(.*)$ http://i1.***img.com/help/noimg.gif redirect;</span><br><span class="line">    #        &#125;</span><br><span class="line">    #</span><br><span class="line">    #        proxy_pass http://img_relay$request_uri;</span><br><span class="line">    #        proxy_set_header Host $host;</span><br><span class="line">    #        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #        #error_page 404 http://i1.***img.com/help/noimg.gif;</span><br><span class="line">    #        error_page 404 502 = @fetch;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    location @fetch &#123;</span><br><span class="line">    #        access_log /data/logs/baijiaqi.log log404;</span><br><span class="line">    #        rewrite ^(.*)$ http://i1.***img.com/help/noimg.gif redirect;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    #</span><br><span class="line">    #server&#123;</span><br><span class="line">    #    listen 80;</span><br><span class="line">    #    server_name *.***img.com;</span><br><span class="line">    #</span><br><span class="line">    #    location ~* \.(mp3|exe)$ &#123;</span><br><span class="line">    #        proxy_pass http://img_relay$request_uri;</span><br><span class="line">    #        proxy_set_header Host $host;</span><br><span class="line">    #        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        if ($http_user_agent ~* &quot;xnp&quot;) &#123;</span><br><span class="line">    #            rewrite ^(.*)$ http://i1.***img.com/help/noimg.gif;</span><br><span class="line">    #        &#125;</span><br><span class="line">    #</span><br><span class="line">    #        proxy_pass http://img_relay$request_uri;</span><br><span class="line">    #        proxy_set_header Host $host;</span><br><span class="line">    #        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    #        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #        #error_page 404 http://i1.***img.com/help/noimg.gif;</span><br><span class="line">    #        error_page 404 = @fetch;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    ##access_log off;</span><br><span class="line">    #</span><br><span class="line">    #    location @fetch &#123;</span><br><span class="line">    #        access_log /data/logs/baijiaqi.log log404;</span><br><span class="line">    #        rewrite ^(.*)$ http://i1.***img.com/help/noimg.gif redirect;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    #</span><br><span class="line">    #server&#123;</span><br><span class="line">    #    listen 8080;</span><br><span class="line">    #    server_name ngx-ha.***img.com;</span><br><span class="line">    #</span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        stub_status on;</span><br><span class="line">    #        access_log off;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen 80;</span><br><span class="line">    #    server_name imgsrc1.***.net;</span><br><span class="line">    #    root html;</span><br><span class="line">    #&#125;</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen 80;</span><br><span class="line">    #    server_name ***.com w.***.com;</span><br><span class="line">    #    # access_log /usr/local/nginx/logs/access_log main;</span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        rewrite ^(.*)$ http://www.***.com/ ;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen 80;</span><br><span class="line">    #    server_name *******.com w.*******.com;</span><br><span class="line">    #    # access_log /usr/local/nginx/logs/access_log main;</span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        rewrite ^(.*)$ http://www.*******.com/;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen 80;</span><br><span class="line">    #    server_name ******.com;</span><br><span class="line">    #</span><br><span class="line">    #    # access_log /usr/local/nginx/logs/access_log main;</span><br><span class="line">    #</span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        rewrite ^(.*)$ http://www.******.com/;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    location /NginxStatus &#123;</span><br><span class="line">    #        stub_status on;</span><br><span class="line">    #        access_log on;</span><br><span class="line">    #        auth_basic &quot;NginxStatus&quot;;</span><br><span class="line">    #        auth_basic_user_file conf/htpasswd;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #</span><br><span class="line">    #    #设定查看Nginx状态的地址</span><br><span class="line">    #    location ~ /\.ht &#123;</span><br><span class="line">    #        deny all;</span><br><span class="line">    #    &#125;#禁止访问.htxxx文件</span><br><span class="line">    #</span><br><span class="line">    #&#125;</span><br><span class="line">    #配置虚拟机END&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            #root   html;</span><br><span class="line">            root   /app;</span><br><span class="line">	    index   zyt505050.html;</span><br><span class="line">	    #index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http://127.0.0.1;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">        # concurs with nginx&#x27;s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       8000;</span><br><span class="line">    #    listen       somename:8080;</span><br><span class="line">    #    server_name  somename  alias  another.alias;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # HTTPS server</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       443 ssl;</span><br><span class="line">    #    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #    ssl_certificate      cert.pem;</span><br><span class="line">    #    ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">    #    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    #    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    #    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="出现大量TIME-WAIT的情况"><a href="#出现大量TIME-WAIT的情况" class="headerlink" title="出现大量TIME_WAIT的情况"></a>出现大量TIME_WAIT的情况</h3><p>1）导致 nginx端出现大量TIME_WAIT的情况有两种：</p>
<p>keepalive_requests设置比较小，高并发下超过此值后nginx会强制关闭和客户端保持的keepalive长连接；（主动关闭连接后导致nginx出现TIME_WAIT）<br>keepalive设置的比较小（空闲数太小），导致高并发下nginx会频繁出现连接数震荡（超过该值会关闭连接），不停的关闭、开启和后端server保持的keepalive长连接；<br>2）导致后端server端出现大量TIME_WAIT的情况：<br>nginx没有打开和后端的长连接，即：没有设置proxy_http_version 1.1;和proxy_set_header Connection “”;从而导致后端server每次关闭连接，高并发下就会出现server端出现大量TIME_WAIT</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        location /  &#123;</span><br><span class="line">            proxy_http_version 1.1; // 这两个最好也设置</span><br><span class="line">            proxy_set_header Connection &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="资料链接"><a href="#资料链接" class="headerlink" title="资料链接"></a>资料链接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edisonchou/category/585873.html">大型网站技术架构淘宝大牛</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edisonchou/p/4281978.html">淘宝大牛的博客干货资料</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/youzhibing/p/7327342.html">nginx实现请求的负载均衡 + keepalived实现nginx的高可用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sunsky303/p/10648861.html">nginx优化之keepalive</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/19761434/answer/250280897">Nginx+keepalived搭建—-nginx反向代理为什么这么快</a></li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xyang81/article/details/52554398">Keepalived介绍以及-安装与配置</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b050d8861fc1">Linux高可用之Keepalived-简书</a></p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://ktzxy.github.io">蓝桉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://ktzxy.github.io/posts/5b3c514b.html">https://ktzxy.github.io/posts/5b3c514b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://ktzxy.github.io" target="_blank">蓝桉`Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nginx/">nginx</a></div><div class="post-share"><div class="social-share" data-image="/bg/Image00010.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">不给糖果就捣蛋</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" src="/img/wechat.webp" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src="/img/alipay.webp" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><audio id="coinAudio" src="https://cdn.cbd.int/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin/coin.js"></script><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/72b5a919.html" title="脚本"><img class="cover" src="/bg/Image00017.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">脚本</div></div><div class="info-2"><div class="info-item-1">check_and_start_nginx.sh1234567891011121314151617#!/bin/bash# 查看nginx进程是否正在运行，为0则表示已经down掉nginx_result=$(ps -C nginx --no-heading|wc -l)echo nginx_result &gt; /app/demo/a.txtif [ &quot;$&#123;nginx_result&#125;&quot; = &quot;0&quot; ]; then	# 前提需要将nginx设置为service； 或者直接使用nginx所在绝对路径比如： /usr/local/nginx/sbin/nginx    echo &#x27;哈哈哈哈&#x27; &gt; /app/demo.a.txt	service nginx start    sleep 1    nginx_result=$(ps -C nginx --no-heading|wc -l)    if [ &quot;$&#123;nginx_result&#125;&quot; = &quot;0&...</div></div></div></a><a class="pagination-related" href="/posts/77447fe2.html" title="keepalived配置"><img class="cover" src="/bg/Image00013.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">keepalived配置</div></div><div class="info-2"><div class="info-item-1">keepalived.conf123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354! Configuration File for keepalived# 全局配置global_defs &#123;   # 发生切换时，需要通知的邮件； 一行一个用户的email地址；这里假定了几个人..   notification_email &#123;     zs@163.com     ls@163.com     ww@163.com   &#125;      notification_email_from admin@163.com    				# 发件人，谁发的；这里假定了一个管理员邮箱admin@163.com   smtp_server smtp.163.com                                 # smtp服务器地址，这里示例使用163的公开地址   smtp_connect_timeout 3...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/77447fe2.html" title="keepalived配置"><img class="cover" src="/bg/Image00013.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">keepalived配置</div></div><div class="info-2"><div class="info-item-1">keepalived.conf123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354! Configuration File for keepalived# 全局配置global_defs &#123;   # 发生切换时，需要通知的邮件； 一行一个用户的email地址；这里假定了几个人..   notification_email &#123;     zs@163.com     ls@163.com     ww@163.com   &#125;      notification_email_from admin@163.com    				# 发件人，谁发的；这里假定了一个管理员邮箱admin@163.com   smtp_server smtp.163.com                                 # smtp服务器地址，这里示例使用163的公开地址   smtp_connect_timeout 3...</div></div></div></a><a class="pagination-related" href="/posts/72b5a919.html" title="脚本"><img class="cover" src="/bg/Image00017.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">脚本</div></div><div class="info-2"><div class="info-item-1">check_and_start_nginx.sh1234567891011121314151617#!/bin/bash# 查看nginx进程是否正在运行，为0则表示已经down掉nginx_result=$(ps -C nginx --no-heading|wc -l)echo nginx_result &gt; /app/demo/a.txtif [ &quot;$&#123;nginx_result&#125;&quot; = &quot;0&quot; ]; then	# 前提需要将nginx设置为service； 或者直接使用nginx所在绝对路径比如： /usr/local/nginx/sbin/nginx    echo &#x27;哈哈哈哈&#x27; &gt; /app/demo.a.txt	service nginx start    sleep 1    nginx_result=$(ps -C nginx --no-heading|wc -l)    if [ &quot;$&#123;nginx_result&#125;&quot; = &quot;0&...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">蓝桉</div><div class="author-info-description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">生活、学习、技术</b>相关的问题和看法，还有<b style="color:#fff">文章教程</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">264</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ktzxy"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon faa-parent animated-hover" href="https://github.com/ktzxy" target="_blank" title="Github"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-github"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=2251511764@qq.com" target="_blank" title="Email"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"></use></svg></a><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-RSS"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/496148176" target="_blank" title="BiliBili"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QX-BILIBILI"></use></svg></a><a class="social-icon faa-parent animated-hover" href="tencent://Message/?Uin=2251511764&amp;amp;websiteName=local.edu.com:8888=&amp;amp;Menu=yes" target="_blank" title="QQ"><svg class="social_icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QQ"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E7%AB%AF404%E4%BB%A5%E5%8F%8A502%E7%AD%89%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">Nginx服务端404以及502等页面配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5nginx-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">进入nginx.conf配置文件:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%A1%B5%E9%9D%A2%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">添加页面重定向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http%E5%86%85%E6%B7%BB%E5%8A%A0%E4%B8%80%E8%A1%8C-fastcgi-intercept-errors-on-%E5%BC%80%E5%90%AF%E9%A1%B5%E9%9D%A2%E9%87%8D%E5%AE%9A%E5%90%91%E5%8A%9F%E8%83%BD%E3%80%82"><span class="toc-number">1.0.0.3.</span> <span class="toc-text">http内添加一行 fastcgi_intercept_errors on; 开启页面重定向功能。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#server-%E5%86%85%E6%B7%BB%E5%8A%A0%E9%A1%B5%E9%9D%A2%E6%8C%87%E5%90%91"><span class="toc-number">1.0.0.4.</span> <span class="toc-text">server 内添加页面指向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%87%86%E7%A1%AE"><span class="toc-number">1.0.0.5.</span> <span class="toc-text">检查nginx配置文件是否准确</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%90%AFnginx"><span class="toc-number">1.0.0.6.</span> <span class="toc-text">重启nginx</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%E5%A4%B1%E8%B4%A5"><span class="toc-number">1.0.1.</span> <span class="toc-text">访问服务失败</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#php-fpm%E6%B2%A1%E6%9C%89%E5%AE%89%E8%A3%85"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">php-fpm没有安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%9A%84%E9%A1%B5%E9%9D%A2%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">1.0.2.</span> <span class="toc-text">Nginx的页面乱码解决方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E3%80%81%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">Nginx实现虚拟主机、反向代理、负载均衡、高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">2.1.</span> <span class="toc-text">一 虚拟主机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%9F%9F%E5%90%8D%E7%9A%84%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">基于域名的虚拟主机配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82"><span class="toc-number">2.1.2.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.1.3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">2.1.4.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">二 反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98-1"><span class="toc-number">2.2.3.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.3.</span> <span class="toc-text">三 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-2"><span class="toc-number">2.3.1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-number">2.3.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98-2"><span class="toc-number">2.3.3.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">2.4.</span> <span class="toc-text">四 高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived"><span class="toc-number">2.5.</span> <span class="toc-text">Keepalived</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.5.1.</span> <span class="toc-text">Keepalived工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived%E4%BD%9C%E7%94%A8"><span class="toc-number">2.5.2.</span> <span class="toc-text">Keepalived作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">2.5.3.</span> <span class="toc-text">Keepalived高可用架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived%E7%BB%84%E6%88%90"><span class="toc-number">2.5.4.</span> <span class="toc-text">Keepalived组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Keepalived"><span class="toc-number">2.5.5.</span> <span class="toc-text">安装Keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82-3"><span class="toc-number">2.5.6.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-number">2.5.7.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98-3"><span class="toc-number">2.5.8.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.</span> <span class="toc-text">原始高可用方案存在的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vrrp-script%E8%8A%82%E7%82%B9"><span class="toc-number">2.6.1.</span> <span class="toc-text">vrrp_script节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shell%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99"><span class="toc-number">2.6.2.</span> <span class="toc-text">shell脚本编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%9A%84keepalived-conf"><span class="toc-number">2.6.3.</span> <span class="toc-text">主的keepalived.conf</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E5%AD%A6%E4%B8%80%E6%8B%9B"><span class="toc-number">3.</span> <span class="toc-text">多学一招</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86nginx%E8%AE%BE%E7%BD%AE%E4%B8%BA%E7%B3%BB%E7%BB%9Fservice%E3%80%90%E6%8E%8C%E6%8F%A1%E3%80%91"><span class="toc-number">3.1.</span> <span class="toc-text">将nginx设置为系统service【掌握】</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E7%8E%B0%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.</span> <span class="toc-text">负载均衡实现实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%8A%80%E6%9C%AF"><span class="toc-number">4.1.</span> <span class="toc-text">负载均衡技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E9%87%8D%E5%AE%9A%E5%90%91%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%88%E8%BE%83%E5%B7%AE%EF%BC%89"><span class="toc-number">4.1.1.</span> <span class="toc-text">HTTP重定向负载均衡（较差）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">4.1.1.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-number">4.1.1.3.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%88%E4%B8%80%E8%88%AC%EF%BC%89"><span class="toc-number">4.1.2.</span> <span class="toc-text">DNS域名解析负载均衡（一般）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-1"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-1"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-1"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%88%E8%89%AF%EF%BC%89"><span class="toc-number">4.1.3.</span> <span class="toc-text">反向代理负载均衡（良）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-2"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-2"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%88%E8%89%AF%EF%BC%89"><span class="toc-number">4.1.4.</span> <span class="toc-text">IP负载均衡（良）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-3"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-3"><span class="toc-number">4.1.4.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%88%E4%BC%98%EF%BC%89"><span class="toc-number">4.1.5.</span> <span class="toc-text">数据链路层负载均衡（优）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-4"><span class="toc-number">4.1.5.1.</span> <span class="toc-text">特点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">4.2.</span> <span class="toc-text">负载均衡算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE"><span class="toc-number">4.2.1.</span> <span class="toc-text">准备数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AE%E8%AF%A2"><span class="toc-number">4.2.2.</span> <span class="toc-text">轮询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2"><span class="toc-number">4.2.3.</span> <span class="toc-text">加权轮询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA"><span class="toc-number">4.2.4.</span> <span class="toc-text">随机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%87%8D%E9%9A%8F%E6%9C%BA"><span class="toc-number">4.2.5.</span> <span class="toc-text">权重随机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B0%91%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.2.6.</span> <span class="toc-text">最少连接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E6%9D%83%E6%9C%80%E5%B0%91%E9%93%BE%E6%8E%A5"><span class="toc-number">4.2.6.1.</span> <span class="toc-text">加权最少链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%A3%E5%88%97%EF%BC%88%E5%93%88%E5%B8%8C%EF%BC%89"><span class="toc-number">4.2.7.</span> <span class="toc-text">散列（哈希）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%93%88%E5%B8%8C"><span class="toc-number">4.2.7.1.</span> <span class="toc-text">普通哈希</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C"><span class="toc-number">4.2.7.2.</span> <span class="toc-text">一致性哈希</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%B9%B2%E8%B4%A7%E8%B5%84%E6%96%99"><span class="toc-number">4.3.</span> <span class="toc-text">参考干货资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6nginx-conf%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.</span> <span class="toc-text">Nginx配置文件nginx.conf详细介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6nginx-conf%E5%85%A8%E8%A7%A3"><span class="toc-number">5.0.1.</span> <span class="toc-text">Nginx配置文件nginx.conf全解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E7%8E%B0%E5%A4%A7%E9%87%8FTIME-WAIT%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">5.0.2.</span> <span class="toc-text">出现大量TIME_WAIT的情况</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B5%84%E6%96%99%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">资料链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/a318ca1f.html" title="MySQL数据库150道高频面试题"><img src="/bg/Image00018.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL数据库150道高频面试题"/></a><div class="content"><a class="title" href="/posts/a318ca1f.html" title="MySQL数据库150道高频面试题">MySQL数据库150道高频面试题</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8f9b37aa.html" title="技术同学必会的MySQL设计规约"><img src="/bg/Image00014.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="技术同学必会的MySQL设计规约"/></a><div class="content"><a class="title" href="/posts/8f9b37aa.html" title="技术同学必会的MySQL设计规约">技术同学必会的MySQL设计规约</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/dfdfdf4.html" title="数据库概述"><img src="/bg/Image00002.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据库概述"/></a><div class="content"><a class="title" href="/posts/dfdfdf4.html" title="数据库概述">数据库概述</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/490575ab.html" title="24工厂模式俗话解释"><img src="/bg/Image00024.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="24工厂模式俗话解释"/></a><div class="content"><a class="title" href="/posts/490575ab.html" title="24工厂模式俗话解释">24工厂模式俗话解释</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/364ea8cc.html" title="设计模式"><img src="/bg/Image00014.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式"/></a><div class="content"><a class="title" href="/posts/364ea8cc.html" title="设计模式">设计模式</a><time datetime="2025-07-09T17:28:46.000Z" title="发表于 2025-07-09 17:28:46">2025-07-09</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2020 - 2025 By 蓝桉</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="8152976493" data-server="netease" data-type="playlist"   data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true" ></div><script async src="//at.alicdn.com/t/c/font_4379924_273fk05h86zi.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/cat/cat.js"></script><script async data-pjax src="/js/meting/music_lanan.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script defer src="/js/day/lunar.js"></script><script defer src="/js/day/day.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = '10a7db1c41b6489db9c830c668a18304';
  var gaud_map_key = '82a64bc994fb6494830f157f319f9f69';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.2.2" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="本站使用JsDelivr为静态资源提供CDN加速" title=""><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime/runtime.min.js"></script><script async src="/js/font/ali_font_all.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>